{% extends "base.html" %}

{% block title %}Smart Pick Generator{% endblock %}

{% block page_heading %}Smart Pick Generator with ML Insights{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        .ball {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #6366f1; /* Indigo */
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            margin: 0.25rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        .powerball {
            background-color: #ef4444; /* Red */
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
{% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {# Flash messages display #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages space-y-3 mb-4">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-md text-sm {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif category == 'info' %}bg-blue-100 text-blue-700 border border-blue-200{% else %}bg-green-100 text-green-700 border border-blue-200{% endif %} animate-fade-in">
                        <p class="font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Generate Your Smart Picks</h2>
        
        <form id="smartPickForm" class="space-y-6">
            {# Generation Strategy Selection #}
            <div class="mb-4">
                <label class="block text-xl font-semibold text-gray-800 mb-2">Choose Generation Strategy</label>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="generation_strategy" value="rule_based" class="form-radio text-indigo-600 h-5 w-5" checked>
                        <span class="ml-2 text-gray-700 font-medium">Rule-Based Smart Pick</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="generation_strategy" value="ml_based" class="form-radio text-indigo-600 h-5 w-5">
                        <span class="ml-2 text-gray-700 font-medium">ML-Based Smart Pick (Clustering)</span>
                    </label>
                </div>
            </div>

            {# Common Filters for both strategies #}
            <div>
                <label for="num_sets_to_generate" class="block text-sm font-medium text-gray-700 mb-1">Number of Picks to Generate (1-10)</label>
                <input type="number" id="num_sets_to_generate" name="num_sets_to_generate" min="1" max="10" value="1" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>

            <div>
                <label for="excluded_numbers" class="block text-sm font-medium text-gray-700 mb-1">Exclude Specific Numbers (comma-separated)</label>
                <input type="text" id="excluded_numbers" name="excluded_numbers" placeholder="e.g., 4, 18, 55" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>

            {# Rule-Based Specific Filters (conditionally visible) #}
            <div id="ruleBasedFilters" class="space-y-6 border-t border-gray-200 pt-6 mt-6">
                <p class="text-lg font-semibold text-gray-800">Rule-Based Specific Filters</p>
                <div>
                    <label for="num_from_group_a" class="block text-sm font-medium text-gray-700 mb-1">Numbers from Group-A (0-5)</label>
                    <input type="number" id="num_from_group_a" name="num_from_group_a" min="0" max="5" value="2" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <p class="text-xs text-gray-500 mt-1">Group-A numbers are: {{ group_a | join(', ') }}</p>
                </div>

                <div>
                    <label for="odd_even_choice" class="block text-sm font-medium text-gray-700 mb-1">Odd/Even Split</label>
                    <select id="odd_even_choice" name="odd_even_choice" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="Any">Any Split</option>
                        <option value="All Even">All Even (5E/0O)</option>
                        <option value="All Odd">All Odd (0E/5O)</option>
                        <option value="4 Even / 1 Odd">4 Even / 1 Odd</option>
                        <option value="1 Even / 4 Odd">1 Even / 4 Odd</option>
                        <option value="3 Even / 2 Odd">3 Even / 2 Odd</option>
                        <option value="2 Even / 3 Odd">2 Even / 3 Odd</option>
                    </select>
                </div>

                <div>
                    <label for="sum_range_filter" class="block text-sm font-medium text-gray-700 mb-1">Sum of White Balls Range</label>
                    <select id="sum_range_filter" name="sum_range_filter" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        {% for label, _ in sum_ranges.items() %}
                        <option value="{{ label }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                {# Pattern Prioritization Checkboxes #}
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prioritize Based On:</label>
                    <div class="flex flex-wrap gap-x-4 gap-y-2">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="prioritize_monthly_hot" name="prioritize_monthly_hot" class="form-checkbox text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-sm text-gray-700">Monthly Hot Numbers</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="prioritize_grouped_patterns" name="prioritize_grouped_patterns" class="form-checkbox text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-sm text-gray-700">Grouped Patterns (e.g., 10s, 20s)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="prioritize_special_patterns" name="prioritize_special_patterns" class="form-checkbox text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-sm text-gray-700">Special Patterns (e.g., Tens Apart)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="prioritize_consecutive_patterns" name="prioritize_consecutive_patterns" class="form-checkbox text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-sm text-gray-700">Consecutive Patterns</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label for="force_specific_pattern" class="block text-sm font-medium text-gray-700 mb-1">Force Specific Pattern (2 or 3 numbers, comma-separated)</label>
                    <input type="text" id="force_specific_pattern" name="force_specific_pattern" placeholder="e.g., 1, 2, 3 or 10, 20" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <p class="text-xs text-gray-500 mt-1">If specified, 2 or 3 of these numbers will be included. Must be unique and not excluded.</p>
                </div>
            </div>

            <button type="submit" id="generatePicksBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition ease-in-out duration-150 flex items-center justify-center">
                <span id="buttonText">Generate Smart Picks</span>
                <div id="loadingSpinner" class="loading-spinner ml-3 hidden"></div>
            </button>
        </form>
    </div>

    {# Generated Picks Display #}
    <div id="generatedPicksSection" class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Generated Picks</h2>
        <div id="generatedPicksContainer" class="space-y-6">
            {# Generated picks will be injected here by JavaScript #}
        </div>
        <div class="flex justify-end mt-6 space-x-4">
            <button id="saveAllPicksBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition ease-in-out duration-150">
                Save All Generated Picks
            </button>
        </div>
    </div>

    {# Last Draw Dates Display #}
    <div id="lastDrawDatesSection" class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Last Drawn Dates for Your Numbers</h2>
        <div id="lastDrawDatesContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {# Last drawn dates will be injected here by JavaScript #}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const smartPickForm = document.getElementById('smartPickForm');
        const generatePicksBtn = document.getElementById('generatePicksBtn');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const generatedPicksSection = document.getElementById('generatedPicksSection');
        const generatedPicksContainer = document.getElementById('generatedPicksContainer');
        const lastDrawDatesSection = document.getElementById('lastDrawDatesSection');
        const lastDrawDatesContainer = document.getElementById('lastDrawDatesContainer');
        const saveAllPicksBtn = document.getElementById('saveAllPicksBtn');
        const generationStrategyRadios = document.querySelectorAll('input[name="generation_strategy"]');
        const ruleBasedFilters = document.getElementById('ruleBasedFilters');

        let currentGeneratedSets = []; // Store the current generated sets for saving

        // Function to toggle visibility of rule-based filters
        function toggleRuleBasedFilters() {
            const selectedStrategy = document.querySelector('input[name="generation_strategy"]:checked').value;
            if (selectedStrategy === 'rule_based') {
                ruleBasedFilters.classList.remove('hidden');
            } else {
                ruleBasedFilters.classList.add('hidden');
            }
        }

        // Add event listeners to strategy radios
        generationStrategyRadios.forEach(radio => {
            radio.addEventListener('change', toggleRuleBasedFilters);
        });

        // Initial call to set visibility based on default selected radio
        toggleRuleBasedFilters();


        smartPickForm.addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent default form submission

            buttonText.textContent = 'Generating...';
            loadingSpinner.classList.remove('hidden');
            generatePicksBtn.disabled = true;
            generatedPicksSection.classList.add('hidden');
            lastDrawDatesSection.classList.add('hidden');
            generatedPicksContainer.innerHTML = '';
            lastDrawDatesContainer.innerHTML = '';
            currentGeneratedSets = []; // Clear previous sets

            const numSets = document.getElementById('num_sets_to_generate').value;
            const excludedNumbers = document.getElementById('excluded_numbers').value;
            const selectedStrategy = document.querySelector('input[name="generation_strategy"]:checked').value;

            let apiUrl = '';
            let payload = {
                num_sets: parseInt(numSets),
                excluded_numbers: excludedNumbers
            };

            if (selectedStrategy === 'rule_based') {
                apiUrl = '/generate_smart_picks_route'; // Your existing Flask route for rule-based
                payload.num_from_group_a = document.getElementById('num_from_group_a').value;
                payload.odd_even_choice = document.getElementById('odd_even_choice').value;
                payload.sum_range_filter = document.getElementById('sum_range_filter').value;
                payload.prioritize_monthly_hot = document.getElementById('prioritize_monthly_hot').checked;
                payload.prioritize_grouped_patterns = document.getElementById('prioritize_grouped_patterns').checked;
                payload.prioritize_special_patterns = document.getElementById('prioritize_special_patterns').checked;
                payload.prioritize_consecutive_patterns = document.getElementById('prioritize_consecutive_patterns').checked;
                payload.force_specific_pattern = document.getElementById('force_specific_pattern').value;
            } else if (selectedStrategy === 'ml_based') {
                apiUrl = '/api/generate_ml_smart_picks'; // New ML-based API endpoint
                // ML-based generation doesn't use all the rule-based filters directly
                // but excluded_numbers and num_sets are common.
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    currentGeneratedSets = result.generated_sets;
                    generatedPicksContainer.innerHTML = ''; // Clear existing
                    result.generated_sets.forEach(pick => {
                        const pickDiv = document.createElement('div');
                        pickDiv.className = 'flex flex-wrap items-center justify-center sm:justify-start bg-gray-50 p-4 rounded-lg shadow-sm';
                        const whiteBallsHtml = pick.white_balls.map(ball => `<span class="ball">${ball}</span>`).join('');
                        pickDiv.innerHTML = `
                            <div class="flex items-center mb-2 sm:mb-0 sm:mr-4">
                                ${whiteBallsHtml}
                                <span class="ball powerball">${pick.powerball}</span>
                            </div>
                        `;
                        generatedPicksContainer.appendChild(pickDiv);
                    });
                    generatedPicksSection.classList.remove('hidden');

                    lastDrawDatesContainer.innerHTML = ''; // Clear existing
                    if (result.last_draw_dates && Object.keys(result.last_draw_dates).length > 0) {
                        for (const [number, date] of Object.entries(result.last_draw_dates)) {
                            const dateDiv = document.createElement('div');
                            dateDiv.className = 'bg-gray-50 p-3 rounded-lg text-sm text-gray-700';
                            dateDiv.innerHTML = `<strong>${number}:</strong> ${date}`;
                            lastDrawDatesContainer.appendChild(dateDiv);
                        }
                        lastDrawDatesSection.classList.remove('hidden');
                    } else {
                        lastDrawDatesContainer.innerHTML = '<p class="text-gray-500">No last drawn date info available.</p>';
                        lastDrawDatesSection.classList.remove('hidden');
                    }

                    // Display ML cluster info if available
                    if (selectedStrategy === 'ml_based' && result.ml_cluster_info) {
                        const mlInfoDiv = document.createElement('div');
                        mlInfoDiv.className = 'mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-800 text-sm font-medium';
                        mlInfoDiv.textContent = result.ml_cluster_info;
                        generatedPicksContainer.prepend(mlInfoDiv); // Add to top of generated picks
                    }


                } else {
                    alert(result.error || 'An unknown error occurred during generation.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to connect to the server or an unexpected error occurred.');
            } finally {
                buttonText.textContent = 'Generate Smart Picks';
                loadingSpinner.classList.add('hidden');
                generatePicksBtn.disabled = false;
            }
        });

        // Event listener for saving all generated picks
        saveAllPicksBtn.addEventListener('click', async function() {
            if (currentGeneratedSets.length === 0) {
                alert('No picks to save.');
                return;
            }

            // Prepare picks for the /save_multiple_generated_picks endpoint
            const picksToSave = currentGeneratedSets.map(pick => ({
                white_balls: pick.white_balls,
                powerball: pick.powerball
            }));

            try {
                const response = await fetch('/save_multiple_generated_picks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ picks: picksToSave })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert(result.message);
                } else {
                    alert(result.message || result.error || 'Failed to save picks.');
                }
            } catch (error) {
                console.error('Error saving picks:', error);
                alert('Failed to connect to the server or an unexpected error occurred while saving picks.');
            }
        });
    });
</script>
{% endblock %}
