{% extends "base.html" %}

{% block title %}Pattern-Based Smart Pick Generator{% endblock %}

{% block page_heading %}Pattern-Based Smart Pick Generator{% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {# Flash messages display #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages space-y-3">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-md text-sm {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif category == 'info' %}bg-blue-100 text-blue-700 border border-blue-200{% else %}bg-green-100 text-green-700 border border-green-200{% endif %} animate-fade-in">
                        <p class="font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Define Your Smart Pick Criteria</h2>
        <p class="text-gray-700 mb-6">Generate Powerball numbers based on advanced historical patterns and your specific preferences. The generator will try to meet all criteria, prioritizing user-forced numbers, Group A count, Odd/Even split, and Sum Range, then favoring historical trends.</p>

        <form id="smartPickForm" method="POST" action="{{ url_for('generate_smart_picks_route') }}" class="space-y-6">
            {# General Settings #}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="num_sets_to_generate" class="block text-gray-700 text-sm font-bold mb-2">Number of Picks to Generate (1-5):</label>
                    <input type="number" id="num_sets_to_generate" name="num_sets_to_generate" min="1" max="5" value="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white border-gray-300">
                </div>
                <div>
                    <label for="excluded_numbers" class="block text-gray-700 text-sm font-bold mb-2">Excluded Numbers (comma-separated, e.g., 1,5,10):</label>
                    <input type="text" id="excluded_numbers" name="excluded_numbers" placeholder="e.g., 1, 5, 10" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white border-gray-300">
                </div>
            </div>

            {# Criterion 1: Group A Numbers #}
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Group A Numbers</h3>
                <p class="text-gray-700 mb-4">Select how many numbers should come from the predefined Group A ({{ group_a | join(', ') }}).</p>
                <label for="num_from_group_a" class="block text-gray-700 text-sm font-bold mb-2">Numbers from Group A (0-5):</label>
                <input type="number" id="num_from_group_a" name="num_from_group_a" min="0" max="5" value="2" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white border-gray-300">
            </div>

            {# Criterion 2: Odd/Even Trends #}
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Odd/Even Split</h3>
                <p class="text-gray-700 mb-4">Choose the desired odd/even distribution for the 5 white balls.</p>
                <label for="odd_even_choice" class="block text-gray-700 text-sm font-bold mb-2">Desired Split:</label>
                <select id="odd_even_choice" name="odd_even_choice" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white border-gray-300">
                    <option value="Any">Any Split</option>
                    <option value="3 Odd / 2 Even">3 Odd / 2 Even</option>
                    <option value="2 Odd / 3 Even">2 Odd / 3 Even</option>
                    <option value="4 Odd / 1 Even">4 Odd / 1 Even</option>
                    <option value="1 Odd / 4 Even">1 Odd / 4 Even</option>
                    <option value="All Odd">All Odd (5 Odd / 0 Even)</option>
                    <option value="All Even">All Even (0 Odd / 5 Even)</option>
                </select>
            </div>

            {# Criterion 3: Sum Range #}
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Sum Range</h3>
                <p class="text-gray-700 mb-4">Select a sum range for the 5 white balls.</p>
                <label for="sum_range_filter" class="block text-gray-700 text-sm font-bold mb-2">Sum Range:</label>
                <select id="sum_range_filter" name="sum_range_filter" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white border-gray-300">
                    {% for range_name, range_tuple in sum_ranges.items() %}
                        <option value="{{ range_name }}">{{ range_name }}</option>
                    {% endfor %}
                </select>
            </div>

            {# Criterion 4: Monthly Trends (Current Month Hot Numbers) #}
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Monthly Trends</h3>
                <p class="text-gray-700 mb-4">Prioritize numbers that have appeared more than once in the current (incomplete) month's draws.</p>
                <input type="checkbox" id="prioritize_monthly_hot" name="prioritize_monthly_hot" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="prioritize_monthly_hot" class="text-gray-700 text-sm font-bold">Prioritize Current Month's Hot Numbers</label>
            </div>

            {# Criterion 5: Pattern-Based Preferences (Grouped, Special, Consecutive) #}
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Pattern-Based Preferences</h3>
                <p class="text-gray-700 mb-4">Choose to prioritize numbers that frequently form certain patterns, or specify a pattern to include.</p>

                <div class="mb-4">
                    <input type="checkbox" id="prioritize_grouped_patterns" name="prioritize_grouped_patterns" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="prioritize_grouped_patterns" class="text-gray-700 text-sm font-bold">Prioritize numbers from historically frequent Grouped Patterns</label>
                </div>

                <div class="mb-4">
                    <input type="checkbox" id="prioritize_special_patterns" name="prioritize_special_patterns" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="prioritize_special_patterns" class="text-gray-700 text-sm font-bold">Prioritize numbers from historically frequent Special Patterns (Tens-Apart, Same Last Digit, Repeating Digit)</label>
                </div>

                <div class="mb-4">
                    <input type="checkbox" id="prioritize_consecutive_patterns" name="prioritize_consecutive_patterns" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="prioritize_consecutive_patterns" class="text-gray-700 text-sm font-bold">Prioritize forming Consecutive Pairs/Triplets</label>
                </div>

                <div class="mt-6">
                    <label for="force_specific_pattern" class="block text-gray-700 text-sm font-bold mb-2">Force Specific Pattern (e.g., 1,2 or 10,11,12):</label>
                    <input type="text" id="force_specific_pattern" name="force_specific_pattern" placeholder="e.g., 1,2 or 10,11,12" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white border-gray-300">
                    <p class="text-xs text-gray-500 mt-1">Enter 2 or 3 comma-separated numbers. These numbers *must* be included in the generated pick.</p>
                </div>
            </div>

            <div class="flex items-center justify-center mt-8">
                <button type="submit" id="generateSmartPicksBtn" class="btn-primary flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" id="loadingSpinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Generate Smart Picks
                </button>
            </div>
        </form>
    </div>

    {# Results Display Area #}
    <div id="smartPicksResults" class="mt-8 space-y-6">
        {# Generated picks will be displayed here #}
        {% if generated_sets %}
            <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-8 rounded-2xl shadow-xl text-white">
                <h2 class="text-3xl font-extrabold mb-6 text-center">Your Smart Picks!</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for pick in generated_sets %}
                        <div class="bg-white bg-opacity-20 backdrop-filter backdrop-blur-sm p-6 rounded-xl shadow-lg flex flex-col items-center justify-center space-y-4 generated-pick-item"
                             data-white-balls="{{ pick.white_balls | join(',') }}"
                             data-powerball="{{ pick.powerball }}">
                            <div class="flex space-x-2">
                                {% for num in pick.white_balls %}
                                    <span class="flex items-center justify-center w-10 h-10 rounded-full bg-yellow-400 text-gray-900 font-extrabold text-lg shadow-md">{{ num }}</span>
                                {% endfor %}
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-semibold">Powerball:</span>
                                <span class="flex items-center justify-center w-10 h-10 rounded-full bg-red-600 text-white font-extrabold text-lg shadow-md">{{ pick.powerball }}</span>
                            </div>
                            <button class="btn-secondary save-pick-btn w-full">Save This Pick</button>
                            <button class="btn-secondary analyze-pick-btn w-full">Analyze This Pick</button>
                        </div>
                    {% endfor %}
                </div>
                <div id="saveAllSmartPicksActions" class="mt-8 text-center">
                    <button id="saveAllSmartPicksBtn" class="btn-primary">Save All Generated Picks</button>
                </div>
            </div>
            
            {# Analysis Modal Structure #}
            <div id="analysisModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl transform transition-all scale-95 opacity-0" id="analysisModalContent">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Historical Match Analysis</h3>
                        <button id="closeAnalysisModal" class="text-gray-500 hover:text-gray-700">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="analysisResultsContent" class="space-y-4 text-gray-700">
                        <p>Loading analysis...</p>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const smartPickForm = document.getElementById('smartPickForm');
        const generateSmartPicksBtn = document.getElementById('generateSmartPicksBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const smartPicksResultsDiv = document.getElementById('smartPicksResults');
        const saveAllSmartPicksBtn = document.getElementById('saveAllSmartPicksBtn');
        const saveAllSmartPicksActions = document.getElementById('saveAllSmartPicksActions');

        const analysisModal = document.getElementById('analysisModal');
        const analysisModalContent = document.getElementById('analysisModalContent');
        const closeAnalysisModalBtn = document.getElementById('closeAnalysisModal');
        const analysisResultsContent = document.getElementById('analysisResultsContent');

        // Show loading spinner on form submission
        smartPickForm.addEventListener('submit', function() {
            generateSmartPicksBtn.disabled = true;
            loadingSpinner.classList.remove('hidden');
            generateSmartPicksBtn.textContent = 'Generating...';
            smartPicksResultsDiv.innerHTML = ''; // Clear previous results
        });

        // Function to show flash messages (if not already handled by Flask)
        function showFlashMessage(message, category) {
            const flashContainer = document.querySelector('.flash-messages');
            if (flashContainer) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `p-4 rounded-lg shadow-md text-sm animate-fade-in ${
                    category === 'error' ? 'bg-red-100 text-red-700 border border-red-200' :
                    category === 'info' ? 'bg-blue-100 text-blue-700 border border-blue-200' :
                    'bg-green-100 text-green-700 border border-green-200'
                }`;
                messageDiv.innerHTML = `<p class="font-medium">${message}</p>`;
                flashContainer.appendChild(messageDiv);
                setTimeout(() => messageDiv.remove(), 5000); // Remove after 5 seconds
            }
        }

        // --- Save Single Pick Logic ---
        document.body.addEventListener('click', async function(event) {
            if (event.target.classList.contains('save-pick-btn')) {
                const pickItem = event.target.closest('.generated-pick-item');
                if (pickItem) {
                    const whiteBallsStr = pickItem.dataset.whiteBalls;
                    const powerballStr = pickItem.dataset.powerball;
                    const whiteBalls = whiteBallsStr.split(',').map(Number);
                    const powerball = Number(powerballStr);

                    try {
                        const response = await fetch('/save_manual_pick', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ white_balls: whiteBalls, powerball: powerball })
                        });
                        const result = await response.json();
                        if (result.success) {
                            showFlashMessage(result.message, 'info');
                        } else {
                            showFlashMessage(result.error, 'error');
                        }
                    } catch (error) {
                        console.error('Error saving pick:', error);
                        showFlashMessage('An error occurred while saving the pick.', 'error');
                    }
                }
            }
        });

        // --- Save All Smart Picks Button Logic ---
        if (saveAllSmartPicksBtn) {
            saveAllSmartPicksBtn.addEventListener('click', async function() {
                const allSmartPickItems = document.querySelectorAll('#smartPicksResults .generated-pick-item');
                const picksToSave = [];
                allSmartPickItems.forEach(item => {
                    const whiteBallsStr = item.dataset.whiteBalls;
                    const powerballStr = item.dataset.powerball;
                    if (whiteBallsStr && powerballStr) {
                        picksToSave.push({
                            white_balls: whiteBallsStr.split(',').map(Number),
                            powerball: Number(powerballStr)
                        });
                    }
                });

                if (picksToSave.length === 0) {
                    showFlashMessage("No picks to save.", 'info');
                    return;
                }

                try {
                    const response = await fetch('/save_multiple_generated_picks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ picks: picksToSave })
                    });
                    const result = await response.json();
                    if (result.success) {
                        showFlashMessage(result.message, 'info');
                    } else {
                        showFlashMessage(result.message || result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error saving multiple picks:', error);
                    showFlashMessage('An error occurred while saving multiple picks.', 'error');
                }
            });
        }

        // --- Analyze Single Pick Logic (Modal) ---
        document.body.addEventListener('click', async function(event) {
            if (event.target.classList.contains('analyze-pick-btn')) {
                const pickItem = event.target.closest('.generated-pick-item');
                if (pickItem) {
                    const whiteBallsStr = pickItem.dataset.whiteBalls;
                    const powerballStr = pickItem.dataset.powerball;
                    const whiteBalls = whiteBallsStr.split(',').map(Number);
                    const powerball = Number(powerballStr);

                    analysisResultsContent.innerHTML = '<p>Loading analysis...</p>';
                    analysisModal.classList.remove('hidden');
                    setTimeout(() => { // Animate modal in
                        analysisModalContent.classList.remove('scale-95', 'opacity-0');
                        analysisModalContent.classList.add('scale-100', 'opacity-100');
                    }, 10);

                    try {
                        const response = await fetch('/analyze_generated_historical_matches', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ generated_white_balls: whiteBalls, generated_powerball: powerball })
                        });
                        const result = await response.json();

                        if (result.success) {
                            let html = `<p class="mb-4">Analysis for pick: <span class="font-bold">${whiteBalls.join(', ')}</span> Powerball: <span class="font-bold">${powerball}</span></p>`;
                            html += `<h4 class="text-lg font-semibold mb-2">Match Summary (Last 2 Years):</h4>`;
                            html += `<ul class="list-disc list-inside space-y-1">`;
                            
                            // Sort categories for consistent display, showing matches first
                            const sortedCategories = Object.keys(result.match_summary).sort((a, b) => {
                                if (a === "No Match") return 1;
                                if (b === "No Match") return -1;
                                return 0; // Keep original order for other matches
                            });

                            sortedCategories.forEach(category => {
                                const summary = result.match_summary[category];
                                if (summary.count > 0) {
                                    html += `<li><strong>${category}:</strong> ${summary.count} time(s)`;
                                    if (summary.draws && summary.draws.length > 0) {
                                        html += ` (Last seen: ${summary.draws[0].date})`;
                                    }
                                    html += `</li>`;
                                }
                            });
                            html += `</ul>`;

                            // Last drawn dates for individual numbers
                            if (result.last_drawn_dates) {
                                html += `<h4 class="text-lg font-semibold mt-6 mb-2">Last Drawn Dates for Individual Numbers:</h4>`;
                                html += `<ul class="list-disc list-inside space-y-1">`;
                                for (const [key, date] of Object.entries(result.last_drawn_dates)) {
                                    html += `<li><strong>${key}:</strong> ${date}</li>`;
                                }
                                html += `</ul>`;
                            }

                            analysisResultsContent.innerHTML = html;

                        } else {
                            analysisResultsContent.innerHTML = `<p class="text-red-600">Error: ${result.error}</p>`;
                        }
                    } catch (error) {
                        console.error('Error analyzing pick:', error);
                        analysisResultsContent.innerHTML = '<p class="text-red-600">An error occurred during analysis.</p>';
                    }
                }
            }
        });

        // Close modal logic
        closeAnalysisModalBtn.addEventListener('click', function() {
            analysisModalContent.classList.remove('scale-100', 'opacity-100');
            analysisModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                analysisModal.classList.add('hidden');
            }, 300); // Match transition duration
        });

        analysisModal.addEventListener('click', function(event) {
            if (event.target === analysisModal) { // Only close if clicked on overlay, not content
                closeAnalysisModalBtn.click();
            }
        });
    });
</script>
{% endblock %}
