{% extends "base.html" %}

{% block title %}Special Patterns Analysis{% endblock %}

{% block page_heading %}Special Patterns Analysis{% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="card p-6 bg-white rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Special Number Patterns</h2>
        <p class="text-gray-700 mb-6">This page analyzes historical draws for specific "special" number patterns. Use the dropdown to filter the results by year.</p>

        <!-- New Year Filter -->
        <div class="mb-6 flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
            <label for="year-select" class="font-medium text-gray-700">Filter by Year:</label>
            <select id="year-select" class="form-select mt-1 block w-full sm:w-auto rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                {% for year in years %}
                    <option value="{{ year }}" {% if year == initial_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- New Chart for Yearly Counts -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Total Special Patterns by Year</h3>
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner">
                <canvas id="yearlyPatternsChart" class="w-full h-80"></canvas>
            </div>
        </div>

        <!-- Tens-Apart Patterns Section -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Tens-Apart Patterns (e.g., 10, 20; 55, 65)</h3>
            <p class="text-gray-700 mb-4">These are pairs of white balls where one number is exactly 10, 20, 30, 40, or 50 greater than the other. The table below shows the most frequently occurring such pairs for the selected year.</p>
            <div id="tensApartPatternsContainer">
                {% include 'partials/_special_patterns_table.html' with patterns=special_patterns_data.tens_apart_patterns table_id='tensApartTableBody' button_id='tensApartToggleBtn' title='Tens-Apart Patterns' %}
            </div>
        </div>

        <!-- Same Last-Digit Patterns Section -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Same Last-Digit Patterns (e.g., 12, 22; 45, 55, 65)</h3>
            <p class="text-gray-700 mb-4">This table shows pairs of numbers that share the same last digit for the selected year.</p>
            <div id="sameLastDigitPatternsContainer">
                {% include 'partials/_special_patterns_table.html' with patterns=special_patterns_data.same_last_digit_patterns table_id='sameLastDigitTableBody' button_id='sameLastDigitToggleBtn' title='Same Last-Digit Patterns' %}
            </div>
        </div>
        
        <!-- Repeating Digit Patterns Section -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Repeating Digit Patterns (e.g., 11, 22, 33)</h3>
            <p class="text-gray-700 mb-4">These patterns consist of numbers with a repeating digit (e.g., 11, 22, 33). This table shows the most frequent pairs of such numbers for the selected year.</p>
            <div id="repeatingDigitPatternsContainer">
                {% include 'partials/_special_patterns_table.html' with patterns=special_patterns_data.repeating_digit_patterns table_id='repeatingDigitTableBody' button_id='repeatingDigitToggleBtn' title='Repeating Digit Patterns' %}
            </div>
        </div>
    </div>
</div>

<!-- A new partial for the table, to make it easier to update via JavaScript -->
<script id="pattern-table-template" type="text/html">
    {% raw %}
    {% if patterns and patterns.length > 0 %}
        <div class="overflow-x-auto shadow-md rounded-lg">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Pattern
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Count
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="{{ table_id }}">
                    {% for item in patterns %}
                        <tr class="{% if loop.index > 10 %}hidden{% endif %}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="font-mono text-sm font-semibold text-indigo-600">{{ item.pattern.join(', ') }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ item.count }}</div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if patterns.length > 10 %}
            <div class="mt-4 text-center">
                <button id="{{ button_id }}" class="btn-secondary">Show All ({{ patterns.length }} entries)</button>
            </div>
        {% endif %}
    {% else %}
        <div class="p-4 bg-gray-100 rounded-md text-gray-600">
            No patterns found for the selected year.
        </div>
    {% endif %}
    {% endraw %}
</script>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const yearSelect = document.getElementById('year-select');
        const tensApartContainer = document.getElementById('tensApartPatternsContainer');
        const sameLastDigitContainer = document.getElementById('sameLastDigitPatternsContainer');
        const repeatingDigitContainer = document.getElementById('repeatingDigitPatternsContainer');
        const yearlyPatternsCanvas = document.getElementById('yearlyPatternsChart');

        let yearlyPatternsChart; // Declare chart variable to be accessible globally

        // Setup the initial chart
        function setupChart(data) {
            const labels = Object.keys(data).map(Number);
            const counts = Object.values(data);
            const ctx = yearlyPatternsCanvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (yearlyPatternsChart) {
                yearlyPatternsChart.destroy();
            }

            yearlyPatternsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Special Patterns',
                        data: counts,
                        backgroundColor: 'rgba(79, 70, 229, 0.7)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1,
                        borderRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Total Patterns: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Patterns'
                            },
                            ticks: {
                                precision: 0
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        }
                    }
                }
            });
        }

        // Function to render the tables
        function renderTables(patterns) {
            const template = document.getElementById('pattern-table-template').innerHTML;

            function renderTable(container, data, tableId, buttonId, title) {
                // Simple templating for the table content
                let tableHtml = `<div class="overflow-x-auto shadow-md rounded-lg">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pattern</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="${tableId}">`;
                if (data && data.length > 0) {
                    data.forEach((item, index) => {
                        const isHidden = index >= 10 ? 'hidden' : '';
                        tableHtml += `<tr class="${isHidden}">
                                        <td class="px-6 py-4 whitespace-nowrap"><span class="font-mono text-sm font-semibold text-indigo-600">${item.pattern.join(', ')}</span></td>
                                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${item.count}</div></td>
                                    </tr>`;
                    });
                } else {
                    tableHtml += `<tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">No patterns found for this year.</td></tr>`;
                }
                tableHtml += `</tbody></table></div>`;

                if (data && data.length > 10) {
                    tableHtml += `<div class="mt-4 text-center"><button id="${buttonId}" class="btn-secondary">Show All (${data.length} entries)</button></div>`;
                }
                
                container.innerHTML = tableHtml;
                
                // Add event listener to the new button
                const toggleBtn = document.getElementById(buttonId);
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function() {
                        const tableBody = document.getElementById(tableId);
                        const rows = tableBody.querySelectorAll('tr');
                        let isExpanded = toggleBtn.textContent.includes('Show Less');
                        
                        rows.forEach((row, index) => {
                            if (index >= 10) {
                                if (!isExpanded) {
                                    row.classList.remove('hidden');
                                } else {
                                    row.classList.add('hidden');
                                }
                            }
                        });
                        toggleBtn.textContent = isExpanded ? `Show All (${rows.length} entries)` : 'Show Less';
                    });
                }
            }
            
            renderTable(tensApartContainer, patterns.tens_apart_patterns, 'tensApartTableBody', 'tensApartToggleBtn', 'Tens-Apart Patterns');
            renderTable(sameLastDigitContainer, patterns.same_last_digit_patterns, 'sameLastDigitTableBody', 'sameLastDigitToggleBtn', 'Same Last-Digit Patterns');
            renderTable(repeatingDigitContainer, patterns.repeating_digit_patterns, 'repeatingDigitTableBody', 'repeatingDigitToggleBtn', 'Repeating Digit Patterns');
        }

        // Fetch and update data based on selected year
        async function updatePageWithYear(year) {
            try {
                // Show loading indicator here if you have one
                const response = await fetch(`/api/special_patterns_by_year?year=${year}`);
                const data = await response.json();
                
                if (response.ok) {
                    renderTables(data);
                } else {
                    console.error('API Error:', data.error);
                    // Render empty tables with an error message
                    renderTables({ tens_apart_patterns: [], same_last_digit_patterns: [], repeating_digit_patterns: [] });
                }
            } catch (error) {
                console.error('Fetch error:', error);
                // Render empty tables with an error message
                renderTables({ tens_apart_patterns: [], same_last_digit_patterns: [], repeating_digit_patterns: [] });
            } finally {
                // Hide loading indicator
            }
        }

        // Initial setup on page load
        const initialYearlyTrends = {{ yearly_trends|tojson }};
        setupChart(initialYearlyTrends);
        
        // Event listener for year dropdown
        yearSelect.addEventListener('change', function() {
            const selectedYear = yearSelect.value;
            updatePageWithYear(selectedYear);
        });

        // Initial render for the first time
        const initialYear = yearSelect.value;
        // The first render is done via Jinja, so we don't need to call updatePageWithYear here.
        // The JavaScript is now set up to handle future changes.
    });
</script>
{% endblock %}

