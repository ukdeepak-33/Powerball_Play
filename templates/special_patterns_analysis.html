{% extends "base.html" %}

{% block title %}Special Patterns Analysis{% endblock %}

{% block page_heading %}Special Patterns Analysis{% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {# Flash messages display #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages space-y-3">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-md text-sm {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif category == 'info' %}bg-blue-100 text-blue-700 border border-blue-200{% else %}bg-green-100 text-green-700 border border-green-200{% endif %} animate-fade-in">
                        <p class="font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Explore Special Number Patterns</h2>
        <p class="text-gray-700 mb-6">This page analyzes historical draws for specific "special" number patterns that might be of interest, such as numbers that are a multiple of 10 apart, numbers sharing the same last digit, or repeating digit numbers.</p>

        <div id="loadingIndicator" class="text-center text-blue-600 font-semibold py-4 hidden">
            <svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading analysis data...
        </div>

        <div id="analysisContent" class="space-y-8 hidden">
            {# Tens-Apart Patterns Section #}
            <details class="card p-6 bg-gray-50 rounded-xl shadow-sm border border-gray-100" open>
                <summary class="text-xl font-bold mb-3 text-gray-800 cursor-pointer flex justify-between items-center">
                    Tens-Apart Patterns (e.g., 10, 20; 55, 65)
                    <svg class="w-6 h-6 transform transition-transform duration-200 details-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </summary>
                <p class="text-gray-700 mb-4 mt-4">These are pairs of white balls where one number is exactly 10, 20, 30, 40, or 50 greater than the other. This table shows the most frequently occurring such pairs.</p>
                
                <div class="mb-4">
                    <label for="tensApartSortOrder" class="block text-gray-700 text-sm font-bold mb-2">Sort By:</label>
                    <select id="tensApartSortOrder" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white border-gray-300">
                        <option value="count_desc">Most Frequent First</option>
                        <option value="count_asc">Least Frequent First</option>
                        <option value="pattern_asc">Pattern Numbers Ascending</option>
                    </select>
                </div>
                <div class="overflow-x-auto shadow-md rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-100 text-blue-800">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-semibold">Pattern</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold">Count</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold">Percentage</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="tensApartTableBody">
                            <tr><td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Loading patterns...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-4 hidden" id="tensApartToggleContainer">
                    <button id="tensApartToggleBtn" class="btn-secondary">Show All</button>
                </div>
            </details>

            {# Same Last Digit Patterns Section #}
            <details class="card p-6 bg-gray-50 rounded-xl shadow-sm border border-gray-100" open>
                <summary class="text-xl font-bold mb-3 text-gray-800 cursor-pointer flex justify-between items-center">
                    Same Last Digit Patterns (e.g., 9, 19, 29; 8, 28, 48, 58)
                    <svg class="w-6 h-6 transform transition-transform duration-200 details-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </summary>
                <p class="text-gray-700 mb-4 mt-4">These patterns consist of two or more white balls that share the same last digit. This table lists the most frequent occurrences of these vertical patterns.</p>
                <div class="mb-4">
                    <label for="sameLastDigitSortOrder" class="block text-gray-700 text-sm font-bold mb-2">Sort By:</label>
                    <select id="sameLastDigitSortOrder" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white border-gray-300">
                        <option value="count_desc">Most Frequent First</option>
                        <option value="count_asc">Least Frequent First</option>
                        <option value="pattern_asc">Pattern Numbers Ascending</option>
                    </select>
                </div>
                <div class="overflow-x-auto shadow-md rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-100 text-blue-800">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-semibold">Pattern</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold">Count</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold">Percentage</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="sameLastDigitTableBody">
                            <tr><td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Loading patterns...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-4 hidden" id="sameLastDigitToggleContainer">
                    <button id="sameLastDigitToggleBtn" class="btn-secondary">Show All</button>
                </div>
            </details>

            {# Repeating Digit Patterns Section #}
            <details class="card p-6 bg-gray-50 rounded-xl shadow-sm border border-gray-100" open>
                <summary class="text-xl font-bold mb-3 text-gray-800 cursor-pointer flex justify-between items-center">
                    Repeating Digit Patterns (e.g., 11, 22, 33)
                    <svg class="w-6 h-6 transform transition-transform duration-200 details-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </summary>
                <p class="text-gray-700 mb-4 mt-4">This section identifies occurrences of numbers with repeating digits (e.g., 11, 22, 33, 44, 55, 66) appearing together in a draw. The table shows the most frequent combinations.</p>
                <div class="mb-4">
                    <label for="repeatingDigitSortOrder" class="block text-gray-700 text-sm font-bold mb-2">Sort By:</label>
                    <select id="repeatingDigitSortOrder" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white border-gray-300">
                        <option value="count_desc">Most Frequent First</option>
                        <option value="count_asc">Least Frequent First</option>
                        <option value="pattern_asc">Pattern Numbers Ascending</option>
                    </select>
                </div>
                <div class="overflow-x-auto shadow-md rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-100 text-blue-800">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-semibold">Pattern</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold">Count</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold">Percentage</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="repeatingDigitTableBody">
                            <tr><td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Loading patterns...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-4 hidden" id="repeatingDigitToggleContainer">
                    <button id="repeatingDigitToggleBtn" class="btn-secondary">Show All</button>
                </div>
            </details>
        </div>
    </div>
</div>

<style>
    /* Basic styling for the details arrow */
    details > summary::-webkit-details-marker {
        display: none; /* Hide default marker */
    }
    details > summary {
        list-style: none; /* Remove default list style */
    }
    details[open] .details-arrow {
        transform: rotate(180deg); /* Rotate arrow when open */
    }
    .btn-secondary {
        @apply bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-300 transition duration-300 ease-in-out transform hover:scale-105;
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Global variable to hold fetched data
        let specialPatternsData = {}; 

        // References to main elements
        const loadingIndicator = document.getElementById('loadingIndicator');
        const analysisContent = document.getElementById('analysisContent');

        // References to table bodies and sort selects
        const tensApartTableBody = document.getElementById('tensApartTableBody');
        const tensApartSortOrder = document.getElementById('tensApartSortOrder');
        const tensApartToggleBtn = document.getElementById('tensApartToggleBtn');
        const tensApartToggleContainer = document.getElementById('tensApartToggleContainer');


        const sameLastDigitTableBody = document.getElementById('sameLastDigitTableBody');
        const sameLastDigitSortOrder = document.getElementById('sameLastDigitSortOrder');
        const sameLastDigitToggleBtn = document.getElementById('sameLastDigitToggleBtn');
        const sameLastDigitToggleContainer = document.getElementById('sameLastDigitToggleContainer');


        const repeatingDigitTableBody = document.getElementById('repeatingDigitTableBody');
        const repeatingDigitSortOrder = document.getElementById('repeatingDigitSortOrder');
        const repeatingDigitToggleBtn = document.getElementById('repeatingDigitToggleBtn');
        const repeatingDigitToggleContainer = document.getElementById('repeatingDigitToggleContainer');


        // Function to sort and render a specific table
        function sortAndRenderTable(tableBody, data, sortOrder, toggleBtn, toggleContainer, initialShowCount = 10) {
            let sortedData = [...data]; // Create a mutable copy

            sortedData.sort((a, b) => {
                if (sortOrder === 'count_desc') {
                    // Primary: count descending, Secondary: pattern ascending
                    if (b.count !== a.count) return b.count - a.count;
                    return a.pattern[0] - b.pattern[0] || (a.pattern[1] !== undefined ? a.pattern[1] - b.pattern[1] : 0) || (a.pattern[2] !== undefined ? a.pattern[2] - b.pattern[2] : 0);
                } else if (sortOrder === 'count_asc') {
                    // Primary: count ascending, Secondary: pattern ascending
                    if (a.count !== b.count) return a.count - b.count;
                    return a.pattern[0] - b.pattern[0] || (a.pattern[1] !== undefined ? a.pattern[1] - b.pattern[1] : 0) || (a.pattern[2] !== undefined ? a.pattern[2] - b.pattern[2] : 0);
                } else if (sortOrder === 'pattern_asc') {
                    // Primary: pattern ascending, Secondary: count descending
                    if (a.pattern[0] !== b.pattern[0]) return a.pattern[0] - b.pattern[0];
                    if (a.pattern[1] !== undefined && b.pattern[1] !== undefined && a.pattern[1] !== b.pattern[1]) return a.pattern[1] - b.pattern[1];
                    if (a.pattern[2] !== undefined && b.pattern[2] !== undefined && a.pattern[2] !== b.pattern[2]) return a.pattern[2] - b.pattern[2];
                    return b.count - a.count;
                }
                return 0; // No change if sort order is not recognized
            });

            tableBody.innerHTML = ''; // Clear existing rows

            if (sortedData.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `<td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No patterns found.</td>`;
                tableBody.appendChild(noDataRow);
                if (toggleContainer) toggleContainer.classList.add('hidden'); // Hide toggle if no data
                return;
            }

            sortedData.forEach((pattern, index) => {
                const row = document.createElement('tr');
                // Apply hidden class if current index is beyond initialShowCount
                row.className = `hover:bg-gray-50 ${index >= initialShowCount ? 'hidden' : ''}`; 

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">(${pattern.pattern.join(', ')})</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${pattern.count}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${pattern.percentage}%</td>
                `;
                tableBody.appendChild(row);
            });

            // Update toggle button text and visibility
            if (toggleBtn && toggleContainer) {
                if (sortedData.length > initialShowCount) {
                    toggleContainer.classList.remove('hidden');
                    toggleBtn.textContent = `Show All (${sortedData.length} entries)`;
                    toggleBtn.dataset.isExpanded = 'false';
                    tableBody.parentElement.style.maxHeight = ''; // Remove max height
                    tableBody.parentElement.style.overflowY = '';
                } else {
                    toggleContainer.classList.add('hidden');
                }
            }
        }

        // Setup toggle functionality (modified to work with re-rendering)
        function setupToggleFunctionality(buttonId, tableBodyId, initialShowCount) {
            const toggleBtn = document.getElementById(buttonId);
            const tableBody = document.getElementById(tableBodyId);
            if (!toggleBtn || !tableBody) return;

            toggleBtn.addEventListener('click', function() {
                let isExpanded = this.dataset.isExpanded === 'true';
                const rows = Array.from(tableBody.children);

                isExpanded = !isExpanded;
                rows.forEach((row, index) => {
                    if (index >= initialShowCount) {
                        if (isExpanded) {
                            row.classList.remove('hidden');
                        } else {
                            row.classList.add('hidden');
                        }
                    }
                });

                if (isExpanded) {
                    this.textContent = 'Show Less';
                    // Apply max height and scroll for expanded view
                    tableBody.parentElement.style.maxHeight = '400px'; 
                    tableBody.parentElement.style.overflowY = 'auto';
                } else {
                    this.textContent = `Show All (${rows.length} entries)`;
                    // Remove max height and scroll when collapsed
                    tableBody.parentElement.style.maxHeight = ''; 
                    tableBody.parentElement.style.overflowY = '';
                }
                this.dataset.isExpanded = isExpanded.toString();
            });
        }

        // Function to fetch and render all data
        async function fetchAndRenderAllPatterns() {
            loadingIndicator.classList.remove('hidden');
            analysisContent.classList.add('hidden');

            try {
                const response = await fetch('/special_patterns_analysis', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // Signal an AJAX request
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                specialPatternsData = await response.json(); // Store fetched data globally
                
                // Initial render for each table with the default sort order
                sortAndRenderTable(tensApartTableBody, specialPatternsData.tens_apart_patterns, tensApartSortOrder.value, tensApartToggleBtn, tensApartToggleContainer);
                sortAndRenderTable(sameLastDigitTableBody, specialPatternsData.same_last_digit_patterns, sameLastDigitSortOrder.value, sameLastDigitToggleBtn, sameLastDigitToggleContainer);
                sortAndRenderTable(repeatingDigitTableBody, specialPatternsData.repeating_digit_patterns, repeatingDigitSortOrder.value, repeatingDigitToggleBtn, repeatingDigitToggleContainer);

                analysisContent.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading special patterns analysis:', error);
                showFlashMessage(`Failed to load special patterns analysis: ${error.message}. Please try again.`, 'error');
                analysisContent.classList.add('hidden'); 
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Add event listeners for sort order changes, using the globally stored data
        tensApartSortOrder.addEventListener('change', () => {
            sortAndRenderTable(tensApartTableBody, specialPatternsData.tens_apart_patterns, tensApartSortOrder.value, tensApartToggleBtn, tensApartToggleContainer);
        });
        sameLastDigitSortOrder.addEventListener('change', () => {
            sortAndRenderTable(sameLastDigitTableBody, specialPatternsData.same_last_digit_patterns, sameLastDigitSortOrder.value, sameLastDigitToggleBtn, sameLastDigitToggleContainer);
        });
        repeatingDigitSortOrder.addEventListener('change', () => {
            sortAndRenderTable(repeatingDigitTableBody, specialPatternsData.repeating_digit_patterns, repeatingDigitSortOrder.value, repeatingDigitToggleBtn, repeatingDigitToggleContainer);
        });

        // Setup toggle functionality for each table
        setupToggleFunctionality('tensApartToggleBtn', 'tensApartTableBody', 10);
        setupToggleFunctionality('sameLastDigitToggleBtn', 'sameLastDigitTableBody', 10);
        setupToggleFunctionality('repeatingDigitToggleBtn', 'repeatingDigitTableBody', 10);

        // Add event listener to the details elements to update the arrow
        document.querySelectorAll('details').forEach(detailsElement => {
            detailsElement.addEventListener('toggle', () => {
                const arrow = detailsElement.querySelector('.details-arrow');
                if (detailsElement.open) {
                    arrow.classList.add('rotate-180');
                } else {
                    arrow.classList.remove('rotate-180');
                }
            });
        });

        // Initial fetch and render when the page loads
        fetchAndRenderAllPatterns();

        // Helper function to show flash messages (copied from simulate_multiple_draws.html)
        function showFlashMessage(message, category) {
            const flashMessagesDiv = document.querySelector('.flash-messages') || document.createElement('div');
            flashMessagesDiv.className = 'flash-messages space-y-3'; // Ensure class if created
            if (!document.querySelector('.flash-messages')) {
                document.querySelector('.space-y-8.max-w-6xl.mx-auto.px-4.sm\\:px-6.lg\\:px-8.py-8').prepend(flashMessagesDiv);
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `p-4 rounded-lg shadow-md text-sm animate-fade-in ${
                category === 'error' ? 'bg-red-100 text-red-700 border border-red-200' :
                category === 'info' ? 'bg-blue-100 text-blue-700 border border-blue-200' :
                'bg-green-100 text-green-700 border border-green-200'
            }`;
            messageDiv.innerHTML = `<p class="font-medium">${message}</p>`;
            flashMessagesDiv.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000); 
        }
    });
</script>
{% endblock %}
