{% extends "base.html" %}

{% block title %}Consecutive Numbers Trends{% endblock %}

{% block page_heading %}Consecutive Numbers Trends{% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {# Flash messages display #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages space-y-3">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-md text-sm {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif category == 'info' %}bg-blue-100 text-blue-700 border border-blue-200{% else %}bg-green-100 text-green-700 border border-blue-200{% endif %} animate-fade-in">
                        <p class="font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {# Recent Consecutive Trends Card #}
    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Recent Consecutive Trends</h2>
        {% if consecutive_trends %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Draw Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Consecutive Pairs</th>
                        </tr>
                    </thead>
                    <tbody id="trends-table-body" class="bg-white divide-y divide-gray-200">
                        {% for trend in consecutive_trends %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ trend.draw_date }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ trend.consecutive_pairs }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-gray-500">No recent consecutive number trends available.</p>
        {% endif %}
    </div>

    {# Yearly Trends Chart Card #}
    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Consecutive Numbers Trends Over the Years</h2>
        <p class="text-gray-600 mb-4">Click on a bar to see the trends for that year.</p>
        <div class="mb-4">
            <canvas id="yearly-consecutive-chart"></canvas>
        </div>

        {# Most Frequent Pairs Section #}
        <div class="mt-8">
            <h3 class="text-xl font-bold mb-2 text-gray-800">Most Frequent Consecutive Pairs</h3>
            <div id="frequent-consecutive-pairs-list" class="flex flex-wrap gap-2 text-sm text-gray-600">
                {% for pair in most_frequent_pairs %}
                <span class="bg-gray-200 px-3 py-1 rounded-full">{{ pair.pair }} ({{ pair.count }})</span>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const trendsData = JSON.parse('{{ yearly_trends | tojson }}');
        const labels = trendsData.map(d => d.year);
        const data = trendsData.map(d => d.percentage);

        // Chart configuration
        const ctx = document.getElementById('yearly-consecutive-chart').getContext('2d');
        const yearlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Percentage of Draws with Consecutive Numbers',
                    data: data,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Year',
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Percentage (%)',
                            font: { size: 14, weight: 'bold' }
                        },
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) { return value + '%'; }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                },
                // Add the onClick event listener here
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const clickedElementIndex = elements[0].index;
                        const year = yearlyChart.data.labels[clickedElementIndex];
                        fetchTrendsForYear(year);
                    }
                }
            }
        });
    });

    function fetchTrendsForYear(year) {
        // This makes a GET request to the new endpoint you created in index.py
        fetch(`/consecutive_trends_by_year/${year}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                updateTrendsTable(data);
            })
            .catch(error => console.error('Error fetching data:', error));
    }

    function updateTrendsTable(trends) {
        const tableBody = document.getElementById('trends-table-body');
        tableBody.innerHTML = ''; // Clear existing table rows

        if (trends && trends.length > 0) {
            trends.forEach(trend => {
                const row = tableBody.insertRow();
                row.insertCell(0).innerText = trend.draw_date;
                row.insertCell(1).innerText = trend.consecutive_pairs;
            });
        } else {
            const row = tableBody.insertRow();
            const cell = row.insertCell(0);
            cell.colSpan = 2;
            cell.innerText = `No consecutive trends found for this year.`;
            cell.classList.add('text-center', 'py-4', 'text-gray-500');
        }
    }
</script>
{% endblock %}
