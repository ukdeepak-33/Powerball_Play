{% extends "base.html" %}

{% block title %}Consecutive Numbers Trends{% endblock %}

{% block page_heading %}Consecutive Numbers Trends{% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {# Flash messages display #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages space-y-3">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-md text-sm {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% else %}bg-blue-100 text-blue-700 border border-blue-200{% endif %} animate-fade-in">
                        <p class="font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {# AI ANALYSIS SECTION #}
    <div class="card p-6 bg-blue-50 border border-blue-200 rounded-xl shadow-sm mb-8">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h3 class="text-xl font-bold text-blue-900 flex items-center gap-2">
                    âœ¨ AI Trend Analyst <span id="target-year-label" class="text-blue-600"></span>
                </h3>
                <p id="ai-status" class="text-sm text-blue-700 italic">Click a bar in the chart below to select a year for analysis.</p>
            </div>
            <button id="run-ai-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition-all shadow-md">
                Run AI Analysis
            </button>
        </div>
        <div id="ai-response-box" class="mt-4 text-gray-800 leading-relaxed hidden bg-white p-4 rounded-lg border border-blue-100 shadow-inner">
            </div>
    </div>

    {# CHART SECTION #}
    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Consecutive Numbers Trends Over Years</h2>
        <p class="text-sm text-gray-500 mb-4 font-medium italic">Tip: Click a specific year's bar to see its detailed draw history in the table below.</p>
        <div class="h-80">
            <canvas id="consecutiveTrendsChart"></canvas>
        </div>
    </div>

    {# DYNAMIC DATA TABLE SECTION #}
    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h3 id="table-title" class="text-2xl font-bold mb-4 text-gray-800">Yearly Draw History</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50 text-gray-700 border-b border-gray-200">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Draw Date</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Consecutive?</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Pairs Found</th>
                    </tr>
                </thead>
                <tbody id="recent-trends-body" class="divide-y divide-gray-100">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Data injected from Flask
        const allDraws = {{ all_draws_json | safe }};
        const yearlyData = {{ yearly_consecutive_percentage_data | safe }};
        const ctx = document.getElementById('consecutiveTrendsChart').getContext('2d');
        
        let selectedYear = new Date().getFullYear().toString();
        let chart;

        // Function to update the table display
        function updateTable(year) {
            const tbody = document.getElementById('recent-trends-body');
            const tableTitle = document.getElementById('table-title');
            const label = document.getElementById('target-year-label');
            
            const filtered = allDraws.filter(d => d.year.toString() === year);
            
            label.innerText = `(${year})`;
            tableTitle.innerText = `Detailed Draws for ${year}`;
            tbody.innerHTML = '';
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400">No data found for this year.</td></tr>';
                return;
            }

            filtered.forEach(draw => {
                const row = `
                    <tr class="hover:bg-blue-50 transition-colors">
                        <td class="py-3 px-4 text-sm font-medium text-gray-700">${draw.date}</td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 rounded text-xs font-bold ${draw.has_consec === 'Yes' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                                ${draw.has_consec}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-sm font-mono text-blue-600">${draw.sequences}</td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }

        // AI Button Handler
        document.getElementById('run-ai-btn').addEventListener('click', async () => {
            const btn = document.getElementById('run-ai-btn');
            const box = document.getElementById('ai-response-box');
            const status = document.getElementById('ai-status');

            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            status.innerText = "Consulting Gemini AI for " + selectedYear + " trends...";
            box.classList.add('hidden');
            
            try {
                const res = await fetch('/api/analyze-consecutive-trends', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ year: selectedYear })
                });
                const data = await res.json();
                
                if (data.summary) {
                    box.innerText = data.summary;
                    box.classList.remove('hidden');
                    status.innerText = "Analysis complete.";
                } else {
                    status.innerText = "Error: " + data.error;
                }
            } catch (e) {
                status.innerText = "Error connecting to server.";
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        // Chart Initialization
        function renderChart() {
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: yearlyData.map(d => d.year),
                    datasets: [{
                        label: 'Consecutive Pair %',
                        data: yearlyData.map(d => d.percentage),
                        backgroundColor: 'rgba(37, 99, 235, 0.6)',
                        hoverBackgroundColor: 'rgba(37, 99, 235, 0.9)',
                        borderColor: '#1e40af',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            selectedYear = chart.data.labels[idx].toString();
                            updateTable(selectedYear);
                            // Clear previous AI text when switching years
                            document.getElementById('ai-response-box').classList.add('hidden');
                            document.getElementById('ai-status').innerText = "Year " + selectedYear + " selected. Click 'Run AI Analysis' for new insights.";
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            title: { display: true, text: 'Percentage (%)' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        renderChart();
        updateTable(selectedYear);
    });
</script>
{% endblock %}
