{% extends "base.html" %}

{% block title %}Positional White Ball Frequency Analysis{% endblock %}

{% block page_heading %}Positional White Ball Frequency Analysis{% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {# Flash messages display #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages space-y-3">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-md text-sm {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif category == 'info' %}bg-blue-100 text-blue-700 border border-blue-200{% else %}bg-green-100 text-green-700 border border-green-200{% endif %} animate-fade-in">
                        <p class="font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">White Ball Frequency by Position and Range</h2>
        <p class="text-gray-700 mb-6">Explore how often white balls appear in specific sorted positions (1st to 5th) within predefined number ranges, year-over-year. This analysis helps identify tendencies for numbers to appear early, in the middle, or late in the sorted sequence.</p>

        <div id="loadingIndicator" class="text-center text-blue-600 font-semibold py-4">
            <svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading positional analysis data...
        </div>

        <div id="analysisContent" class="space-y-8 hidden">
            <!-- Yearly positional data will be dynamically loaded here by JavaScript -->
        </div>
    </div>
</div>

<style>
    /* Basic styling for the details arrow */
    details > summary::-webkit-details-marker {
        display: none; /* Hide default marker */
    }
    details > summary {
        list-style: none; /* Remove default list style */
    }
    details[open] .details-arrow {
        transform: rotate(180deg); /* Rotate arrow when open */
    }
    .btn-secondary {
        @apply bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-300 transition duration-300 ease-in-out transform hover:scale-105;
    }
    .pattern-table-scroll {
        max-height: 400px; /* Limit height for scrollable tables */
        overflow-y: auto;
    }
    .hidden-row {
        display: none;
    }
    .ball-container {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        align-items: center;
    }
    .ball {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 30px;
        height: 30px;
        background-color: #60a5fa; /* Tailwind blue-400 */
        color: white;
        font-weight: bold;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const analysisContent = document.getElementById('analysisContent');

        // Configuration for ranges and positions (must match backend for accurate display)
        const POSITIONAL_ANALYSIS_CONFIG = {
            "1-10": { "range": [1, 10], "positions": [1] },
            "11-20": { "range": [11, 20], "positions": [2, 3] },
            "21-30": { "range": [21, 30], "positions": [1, 2, 3, 4, 5] },
            "31-40": { "range": [31, 40], "positions": [1, 2, 3, 4, 5] },
            "41-50": { "range": [41, 50], "positions": [1, 2, 3, 4, 5] },
            "51-60": { "range": [51, 60], "positions": [3, 4, 5] },
            "61-69": { "range": [61, 69], "positions": [3, 4, 5] },
        };

        // Function to render a single positional frequency table
        function renderPositionalTable(containerElement, data, rangeLabel, position, totalDraws) {
            const tableContainer = document.createElement('div');
            tableContainer.className = 'overflow-x-auto shadow-md rounded-lg pattern-table-scroll bg-white p-4';
            tableContainer.innerHTML = `
                <h4 class="text-md font-semibold mb-3 text-gray-700">Range: ${rangeLabel}, Position: ${position}st/nd/rd/th Ball</h4>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50 text-blue-700">
                        <tr>
                            <th class="py-2 px-3 text-left text-xs font-semibold">Ball Number</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold">Count</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold">Percentage</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be populated here -->
                    </tbody>
                </table>
            `;
            containerElement.appendChild(tableContainer);

            const tableBody = tableContainer.querySelector('tbody');

            if (data.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `<td colspan="3" class="px-3 py-2 text-sm text-gray-500 text-center">No data for this combination.</td>`;
                tableBody.appendChild(noDataRow);
                return;
            }

            // Sort data by count descending, then by ball number ascending
            data.sort((a, b) => {
                if (b.count !== a.count) return b.count - a.count;
                return a.ball_number - b.ball_number;
            });

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900"><span class="ball">${item.ball_number}</span></td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">${item.count}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">${item.percentage}%</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Main function to fetch and render all positional data
        async function fetchAndRenderPositionalData() {
            loadingIndicator.classList.remove('hidden');
            analysisContent.classList.add('hidden');

            try {
                const response = await fetch('/positional_analysis', {
                    method: 'GET',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const yearlyPositionalData = await response.json();

                analysisContent.innerHTML = ''; // Clear previous content

                if (yearlyPositionalData.length === 0) {
                    analysisContent.innerHTML = '<p class="text-gray-600 text-center py-8">No positional frequency data available.</p>';
                } else {
                    yearlyPositionalData.forEach(yearData => {
                        const yearDetails = document.createElement('details');
                        yearDetails.className = 'card p-6 bg-gray-50 rounded-xl shadow-sm border border-gray-100 mb-6';
                        yearDetails.setAttribute('open', ''); // Open by default for initial view

                        yearDetails.innerHTML = `
                            <summary class="text-xl font-bold mb-3 text-gray-800 cursor-pointer flex justify-between items-center">
                                Positional Analysis for ${yearData.year} (${yearData.total_draws} Draws)
                                <svg class="w-6 h-6 transform transition-transform duration-200 details-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </summary>
                            <div class="space-y-6 mt-4" id="yearContent-${yearData.year}">
                                <!-- Positional tables for this year will go here -->
                            </div>
                        `;
                        analysisContent.appendChild(yearDetails);

                        const yearContentDiv = document.getElementById(`yearContent-${yearData.year}`);
                        
                        // Group data by (range_label, position) for easier rendering
                        const groupedByRangePosition = {};
                        yearData.data.forEach(item => {
                            const key = `${item.range_label}-${item.position}`;
                            if (!groupedByRangePosition[key]) {
                                groupedByRangePosition[key] = {
                                    range_label: item.range_label,
                                    position: item.position,
                                    data: []
                                };
                            }
                            groupedByRangePosition[key].data.push({
                                ball_number: item.ball_number, // Ensure this field exists or adjust
                                count: item.count,
                                percentage: item.percentage
                            });
                        });

                        // Render each table based on config order
                        Object.keys(POSITIONAL_ANALYSIS_CONFIG).forEach(rangeLabel => {
                            POSITIONAL_ANALYSIS_CONFIG[rangeLabel].positions.forEach(position => {
                                const key = `${rangeLabel}-${position}`;
                                if (groupedByRangePosition[key]) {
                                    const sectionDiv = document.createElement('div');
                                    sectionDiv.className = 'bg-white p-5 rounded-lg border border-gray-200 shadow-sm';
                                    yearContentDiv.appendChild(sectionDiv);
                                    renderPositionalTable(sectionDiv, groupedByRangePosition[key].data, rangeLabel, position, yearData.total_draws);
                                }
                            });
                        });
                        
                        // Add event listener to the details element for arrow rotation
                        yearDetails.addEventListener('toggle', () => {
                            const arrow = yearDetails.querySelector('.details-arrow');
                            if (yearDetails.open) {
                                arrow.classList.add('rotate-180');
                            } else {
                                arrow.classList.remove('rotate-180');
                            }
                        });
                    });
                }
                analysisContent.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading positional frequency analysis:', error);
                showFlashMessage(`Failed to load positional frequency analysis: ${error.message}. Please try again.`, 'error');
                analysisContent.innerHTML = '<p class="text-red-600 text-center py-8">An error occurred while loading data. Please check console for details.</p>';
                analysisContent.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Initial fetch and render when the page loads
        fetchAndRenderPositionalData();

        // Helper function to show flash messages
        function showFlashMessage(message, category) {
            const flashMessagesDiv = document.querySelector('.flash-messages') || document.createElement('div');
            flashMessagesDiv.className = 'flash-messages space-y-3'; 
            if (!document.querySelector('.flash-messages')) {
                document.querySelector('.space-y-8.max-w-6xl.mx-auto.px-4.sm\\:px-6.lg\\:px-8.py-8').prepend(flashMessagesDiv);
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `p-4 rounded-lg shadow-md text-sm animate-fade-in ${
                category === 'error' ? 'bg-red-100 text-red-700 border border-red-200' :
                category === 'info' ? 'bg-blue-100 text-blue-700 border border-blue-200' :
                'bg-green-100 text-green-700 border border-green-200'
            }`;
            messageDiv.innerHTML = `<p class="font-medium">${message}</p>`;
            flashMessagesDiv.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000); 
        }
    });
</script>
{% endblock %}
