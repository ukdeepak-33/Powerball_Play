{% extends "base.html" %}

{% block title %}Yearly White Ball Trends{% endblock %}

{% block page_heading %}White Ball Frequency Trends Over Time{% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {# Flash messages display #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages space-y-3">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-md text-sm {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif category == 'info' %}bg-blue-100 text-blue-700 border border-blue-200{% else %}bg-green-100 text-green-700 border border-green-200{% endif %} animate-fade-in">
                        <p class="font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">White Ball Frequency by Period</h2>
        <p class="text-gray-700 mb-6">Explore the frequency of each white ball over different time periods. Select a period type (Year, Half-Year, Quarter) and a specific white ball number to visualize its trend. The table below provides detailed data, filterable by number ranges.</p>

        <div class="flex flex-col sm:flex-row sm:items-end space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
            <div class="flex-1">
                <label for="periodType" class="block text-gray-700 text-sm font-bold mb-2">Select Period Type:</label>
                <select id="periodType" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white border-gray-300">
                    <option value="year">Yearly</option>
                    <option value="half_year">Half-Yearly</option>
                    <option value="quarter">Quarterly</option>
                </select>
            </div>
            <div class="flex-1">
                <label for="whiteBallNumber" class="block text-gray-700 text-sm font-bold mb-2">Select White Ball Number for Chart (1-69):</label>
                <input type="number" id="whiteBallNumber" min="1" max="69" value="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white border-gray-300">
            </div>
            <div class="flex-1">
                <button id="fetchDataBtn" class="btn-primary w-full sm:w-auto">Show Trend & Data</button>
            </div>
        </div>

        <div id="chartContainer" class="relative h-96 mb-8">
            <canvas id="whiteBallFrequencyChart"></canvas>
            <div id="loadingIndicator" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden rounded-xl">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                <p class="ml-3 text-blue-700">Loading data...</p>
            </div>
        </div>

        {# New section for the data table with range filter #}
        <div id="dataTableContainer" class="mt-8">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Detailed Frequency Data Table</h3>
            <div class="flex flex-col sm:flex-row sm:items-end space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
                <div class="flex-1">
                    <label for="numberRangeSelect" class="block text-gray-700 text-sm font-bold mb-2">Select Number Range for Table:</label>
                    <select id="numberRangeSelect" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white border-gray-300">
                        <option value="all">All White Balls (1-69)</option>
                        <option value="1-10">1-10</option>
                        <option value="11-20">11-20</option>
                        <option value="21-30">21-30</option>
                        <option value="31-40">31-40</option>
                        <option value="41-50">41-50</option>
                        <option value="51-60">51-60</option>
                        <option value="61-69">61-69</option>
                    </select>
                </div>
                <div class="flex-1">
                    <button id="applyTableFilterBtn" class="btn-primary w-full sm:w-auto">Apply Table Filter</button>
                </div>
            </div>

            <div class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-100 text-blue-800">
                        <tr id="tableHeaderRow">
                            <th class="py-3 px-4 text-left text-sm font-semibold">White Ball</th>
                            {# Period headers will be dynamically added here #}
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-200">
                        {# Table rows will be dynamically added here #}
                        <tr><td colspan="2" class="py-4 px-4 text-center text-gray-600">Select a white ball and period to view data.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const periodTypeSelect = document.getElementById('periodType');
        const whiteBallNumberInput = document.getElementById('whiteBallNumber');
        const fetchDataBtn = document.getElementById('fetchDataBtn');
        const chartCanvas = document.getElementById('whiteBallFrequencyChart');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const chartCtx = chartCanvas.getContext('2d');
        let whiteBallFrequencyChart;

        const tableHeaderRow = document.getElementById('tableHeaderRow');
        const tableBody = document.getElementById('tableBody');
        const numberRangeSelect = document.getElementById('numberRangeSelect'); // New dropdown
        const applyTableFilterBtn = document.getElementById('applyTableFilterBtn'); // New button

        let cachedAllWhiteBallData = {}; // Cache for the full dataset once fetched
        let cachedAllPeriodsLabels = []; // Cache for all period labels once fetched

        // Function to get background color based on period label for chart bars
        function getChartBackgroundColorForPeriod(periodLabel) {
            let baseColor = 'rgba(59, 130, 246, 0.8)'; // blue-500

            if (periodLabel.includes('H')) {
                if (periodLabel.endsWith('H1')) {
                    baseColor = 'rgba(147, 197, 253, 0.8)'; // light blue-300
                } else if (periodLabel.endsWith('H2')) {
                    baseColor = 'rgba(110, 231, 183, 0.8)'; // light green-300
                }
            } else if (periodLabel.includes('Q')) {
                if (periodLabel.endsWith('Q1')) {
                    baseColor = 'rgba(147, 197, 253, 0.8)'; // light blue-300
                } else if (periodLabel.endsWith('Q2')) {
                    baseColor = 'rgba(110, 231, 183, 0.8)'; // light green-300
                } else if (periodLabel.endsWith('Q3')) {
                    baseColor = 'rgba(253, 224, 71, 0.8)'; // light yellow-300
                } else if (periodLabel.endsWith('Q4')) {
                    baseColor = 'rgba(252, 165, 165, 0.8)'; // light red-300
                }
            }
            return baseColor;
        }

        // Function to get Tailwind CSS class for table row/cell background
        function getTableBgClassForPeriod(periodLabel) {
            if (periodLabel.includes('H')) {
                if (periodLabel.endsWith('H1')) {
                    return 'bg-blue-50';
                } else if (periodLabel.endsWith('H2')) {
                    return 'bg-green-50';
                }
            } else if (periodLabel.includes('Q')) {
                if (periodLabel.endsWith('Q1')) {
                    return 'bg-blue-50';
                } else if (periodLabel.endsWith('Q2')) {
                    return 'bg-green-50';
                } else if (periodLabel.endsWith('Q3')) {
                    return 'bg-yellow-50';
                } else if (periodLabel.endsWith('Q4')) {
                    return 'bg-red-50';
                }
            }
            return ''; // No special background for yearly or if no match
        }


        async function fetchAndRenderData() {
            loadingIndicator.classList.remove('hidden');
            const periodType = periodTypeSelect.value;
            const selectedWhiteBallNumber = parseInt(whiteBallNumberInput.value);

            if (selectedWhiteBallNumber < 1 || selectedWhiteBallNumber > 69) {
                alert('Please enter a white ball number between 1 and 69 for the chart.');
                loadingIndicator.classList.add('hidden');
                return;
            }

            try {
                // Fetch ALL white ball data for the selected period type
                const response = await fetch(`/api/white_ball_trends?period=${periodType}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                cachedAllPeriodsLabels = data.period_labels;
                cachedAllWhiteBallData = data.data; // Cache the full dataset

                // --- Render Chart (unchanged logic) ---
                const whiteBallDataForChart = cachedAllWhiteBallData[selectedWhiteBallNumber];

                if (!whiteBallDataForChart) {
                    // This scenario means no data at all for this number/period, not just that it wasn't drawn
                    // alert(`No data found for white ball ${selectedWhiteBallNumber} for the selected period type.`);
                    if (whiteBallFrequencyChart) {
                        whiteBallFrequencyChart.destroy();
                    }
                    // Do not clear the table here, it will be rendered based on its own filter
                    // tableBody.innerHTML = '<tr><td colspan="2" class="py-4 px-4 text-center text-gray-600">No data available for selected white ball and period.</td></tr>';
                    // loadingIndicator.classList.add('hidden');
                    // return; // Don't return, as table might still render data for other numbers
                }

                const frequencies = cachedAllPeriodsLabels.map(label => {
                    const found = whiteBallDataForChart ? whiteBallDataForChart.find(item => item.period_label === label) : null;
                    return found ? found.frequency : 0;
                });

                const chartBackgroundColors = cachedAllPeriodsLabels.map(label => getChartBackgroundColorForPeriod(label));

                if (whiteBallFrequencyChart) {
                    whiteBallFrequencyChart.destroy();
                }

                whiteBallFrequencyChart = new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels: cachedAllPeriodsLabels,
                        datasets: [{
                            label: `Frequency of White Ball ${selectedWhiteBallNumber}`,
                            data: frequencies,
                            backgroundColor: chartBackgroundColors,
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 1,
                            borderRadius: 8,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `Frequency of White Ball ${selectedWhiteBallNumber} by ${periodType.replace('_', '-')}`,
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                color: '#374151'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        return `${label}: ${context.raw} times`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Period',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    color: '#4b5563'
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Frequency',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    color: '#4b5563'
                                },
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });

                // --- Render Table based on the *cached* data and *current* table filter ---
                renderTable();

            } catch (error) {
                console.error('Error fetching or rendering data:', error);
                alert('Failed to load data. Please try again later.');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // New function to determine the range of numbers for the table
        function getNumbersForTableRange() {
            const selectedRange = numberRangeSelect.value;
            let startNum = 1;
            let endNum = 69;

            if (selectedRange !== 'all') {
                const rangeParts = selectedRange.split('-');
                startNum = parseInt(rangeParts[0]);
                endNum = parseInt(rangeParts[1]);
            }
            return { start: startNum, end: endNum };
        }

        // Modified renderTable function to use the new number range filter
        function renderTable() {
            // Clear previous table content
            tableHeaderRow.innerHTML = '<th class="py-3 px-4 text-left text-sm font-semibold">White Ball</th>';
            tableBody.innerHTML = '';

            // Add period headers to the table
            cachedAllPeriodsLabels.forEach(label => {
                const th = document.createElement('th');
                th.className = 'py-3 px-4 text-left text-sm font-semibold';
                th.textContent = label;
                tableHeaderRow.appendChild(th);
            });

            const { start, end } = getNumbersForTableRange();

            let hasDataInSelectedRange = false;

            // Iterate through white balls based on the selected range
            for (let wbNum = start; wbNum <= end; wbNum++) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50'; // Default hover state

                const wbCell = document.createElement('td');
                wbCell.className = 'py-3 px-4 text-sm text-gray-700 font-bold';
                wbCell.textContent = wbNum;
                row.appendChild(wbCell);

                // Get frequency data for the current white ball from the cached data
                const currentWbData = cachedAllWhiteBallData[wbNum] || [];
                const currentWbDataMap = new Map(currentWbData.map(item => [item.period_label, item.frequency]));

                let rowHasData = false;
                cachedAllPeriodsLabels.forEach(label => {
                    const cell = document.createElement('td');
                    cell.className = 'py-3 px-4 text-sm text-gray-700';
                    const freq = currentWbDataMap.get(label) || 0;
                    cell.textContent = freq; // Display frequency or 0 if not found
                    if (freq > 0) {
                        rowHasData = true; // Mark if this row actually has data
                    }
                    
                    // Apply background color class to the cell
                    const bgClass = getTableBgClassForPeriod(label);
                    if (bgClass) {
                        cell.classList.add(bgClass);
                    }
                    row.appendChild(cell);
                });
                if (rowHasData) { // Only append rows that have data or are within the selected range
                    tableBody.appendChild(row);
                    hasDataInSelectedRange = true;
                }
            }

            if (!hasDataInSelectedRange && cachedAllPeriodsLabels.length > 0) {
                 tableBody.innerHTML = `<tr><td colspan="${cachedAllPeriodsLabels.length + 1}" class="py-4 px-4 text-center text-gray-600">No data found in the selected range for the current period type.</td></tr>`;
            } else if (cachedAllPeriodsLabels.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="2" class="py-4 px-4 text-center text-gray-600">No detailed frequency data available.</td></tr>`;
            }
        }

        fetchDataBtn.addEventListener('click', fetchAndRenderData);
        periodTypeSelect.addEventListener('change', fetchAndRenderData); // Re-render everything when period type changes

        // New event listener for the table filter button
        applyTableFilterBtn.addEventListener('click', renderTable); // Only re-render table when its filter changes

        // Initial fetch and render when the page loads
        fetchAndRenderData();
    });
</script>
{% endblock %}
