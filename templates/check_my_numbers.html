{% extends "base.html" %}
{% block title %}Check My Numbers{% endblock %}
{% block page_heading %}Check My Numbers{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">

    <!-- Subtitle -->
    <p class="text-gray-500 text-sm mb-6">
        Match your picks against official Powerball draws from 2010 to 2026.
    </p>

    <!-- Mode Tabs -->
    <div class="flex space-x-2 mb-6">
        <button id="tab-manual"
            onclick="switchMode('manual')"
            class="px-5 py-2 rounded-full text-sm font-semibold bg-blue-600 text-white transition duration-200">
            Manual Check
        </button>
        <button id="tab-saved"
            onclick="switchMode('saved')"
            class="px-5 py-2 rounded-full text-sm font-semibold bg-white text-gray-600 border border-gray-300 hover:border-blue-400 hover:text-blue-600 transition duration-200">
            Saved Picks
        </button>
    </div>

    <!-- ===================== MANUAL MODE ===================== -->
    <div id="panel-manual">

        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Enter Your Numbers</h2>

            <!-- Number Inputs -->
            <div class="flex flex-wrap items-end gap-3 mb-5">
                <div class="flex flex-col items-center gap-1">
                    <span class="text-xs text-gray-400 font-medium">Ball 1</span>
                    <input type="number" id="wb1" min="1" max="69" placeholder="â€“"
                        class="wb-input w-14 h-14 text-center text-xl font-bold border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 text-gray-800 transition">
                </div>
                <div class="flex flex-col items-center gap-1">
                    <span class="text-xs text-gray-400 font-medium">Ball 2</span>
                    <input type="number" id="wb2" min="1" max="69" placeholder="â€“"
                        class="wb-input w-14 h-14 text-center text-xl font-bold border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 text-gray-800 transition">
                </div>
                <div class="flex flex-col items-center gap-1">
                    <span class="text-xs text-gray-400 font-medium">Ball 3</span>
                    <input type="number" id="wb3" min="1" max="69" placeholder="â€“"
                        class="wb-input w-14 h-14 text-center text-xl font-bold border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 text-gray-800 transition">
                </div>
                <div class="flex flex-col items-center gap-1">
                    <span class="text-xs text-gray-400 font-medium">Ball 4</span>
                    <input type="number" id="wb4" min="1" max="69" placeholder="â€“"
                        class="wb-input w-14 h-14 text-center text-xl font-bold border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 text-gray-800 transition">
                </div>
                <div class="flex flex-col items-center gap-1">
                    <span class="text-xs text-gray-400 font-medium">Ball 5</span>
                    <input type="number" id="wb5" min="1" max="69" placeholder="â€“"
                        class="wb-input w-14 h-14 text-center text-xl font-bold border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 text-gray-800 transition">
                </div>

                <div class="flex flex-col items-center justify-end pb-2">
                    <span class="text-2xl font-bold text-gray-300">+</span>
                </div>

                <div class="flex flex-col items-center gap-1">
                    <span class="text-xs text-red-400 font-medium">Powerball</span>
                    <input type="number" id="pb" min="1" max="39" placeholder="â€“"
                        class="w-14 h-14 text-center text-xl font-bold border-2 border-red-300 rounded-xl focus:outline-none focus:border-red-500 text-red-500 transition">
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex items-center gap-3 flex-wrap">
                <button onclick="checkManual()" id="btn-check"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2.5 rounded-lg transition duration-200">
                    Check Numbers
                </button>
                <button onclick="clearManual()"
                    class="bg-gray-100 hover:bg-gray-200 text-gray-600 font-semibold px-6 py-2.5 rounded-lg transition duration-200">
                    Clear
                </button>
            </div>

            <!-- Loading -->
            <div id="loading-check" class="hidden mt-4 flex items-center gap-2 text-sm text-gray-400">
                <svg class="animate-spin h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                </svg>
                Checking against all draws...
            </div>

            <!-- Error -->
            <div id="error-manual" class="hidden mt-4 p-3 bg-red-50 border border-red-200 text-red-600 rounded-lg text-sm"></div>
        </div>

        <!-- Manual Results -->
        <div id="manual-results" class="hidden">
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-5">
                <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Draws Checked</p>
                    <p id="stat-total" class="text-3xl font-extrabold text-gray-800">â€“</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Draws Matched</p>
                    <p id="stat-matched" class="text-3xl font-extrabold text-blue-600">â€“</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 col-span-2 sm:col-span-1">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Your Numbers</p>
                    <p id="stat-numbers" class="text-sm font-semibold text-gray-700 mt-1">â€“</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="px-5 py-3 border-b border-gray-100 flex items-center justify-between">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Matching Draws</span>
                    <span class="text-xs text-gray-400">Sorted by best match</span>
                </div>
                <div id="manual-results-list" class="divide-y divide-gray-50"></div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="manual-empty" class="hidden bg-white rounded-xl shadow-md p-12 text-center">
            <div class="text-5xl mb-4">ðŸŽ±</div>
            <p class="text-gray-500">No draws found with 2 or more matching numbers.<br>Try different numbers.</p>
        </div>
    </div>

    <!-- ===================== SAVED PICKS MODE ===================== -->
    <div id="panel-saved" class="hidden">

        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Check All Saved Picks</h2>
            <p class="text-sm text-gray-500 mb-5">
                Checks every pick you've saved against all official draws. Only picks with 2+ matches are shown.
            </p>
            <button onclick="checkSaved()" id="btn-saved"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2.5 rounded-lg transition duration-200">
                Run Check
            </button>

            <!-- Loading -->
            <div id="loading-saved" class="hidden mt-4 flex items-center gap-2 text-sm text-gray-400">
                <svg class="animate-spin h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                </svg>
                Checking all saved picks â€” this may take a moment...
            </div>

            <!-- Error -->
            <div id="error-saved" class="hidden mt-4 p-3 bg-red-50 border border-red-200 text-red-600 rounded-lg text-sm"></div>
        </div>

        <!-- Saved Results -->
        <div id="saved-results" class="hidden">
            <div class="grid grid-cols-3 gap-4 mb-5">
                <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Picks Checked</p>
                    <p id="stat-picks-total" class="text-3xl font-extrabold text-gray-800">â€“</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Picks Matched</p>
                    <p id="stat-picks-matched" class="text-3xl font-extrabold text-blue-600">â€“</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Draws Checked</p>
                    <p id="stat-draws-checked" class="text-3xl font-extrabold text-gray-800">â€“</p>
                </div>
            </div>
            <div id="saved-results-list" class="space-y-3"></div>
        </div>

        <!-- Empty State -->
        <div id="saved-empty" class="hidden bg-white rounded-xl shadow-md p-12 text-center">
            <div class="text-5xl mb-4">ðŸ“­</div>
            <p class="text-gray-500">None of your saved picks matched 2+ numbers in any draw.<br>Keep generating!</p>
        </div>
    </div>

</div>
{% endblock %}


{% block scripts %}
{{ super() }}
<script>

    // â”€â”€ Match badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function matchBadge(whiteMatches, pbMatch) {
        const pb = pbMatch ? ' + PB âš¡' : '';
        let cls = 'bg-green-100 text-green-700 border-green-300';
        if (whiteMatches >= 5)      cls = 'bg-red-100 text-red-700 border-red-300';
        else if (whiteMatches >= 4) cls = 'bg-purple-100 text-purple-700 border-purple-300';
        else if (whiteMatches >= 3) cls = 'bg-blue-100 text-blue-700 border-blue-300';
        return `<span class="text-xs font-semibold px-3 py-1 rounded-full border ${cls} whitespace-nowrap">
                    ${whiteMatches} match${whiteMatches !== 1 ? 'es' : ''}${pb}
                </span>`;
    }

    // â”€â”€ Render balls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderBalls(officialNumbers, officialPb, checkedNumbers, checkedPb) {
        const checkedSet = new Set(checkedNumbers);
        let html = '<div class="flex flex-wrap gap-1.5 items-center">';
        officialNumbers.forEach(n => {
            const matched = checkedSet.has(n);
            html += `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-bold border
                        ${matched ? 'bg-blue-500 text-white border-blue-600' : 'bg-gray-100 text-gray-500 border-gray-200'}">${n}</span>`;
        });
        const pbMatched = officialPb === checkedPb;
        html += `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-bold border ml-1
                    ${pbMatched ? 'bg-red-500 text-white border-red-600' : 'bg-red-50 text-red-400 border-red-200'}">${officialPb}</span>`;
        html += '</div>';
        return html;
    }

    // â”€â”€ Mode switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function switchMode(mode) {
        const isManual = mode === 'manual';
        document.getElementById('panel-manual').classList.toggle('hidden', !isManual);
        document.getElementById('panel-saved').classList.toggle('hidden', isManual);

        const tabManual = document.getElementById('tab-manual');
        const tabSaved  = document.getElementById('tab-saved');

        if (isManual) {
            tabManual.className = 'px-5 py-2 rounded-full text-sm font-semibold bg-blue-600 text-white transition duration-200';
            tabSaved.className  = 'px-5 py-2 rounded-full text-sm font-semibold bg-white text-gray-600 border border-gray-300 hover:border-blue-400 hover:text-blue-600 transition duration-200';
        } else {
            tabSaved.className  = 'px-5 py-2 rounded-full text-sm font-semibold bg-blue-600 text-white transition duration-200';
            tabManual.className = 'px-5 py-2 rounded-full text-sm font-semibold bg-white text-gray-600 border border-gray-300 hover:border-blue-400 hover:text-blue-600 transition duration-200';
        }
    }

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showError(id, msg) {
        const el = document.getElementById('error-' + id);
        el.textContent = msg;
        el.classList.remove('hidden');
    }
    function hideError(id) {
        document.getElementById('error-' + id).classList.add('hidden');
    }
    function setLoading(id, on) {
        document.getElementById('loading-' + id).classList.toggle('hidden', !on);
        document.getElementById('btn-' + id).disabled = on;
    }

    // â”€â”€ Manual Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function clearManual() {
        ['wb1','wb2','wb3','wb4','wb5','pb'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('manual-results').classList.add('hidden');
        document.getElementById('manual-empty').classList.add('hidden');
        hideError('manual');
    }

    async function checkManual() {
        hideError('manual');
        document.getElementById('manual-results').classList.add('hidden');
        document.getElementById('manual-empty').classList.add('hidden');

        const white_balls = ['wb1','wb2','wb3','wb4','wb5'].map(id => parseInt(document.getElementById(id).value));
        const powerball   = parseInt(document.getElementById('pb').value);

        if (white_balls.some(isNaN) || isNaN(powerball)) {
            showError('manual', 'Please fill in all 5 white balls and the Powerball.');
            return;
        }

        setLoading('check', true);
        try {
            const res  = await fetch('/api/check-numbers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ white_balls, powerball })
            });
            const data = await res.json();

            if (!res.ok || data.error) {
                showError('manual', data.error || 'Something went wrong.');
                return;
            }

            if (data.matches_found === 0) {
                document.getElementById('manual-empty').classList.remove('hidden');
                return;
            }

            document.getElementById('stat-total').textContent   = data.total_draws_checked.toLocaleString();
            document.getElementById('stat-matched').textContent = data.matches_found;
            document.getElementById('stat-numbers').textContent =
                data.checked_numbers.join(' Â· ') + '  PB ' + data.checked_powerball;

            document.getElementById('manual-results-list').innerHTML = data.results.map(r => `
                <div class="flex flex-wrap items-center gap-3 px-5 py-3 hover:bg-gray-50 transition">
                    <span class="text-xs font-mono text-gray-400 w-24 shrink-0">${r.draw_date}</span>
                    ${renderBalls(r.official_numbers, r.official_powerball, data.checked_numbers, data.checked_powerball)}
                    ${matchBadge(r.white_matches, r.powerball_match)}
                </div>
            `).join('');

            document.getElementById('manual-results').classList.remove('hidden');

        } catch (e) {
            showError('manual', 'Network error. Please try again.');
        } finally {
            setLoading('check', false);
        }
    }

    // â”€â”€ Saved Picks Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function checkSaved() {
        hideError('saved');
        document.getElementById('saved-results').classList.add('hidden');
        document.getElementById('saved-empty').classList.add('hidden');

        setLoading('saved', true);
        try {
            const res  = await fetch('/api/check-saved-picks');
            const data = await res.json();

            if (!res.ok || data.error) {
                showError('saved', data.error || 'Something went wrong.');
                return;
            }

            if (data.picks_with_matches === 0) {
                document.getElementById('saved-empty').classList.remove('hidden');
                return;
            }

            document.getElementById('stat-picks-total').textContent   = data.total_picks_checked;
            document.getElementById('stat-picks-matched').textContent = data.picks_with_matches;
            document.getElementById('stat-draws-checked').textContent = data.total_draws_checked.toLocaleString();

            document.getElementById('saved-results-list').innerHTML = data.results.map((pick, i) => `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div onclick="togglePick(${i})"
                        class="flex flex-wrap items-center justify-between gap-3 px-5 py-4 cursor-pointer hover:bg-gray-50 transition">
                        <div class="flex flex-wrap gap-1.5 items-center">
                            ${pick.white_balls.map(n =>
                                `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-bold bg-gray-100 text-gray-700 border border-gray-200">${n}</span>`
                            ).join('')}
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-bold bg-red-50 text-red-500 border border-red-200 ml-1">${pick.powerball}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-xs text-gray-400 font-mono">Saved ${pick.generated_date}</span>
                            <span class="text-xs font-semibold px-3 py-1 rounded-full bg-blue-50 text-blue-600 border border-blue-200">
                                ${pick.match_count} draw${pick.match_count !== 1 ? 's' : ''} matched
                            </span>
                            <svg id="chevron-${i}" class="w-4 h-4 text-gray-400 transition-transform duration-200"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                    <div id="pick-results-${i}" class="hidden divide-y divide-gray-50 border-t border-gray-100">
                        ${pick.matches.map(r => `
                            <div class="flex flex-wrap items-center gap-3 px-5 py-3 hover:bg-gray-50 transition">
                                <span class="text-xs font-mono text-gray-400 w-24 shrink-0">${r.draw_date}</span>
                                ${renderBalls(r.official_numbers, r.official_powerball, pick.white_balls, pick.powerball)}
                                ${matchBadge(r.white_matches, r.powerball_match)}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            document.getElementById('saved-results').classList.remove('hidden');

        } catch (e) {
            showError('saved', 'Network error. Please try again.');
        } finally {
            setLoading('saved', false);
        }
    }

    // â”€â”€ Toggle accordion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function togglePick(i) {
        const results = document.getElementById('pick-results-' + i);
        const chevron = document.getElementById('chevron-' + i);
        const isOpen  = !results.classList.contains('hidden');
        results.classList.toggle('hidden', isOpen);
        chevron.style.transform = isOpen ? '' : 'rotate(180deg)';
    }

    // â”€â”€ Auto-advance inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll('.wb-input').forEach((input, idx, all) => {
        input.addEventListener('input', () => {
            if (input.value.length >= 2) {
                const next = all[idx + 1] || document.getElementById('pb');
                if (next) next.focus();
            }
        });
    });

</script>
{% endblock %}
