{% extends "base.html" %}

{% block title %}Custom Powerball Combinations{% endblock %}

{% block page_heading %}Build Your Custom Powerball Combinations{% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {# Flash messages display (re-using base.html's logic) #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages space-y-3">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-md text-sm {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif category == 'info' %}bg-blue-100 text-blue-700 border border-blue-200{% else %}bg-green-100 text-green-700 border border-green-200{% endif %} animate-fade-in">
                        <p class="font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Step 1: Select Your Combination Pool</h2>
        <p class="text-gray-700 mb-6">Click on numbers below to add them to your custom selection pool. You can mix and match from different categories, or select from all numbers.</p>

        {# Tabs for different selection methods #}
        <div class="mb-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button type="button" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 ease-in-out text-blue-600 border-blue-600" data-tab="monthly_trends">Monthly Trends</button>
                    <button type="button" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 ease-in-out border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="all_numbers">All Numbers (1-69)</button>
                </nav>
            </div>
        </div>

        {# Tab Content - Monthly Trends #}
        <div id="monthly_trends_tab" class="tab-content active space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                {# Current Month Trends #}
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Current Month ({{ current_month_name }})</h3>
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
                            <h4 class="text-lg font-medium mb-2 text-gray-700">Unpicked Numbers:</h4>
                            {% if current_month_unpicked %}
                                <div class="flex flex-wrap gap-2">
                                    {% for num in current_month_unpicked %}
                                        <span class="number-ball unpicked-ball" data-number="{{ num }}">{{ num }}</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-gray-600 text-sm">No unpicked numbers found for this month (or no draws yet).</p>
                            {% endif %}
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
                            <h4 class="text-lg font-medium mb-2 text-gray-700">Most Picked Numbers (>1 time):</h4>
                            {% if current_month_most_picked %}
                                <div class="flex flex-wrap gap-2">
                                    {% for item in current_month_most_picked %}
                                        <span class="number-ball most-picked-ball" data-number="{{ item.number }}">{{ item.number }} ({{ item.count }})</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-gray-600 text-sm">No numbers picked more than once this month yet.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {# Previous Month Trends #}
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Previous Month ({{ previous_month_name }})</h3>
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
                            <h4 class="text-lg font-medium mb-2 text-gray-700">Unpicked Numbers:</h4>
                            {% if previous_month_unpicked %}
                                <div class="flex flex-wrap gap-2">
                                    {% for num in previous_month_unpicked %}
                                        <span class="number-ball unpicked-ball" data-number="{{ num }}">{{ num }}</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-gray-600 text-sm">No unpicked numbers found for previous month.</p>
                            {% endif %}
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
                            <h4 class="text-lg font-medium mb-2 text-gray-700">Most Picked Numbers (>1 time):</h4>
                            {% if previous_month_most_picked %}
                                <div class="flex flex-wrap gap-2">
                                    {% for item in previous_month_most_picked %}
                                        <span class="number-ball most-picked-ball" data-number="{{ item.number }}">{{ item.number }} ({{ item.count }})</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-gray-600 text-sm">No numbers picked more than once previous month.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Tab Content - All Numbers #}
        <div id="all_numbers_tab" class="tab-content hidden">
            <h3 class="text-xl font-semibold mb-3 text-gray-800">Select from All White Balls (1-69)</h3>
            <div class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-12 gap-2 mb-6" id="allNumberGrid">
                {% for i in range(1, 70) %}
                    <div class="number-ball flex items-center justify-center w-10 h-10 bg-gray-200 text-gray-800 rounded-full font-bold cursor-pointer hover:bg-blue-400 hover:text-white transition duration-200 ease-in-out text-base" data-number="{{ i }}">
                        {{ i }}
                    </div>
                {% endfor %}
            </div>
        </div>


        <div class="border-t border-gray-200 pt-6 mt-8">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Your Selected Pool:</h3>
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <input type="text" id="manualNumbers" placeholder="Add numbers manually (e.g., 5,12,30)" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700">
                <button id="addManualBtn" class="btn btn-primary bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-200 ease-in-out whitespace-nowrap">Add Manually</button>
                <button id="clearSelectedBtn" class="btn bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700 transition duration-200 ease-in-out whitespace-nowrap">Clear All</button>
            </div>

            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200 text-blue-800 flex items-center flex-wrap gap-2 mb-6" id="selectedNumbersDisplay">
                <span class="font-semibold mr-2">Numbers in your pool (<span id="selectedNumbersCount">0</span>):</span>
                <span id="selectedNumbersList" class="flex flex-wrap gap-1">No numbers selected</span>
            </div>
        </div>
    </div>

    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Step 2: Generate Picks from Your Pool</h2>
        <form id="generateForm" class="space-y-4">
            <div>
                <label for="numSetsToGenerate" class="block text-sm font-medium text-gray-700 mb-1">Number of Sets to Generate (1-10):</label>
                <input type="number" id="numSetsToGenerate" name="num_sets_to_generate" min="1" max="10" value="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700">
            </div>

            <div>
                <label for="excludedNumbers" class="block text-sm font-medium text-gray-700 mb-1">Numbers to Exclude from Generation (comma-separated):</label>
                <input type="text" id="excludedNumbers" name="excluded_numbers" placeholder="e.g., 7, 14, 21" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700">
                <p class="mt-1 text-sm text-gray-500">These numbers will *not* appear in the generated picks, even if they are in your selected pool.</p>
            </div>

            <div>
                <label for="powerballOverride" class="block text-sm font-medium text-gray-700 mb-1">Specific Powerball (Optional, 1-26):</label>
                <input type="number" id="powerballOverride" name="powerball_override" min="1" max="26" placeholder="Leave blank for random Powerball" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700">
                <p class="mt-1 text-sm text-gray-500">If specified, all generated sets will use this Powerball number.</p>
            </div>

            <button type="submit" id="generatePicksBtn" class="btn btn-accent bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-200 ease-in-out w-full font-semibold text-lg shadow-md">
                Generate Custom Picks
            </button>
            <div id="loadingIndicator" class="hidden text-center text-blue-600 font-medium mt-4">
                <img src="https://placehold.co/40x40/blue/white?text=..." alt="Loading" class="inline-block animate-spin mr-2"> Generating picks...
            </div>
        </form>
    </div>

    {# Results Display Section - For Generated Picks #}
    <div id="generatedResultsSection" class="hidden card p-6 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-xl text-white">
        <h2 class="text-3xl font-extrabold mb-6 text-center">Generated Custom Picks</h2>
        <div id="generatedPicksContainer" class="space-y-5">
            {# Generated picks will be inserted here by JavaScript #}
        </div>
        <div class="flex justify-center mt-8 space-x-4" id="saveAllCustomPicksActions">
            <button id="saveAllCustomPicksBtn" class="btn bg-indigo-700 text-white px-6 py-3 rounded-lg hover:bg-indigo-800 transition duration-200 ease-in-out font-semibold text-lg shadow-lg">
                Save All Generated Picks
            </button>
        </div>
    </div>

    {# NEW SECTION FOR PHASE 3: CREATE COMBINATIONS #}
    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Step 3: Create Combinations from a Custom Pool</h2>
        <p class="text-gray-700 mb-6">Enter a comma-separated list of numbers to form your combination pool. Then, specify how many numbers should be in each combination (e.g., '3' for triplets). All possible unique combinations will be generated.</p>

        <div class="space-y-4">
            <div>
                <label for="combinationPoolInput" class="block text-sm font-medium text-gray-700 mb-1">Numbers for Combination Pool (e.g., 1,2,3,4,5,6,7,8,9,10):</label>
                <textarea id="combinationPoolInput" rows="3" placeholder="Enter numbers separated by commas (e.g., 1, 5, 10, 22, 35, 48)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700"></textarea>
                <p class="mt-1 text-sm text-gray-500">Tip: Copy numbers from your "Selected Pool" (Step 1) or "Generated Picks" (Step 2) above!</p>
            </div>
            <div>
                <label for="numbersPerCombination" class="block text-sm font-medium text-gray-700 mb-1">Numbers per Combination (e.g., 3 for triplets, 5 for full picks):</label>
                <input type="number" id="numbersPerCombination" min="1" max="10" value="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700">
            </div>

            <button type="button" id="generateCombinationsBtn" class="btn btn-success bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition duration-200 ease-in-out w-full font-semibold text-lg shadow-md">
                Generate All Combinations
            </button>
            <div id="combinationsLoadingIndicator" class="hidden text-center text-purple-600 font-medium mt-4">
                <img src="https://placehold.co/40x40/purple/white?text=..." alt="Loading" class="inline-block animate-spin mr-2"> Generating combinations...
            </div>
        </div>

        {# Results Display Section - For Combinations #}
        <div id="generatedCombinationsSection" class="hidden card p-6 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl shadow-xl text-white mt-8">
            <h3 class="text-2xl font-extrabold mb-6 text-center">Generated Combinations (<span id="combinationsCount">0</span>)</h3>
            <div id="generatedCombinationsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {# Generated combinations will be inserted here by JavaScript #}
            </div>
            <div class="flex justify-center mt-6">
                <button id="copyCombinationsBtn" class="btn bg-gray-700 text-white px-5 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out font-semibold text-md">Copy All to Clipboard</button>
            </div>
        </div>
    </div>

</div>

{# Analysis Modal Structure (Copied from index.html for consistency) #}
<div id="analysisModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300 ease-in-out opacity-0">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full transform transition-transform duration-300 ease-out scale-95 opacity-0" id="analysisModalContent">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-900">Pick Analysis: <span id="analyzedPickDisplay" class="text-blue-700"></span></h3>
            <button id="closeAnalysisModalBtn" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="analysisResultsContent" class="space-y-4 text-gray-700">
            {# Analysis results will be loaded here #}
        </div>
        <div class="mt-6 flex justify-end">
            <button id="saveAnalyzedPickBtn" class="btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 ease-in-out">
                Save This Pick
            </button>
        </div>
    </div>
</div>

<style>
    /* Custom styles for number balls */
    .number-ball {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1.1rem;
        font-weight: bold;
        color: white; /* Default text color for number balls in trends */
        background-color: #6B7280; /* Gray-500 default */
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease-in-out, background-color 0.2s ease-in-out;
    }
    .number-ball:hover {
        transform: translateY(-2px);
    }
    .number-ball.selected {
        background-color: #2563EB; /* Blue-600 for selected numbers */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transform: scale(1.05);
    }
    /* Specific styles for trend balls */
    .unpicked-ball {
        background-color: #9CA3AF; /* Light Gray */
        color: #374151; /* Darker text for better contrast */
    }
    .most-picked-ball {
        background-color: #FBBF24; /* Amber-400 */
        color: #374151; /* Darker text for visibility */
    }

    /* Styles for the balls in the "Your Selected Pool" display */
    .selected-display-ball {
        background-color: #2563EB; /* Blue-600 */
        color: white;
        width: 36px; /* Slightly smaller for the display list */
        height: 36px;
        font-size: 1rem;
        margin: 2px; /* Small margin for tight packing */
        flex-shrink: 0;
    }

    /* Ball display styles (for generated picks, similar to index.html for consistency) */
    .generated-ball {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 50px;
        height: 50px;
        background-color: #f0f0f0;
        border-radius: 50%;
        border: 2px solid #ccc;
        font-weight: bold;
        color: #333;
        margin: 5px;
        font-size: 1.2em;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        flex-shrink: 0;
    }
    .generated-powerball {
        background-color: #ef4444; /* Red */
        color: white;
        border-color: #dc2626;
    }
    /* Styles for generated combinations */
    .combination-item {
        background-color: rgba(255, 255, 255, 0.1); /* Slightly transparent white */
        border-radius: 12px;
        padding: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        color: white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .combination-number-ball {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 38px;
        height: 38px;
        background-color: #9333ea; /* Purple-600 */
        color: white;
        border-radius: 50%;
        font-size: 1em;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        flex-shrink: 0;
    }


    /* Custom Toast Popup (Flash Message) */
    .toast-popup {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 0.95em;
        color: white;
        opacity: 0;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 250px;
        text-align: center;
    }
    .toast-popup.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-10px); /* Slight lift */
    }
    .toast-popup.animate-fade-out {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
    }
    .toast-popup.info { background-color: #3b82f6; } /* blue-500 */
    .toast-popup.success { background-color: #10b981; } /* emerald-500 */
    .toast-popup.error { background-color: #ef4444; } /* red-500 */
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectedNumbers = new Set(); // Use a Set to store unique selected numbers
        const selectedNumbersDisplay = document.getElementById('selectedNumbersDisplay');
        const selectedNumbersList = document.getElementById('selectedNumbersList'); // The span inside selectedNumbersDisplay
        const selectedNumbersCountSpan = document.getElementById('selectedNumbersCount');
        const clearSelectedBtn = document.getElementById('clearSelectedBtn');
        const manualNumbersInput = document.getElementById('manualNumbers');
        const addManualBtn = document.getElementById('addManualBtn');

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const allNumberGrid = document.getElementById('allNumberGrid'); // New: Grid for 1-69

        const generateForm = document.getElementById('generateForm');
        const generatePicksBtn = document.getElementById('generatePicksBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const generatedResultsSection = document.getElementById('generatedResultsSection');
        const generatedPicksContainer = document.getElementById('generatedPicksContainer');
        const saveAllCustomPicksBtn = document.getElementById('saveAllCustomPicksBtn');
        const saveAllCustomPicksActions = document.getElementById('saveAllCustomPicksActions');

        const combinationPoolInput = document.getElementById('combinationPoolInput');
        const numbersPerCombination = document.getElementById('numbersPerCombination');
        const generateCombinationsBtn = document.getElementById('generateCombinationsBtn');
        const combinationsLoadingIndicator = document.getElementById('combinationsLoadingIndicator');
        const generatedCombinationsSection = document.getElementById('generatedCombinationsSection');
        const generatedCombinationsContainer = document.getElementById('generatedCombinationsContainer');
        const combinationsCountSpan = document.getElementById('combinationsCount');
        const copyCombinationsBtn = document.getElementById('copyCombinationsBtn');


        const analysisModal = document.getElementById('analysisModal');
        const analysisModalContent = document.getElementById('analysisModalContent');
        const closeAnalysisModalBtn = document.getElementById('closeAnalysisModalBtn');
        const analyzedPickDisplay = document.getElementById('analyzedPickDisplay');
        const analysisResultsContent = document.getElementById('analysisResultsContent');
        const saveAnalyzedPickBtn = document.getElementById('saveAnalyzedPickBtn');

        // Function to update the displayed selected numbers
        function updateSelectedNumbersDisplay() {
            const sortedNumbers = Array.from(selectedNumbers).sort((a, b) => a - b);
            if (sortedNumbers.length === 0) {
                selectedNumbersList.innerHTML = 'No numbers selected';
            } else {
                selectedNumbersList.innerHTML = '';
                sortedNumbers.forEach(num => {
                    const span = document.createElement('span');
                    span.className = 'selected-display-ball'; // Use the new smaller class
                    span.textContent = num;
                    selectedNumbersList.appendChild(span);
                });
            }
            selectedNumbersCountSpan.textContent = selectedNumbers.size;

            // Update the visual state of the balls in *all* grids (monthly trends and all numbers grid)
            document.querySelectorAll('.number-ball').forEach(ball => {
                const number = parseInt(ball.dataset.number);
                if (selectedNumbers.has(number)) {
                    ball.classList.add('selected');
                } else {
                    ball.classList.remove('selected');
                }
            });
        }

        // Event listener for clicking on any number ball (delegated for efficiency)
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.addEventListener('click', function(event) {
                const target = event.target.closest('.number-ball');
                if (target) {
                    const number = parseInt(target.dataset.number);
                    if (selectedNumbers.has(number)) {
                        selectedNumbers.delete(number);
                    } else {
                        selectedNumbers.add(number);
                    }
                    updateSelectedNumbersDisplay(); // This will update all relevant balls
                }
            });
        });

        // Event listener for adding manual numbers
        addManualBtn.addEventListener('click', function() {
            const inputVal = manualNumbersInput.value.trim();
            if (inputVal) {
                const newNumbers = inputVal.split(',').map(num => parseInt(num.trim())).filter(num => !isNaN(num) && num >= 1 && num <= 69);
                newNumbers.forEach(num => selectedNumbers.add(num));
                updateSelectedNumbersDisplay();
                manualNumbersInput.value = ''; // Clear input field
            }
        });

        // Event listener for clearing all selected numbers
        clearSelectedBtn.addEventListener('click', function() {
            selectedNumbers.clear();
            updateSelectedNumbersDisplay(); // This will clear all selected classes
        });

        // --- Tab Switching Logic ---
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetTab = this.dataset.tab;

                tabButtons.forEach(btn => {
                    btn.classList.remove('text-blue-600', 'border-blue-600');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                });

                this.classList.add('text-blue-600', 'border-blue-600');
                this.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${targetTab}_tab`).classList.remove('hidden');
                
                // Re-apply selection visual state after tab switch
                updateSelectedNumbersDisplay();
            });
        });

        // Initialize display on load
        updateSelectedNumbersDisplay();
        // Trigger initial tab selection (Monthly Trends by default)
        document.querySelector('.tab-button[data-tab="monthly_trends"]').click();


        // --- Handle Custom Generation Form Submission ---
        generateForm.addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent default form submission

            const numSets = parseInt(document.getElementById('numSetsToGenerate').value);
            const excludedNumbersInput = document.getElementById('excludedNumbers').value.trim();
            const powerballOverrideInput = document.getElementById('powerballOverride').value.trim();

            let excludedNumbers = [];
            if (excludedNumbersInput) {
                excludedNumbers = excludedNumbersInput.split(',').map(num => parseInt(num.trim())).filter(num => !isNaN(num) && num >= 1 && num <= 69);
                if (new Set(excludedNumbers).size !== excludedNumbers.length) {
                    showToast("Excluded numbers must be unique.", 'error');
                    return;
                }
            }

            let powerballOverride = null;
            if (powerballOverrideInput) {
                const pb = parseInt(powerballOverrideInput);
                if (isNaN(pb) || pb < 1 || pb > 26) {
                    showToast("Powerball override must be a number between 1 and 26.", 'error');
                    return;
                }
                powerballOverride = pb;
            }

            if (selectedNumbers.size < 5) {
                showToast("Please select at least 5 numbers for your combination pool.", 'error');
                return;
            }

            // Check if any selected number is also in excluded numbers
            for (const num of selectedNumbers) {
                if (excludedNumbers.includes(num)) {
                    showToast(`Number ${num} is in both your selected pool and excluded numbers. Please remove it from excluded.`, 'error');
                    return;
                }
            }

            const payload = {
                selected_pool: Array.from(selectedNumbers).sort((a, b) => a - b),
                num_sets: numSets,
                excluded_numbers: excludedNumbers,
                powerball_override: powerballOverride
            };

            generatePicksBtn.disabled = true;
            generatePicksBtn.textContent = 'Generating...';
            loadingIndicator.classList.remove('hidden');
            generatedPicksContainer.innerHTML = ''; // Clear previous results
            generatedResultsSection.classList.add('hidden');
            saveAllCustomPicksActions.classList.add('hidden'); // Hide save all button initially

            try {
                const response = await fetch('/api/generate_custom_combinations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                const result = await response.json();

                if (result.success) {
                    generatedResultsSection.classList.remove('hidden');
                    if (result.generated_sets && result.generated_sets.length > 0) {
                        result.generated_sets.forEach(pick => {
                            const pickElement = document.createElement('div');
                            pickElement.className = 'generated-pick-item flex flex-col sm:flex-row items-center justify-between bg-white bg-opacity-10 backdrop-filter backdrop-blur-sm rounded-xl p-4 shadow-inner border border-white border-opacity-20';
                            pickElement.dataset.whiteBalls = pick.white_balls.join(',');
                            pickElement.dataset.powerball = pick.powerball;

                            const ballsHtml = pick.white_balls.map(num => `<span class="generated-ball bg-white text-gray-800">${num}</span>`).join('');
                            const powerballHtml = `<span class="generated-ball generated-powerball">${pick.powerball}</span>`;

                            pickElement.innerHTML = `
                                <div class="flex items-center flex-wrap justify-center mb-4 sm:mb-0">
                                    ${ballsHtml}
                                    <span class="text-white mx-2 text-xl font-bold">+</span>
                                    ${powerballHtml}
                                </div>
                                <div class="flex flex-wrap gap-2 justify-center">
                                    <button class="btn analyze-btn bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800 transition duration-200 ease-in-out text-sm shadow">Analyze</button>
                                    <button class="btn save-btn bg-indigo-700 text-white px-4 py-2 rounded-lg hover:bg-indigo-800 transition duration-200 ease-in-out text-sm shadow">Save Pick</button>
                                </div>
                            `;
                            generatedPicksContainer.appendChild(pickElement);
                        });
                        saveAllCustomPicksActions.classList.remove('hidden'); // Show save all button
                        showToast("Custom picks generated successfully!", 'success');
                    } else {
                        generatedPicksContainer.innerHTML = `<p class="text-center text-white text-lg">No picks could be generated with the specified criteria.</p>`;
                    }
                } else {
                    showToast(`Error: ${result.error}`, 'error');
                    generatedPicksContainer.innerHTML = `<p class="text-red-300 text-center text-lg">Error generating picks: ${result.error}</p>`;
                    generatedResultsSection.classList.remove('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'p-6', 'rounded-2xl', 'shadow-xl'); // Remove gradient on error
                    saveAllCustomPicksActions.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error generating custom picks:', error);
                showToast('An unexpected error occurred during generation.', 'error');
                generatedPicksContainer.innerHTML = `<p class="text-red-300 text-center text-lg">An unexpected error occurred: ${error.message}</p>`;
                generatedResultsSection.classList.remove('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'p-6', 'rounded-2xl', 'shadow-xl'); // Remove gradient on error
                saveAllCustomPicksActions.classList.add('hidden');
            } finally {
                generatePicksBtn.disabled = false;
                generatePicksBtn.textContent = 'Generate Custom Picks';
                loadingIndicator.classList.add('hidden');
            }
        });

        // --- Save All Custom Picks Logic ---
        saveAllCustomPicksBtn.addEventListener('click', async function() {
            const allPickItems = document.querySelectorAll('#generatedPicksContainer .generated-pick-item');
            const picksToSave = [];
            allPickItems.forEach(item => {
                const whiteBallsStr = item.dataset.whiteBalls;
                const powerballStr = item.dataset.powerball;
                if (whiteBallsStr && powerballStr) {
                    picksToSave.push({
                        white_balls: whiteBallsStr.split(',').map(Number),
                        powerball: Number(powerballStr)
                    });
                }
            });

            if (picksToSave.length === 0) {
                showToast("No picks to save.", 'info');
                return;
            }

            saveAllCustomPicksBtn.disabled = true;
            saveAllCustomPicksBtn.textContent = 'Saving All...';

            try {
                const response = await fetch('/save_multiple_generated_picks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ picks: picksToSave }),
                });

                const result = await response.json();

                if (result.success) {
                    showToast(result.message, 'success');
                } else {
                    showToast(`Error saving picks: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Error saving multiple picks:', error);
                showToast('An unexpected error occurred while saving all picks.', 'error');
            } finally {
                saveAllCustomPicksBtn.disabled = false;
                saveAllCustomPicksBtn.textContent = 'Save All Generated Picks';
            }
        });

        // --- Event Delegation for Analyze and Save Buttons on Generated Picks ---
        generatedPicksContainer.addEventListener('click', async function(event) {
            const target = event.target;
            const pickItem = target.closest('.generated-pick-item');

            if (!pickItem) return;

            const whiteBallsStr = pickItem.dataset.whiteBalls;
            const powerballStr = pickItem.dataset.powerball;

            if (!whiteBallsStr || !powerballStr) {
                showToast("Could not retrieve pick data.", 'error');
                return;
            }

            const whiteBalls = whiteBallsStr.split(',').map(Number);
            const powerball = Number(powerballStr);

            if (target.classList.contains('analyze-btn')) {
                // Show modal and loading indicator
                analysisModal.classList.remove('hidden');
                setTimeout(() => { // Allow hidden to be removed before transition
                    analysisModal.classList.add('opacity-100');
                    analysisModalContent.classList.remove('scale-95', 'opacity-0');
                    analysisModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
                analyzedPickDisplay.textContent = `${whiteBalls.join(', ')} + ${powerball}`;
                analysisResultsContent.innerHTML = `<p class="text-center text-blue-600"><img src="https://placehold.co/30x30/blue/white?text=..." alt="Loading" class="inline-block animate-spin mr-2"> Loading analysis...</p>`;
                saveAnalyzedPickBtn.dataset.whiteBalls = whiteBallsStr;
                saveAnalyzedPickBtn.dataset.powerball = powerballStr;

                try {
                    const response = await fetch('/analyze_manual_pick', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ white_balls: whiteBalls, powerball: powerball }),
                    });

                    const result = await response.json();

                    if (result.success) {
                        let html = '';
                        html += '<h4 class="font-bold text-gray-800 mb-2">Historical Matches (Last 2 Years):</h4>';
                        let hasMatches = false;
                        for (const category in result.match_summary) {
                            if (result.match_summary[category].count > 0) {
                                hasMatches = true;
                                html += `<p class="font-medium">${category}: <span class="text-blue-600">${result.match_summary[category].count} time(s)</span></p>`;
                                if (result.match_summary[category].draws.length > 0) {
                                    html += `<ul class="list-disc list-inside text-sm text-gray-600 mb-2">`;
                                    result.match_summary[category].draws.slice(0, 5).forEach(draw => { // Show up to 5 draws
                                        html += `<li>Date: ${draw.date}, Balls: ${draw.white_balls.join(', ')} + PB ${draw.powerball}</li>`;
                                    });
                                    if (result.match_summary[category].draws.length > 5) {
                                        html += `<li>...and ${result.match_summary[category].draws.length - 5} more.</li>`;
                                    }
                                    html += `</ul>`;
                                }
                            }
                        }
                        if (!hasMatches) {
                            html += '<p>No historical matches found in the last 2 years for this combination.</p>';
                        }

                        html += '<h4 class="font-bold text-gray-800 mt-4 mb-2">Last Drawn Dates for Each Number:</h4>';
                        html += `<ul class="list-disc list-inside text-sm text-gray-600">`;
                        for (const [key, date] of Object.entries(result.last_drawn_dates)) {
                            html += `<li><strong>${key}:</strong> ${date}</li>`;
                        }
                        html += `</ul>`;
                        analysisResultsContent.innerHTML = html;
                        showToast("Analysis complete!", 'success');
                    } else {
                        analysisResultsContent.innerHTML = `<p class="text-red-600">Error: ${result.error}</p>`;
                        showToast(`Analysis Error: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('Error analyzing pick:', error);
                    analysisResultsContent.innerHTML = '<p class="text-red-600">An error occurred during analysis.</p>';
                    showToast('An unexpected error occurred during analysis.', 'error');
                }
            } else if (target.classList.contains('save-btn')) {
                // Save single pick logic
                saveAnalyzedPickBtn.dataset.whiteBalls = whiteBallsStr; // Set data attributes for re-use
                saveAnalyzedPickBtn.dataset.powerball = powerballStr;

                // Perform the actual save
                try {
                    const response = await fetch('/save_manual_pick', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ white_balls: whiteBalls, powerball: powerball }),
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast(result.message, 'success');
                    } else {
                        showToast(`Error: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('Error saving pick:', error);
                    showToast('An unexpected error occurred while saving the pick.', 'error');
                }
            }
        });

        // --- Analysis Modal Close Button ---
        closeAnalysisModalBtn.addEventListener('click', function() {
            analysisModalContent.classList.remove('scale-100', 'opacity-100');
            analysisModalContent.classList.add('scale-95', 'opacity-0');
            analysisModal.classList.remove('opacity-100');
            setTimeout(() => {
                analysisModal.classList.add('hidden');
            }, 300); // Match transition duration
        });

        // Close modal if clicked outside content
        analysisModal.addEventListener('click', function(event) {
            if (event.target === analysisModal) {
                closeAnalysisModalBtn.click();
            }
        });

        // --- Save Single Analyzed Pick from Modal ---
        saveAnalyzedPickBtn.addEventListener('click', async function() {
            const whiteBallsStr = this.dataset.whiteBalls;
            const powerballStr = this.dataset.powerball;

            if (!whiteBallsStr || !powerballStr) {
                showToast("No pick data found to save from analysis modal.", 'error');
                return;
            }

            const whiteBalls = whiteBallsStr.split(',').map(Number);
            const powerball = Number(powerballStr);

            saveAnalyzedPickBtn.disabled = true;
            saveAnalyzedPickBtn.textContent = 'Saving...';

            try {
                const response = await fetch('/save_manual_pick', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ white_balls: whiteBalls, powerball: powerball }),
                });

                const result = await response.json();

                if (result.success) {
                    showToast(result.message, 'success');
                    closeAnalysisModalBtn.click(); // Close modal after successful save
                } else {
                    showToast(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error saving analyzed pick:', error);
                showToast('An unexpected error occurred while saving the analyzed pick.', 'error');
            } finally {
                saveAnalyzedPickBtn.disabled = false;
                saveAnalyzedPickBtn.textContent = 'Save This Pick';
            }
        });

        // --- PHASE 3: Generate Combinations from a Pool ---
        generateCombinationsBtn.addEventListener('click', async function() {
            const poolInput = combinationPoolInput.value.trim();
            const comboSize = parseInt(numbersPerCombination.value);

            if (!poolInput) {
                showToast("Please enter numbers for the combination pool.", 'error');
                return;
            }

            const poolNumbers = poolInput.split(',')
                                         .map(num => parseInt(num.trim()))
                                         .filter(num => !isNaN(num) && num >= 1 && num <= 69);
            
            if (new Set(poolNumbers).size !== poolNumbers.length) {
                showToast("Numbers in the combination pool must be unique.", 'error');
                return;
            }

            if (poolNumbers.length < comboSize) {
                showToast(`Combination size (${comboSize}) cannot be greater than the pool size (${poolNumbers.length}).`, 'error');
                return;
            }
            if (comboSize < 1) {
                showToast("Numbers per combination must be at least 1.", 'error');
                return;
            }

            generateCombinationsBtn.disabled = true;
            generateCombinationsBtn.textContent = 'Generating...';
            combinationsLoadingIndicator.classList.remove('hidden');
            generatedCombinationsContainer.innerHTML = '';
            generatedCombinationsSection.classList.add('hidden');
            combinationsCountSpan.textContent = '0';

            try {
                const response = await fetch('/api/create_combinations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pool_numbers: poolNumbers,
                        combination_size: comboSize
                    })
                });

                const result = await response.json();

                if (result.success) {
                    generatedCombinationsSection.classList.remove('hidden');
                    if (result.combinations && result.combinations.length > 0) {
                        result.combinations.forEach(combo => {
                            const comboElement = document.createElement('div');
                            comboElement.className = 'combination-item';
                            const ballsHtml = combo.map(num => `<span class="combination-number-ball">${num}</span>`).join('');
                            comboElement.innerHTML = ballsHtml;
                            generatedCombinationsContainer.appendChild(comboElement);
                        });
                        combinationsCountSpan.textContent = result.combinations.length;
                        showToast(`Generated ${result.combinations.length} combinations!`, 'success');
                    } else {
                        generatedCombinationsContainer.innerHTML = `<p class="text-center text-white text-lg">No combinations could be generated with the specified criteria.</p>`;
                    }
                } else {
                    showToast(`Error: ${result.error}`, 'error');
                    generatedCombinationsContainer.innerHTML = `<p class="text-red-300 text-center text-lg">Error generating combinations: ${result.error}</p>`;
                }
            } catch (error) {
                console.error('Error generating combinations:', error);
                showToast('An unexpected error occurred during combination generation.', 'error');
                generatedCombinationsContainer.innerHTML = `<p class="text-red-300 text-center text-lg">An unexpected error occurred: ${error.message}</p>`;
            } finally {
                generateCombinationsBtn.disabled = false;
                generateCombinationsBtn.textContent = 'Generate All Combinations';
                combinationsLoadingIndicator.classList.add('hidden');
            }
        });

        // --- Copy Combinations to Clipboard ---
        copyCombinationsBtn.addEventListener('click', function() {
            const allCombinationsText = Array.from(generatedCombinationsContainer.children)
                                            .map(item => Array.from(item.querySelectorAll('.combination-number-ball')).map(span => span.textContent).join(','))
                                            .join('\n');
            
            if (allCombinationsText) {
                try {
                    // Use execCommand for broader compatibility in iframes
                    const textarea = document.createElement('textarea');
                    textarea.value = allCombinationsText;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast("All combinations copied to clipboard!", 'info');
                } catch (err) {
                    console.error('Failed to copy combinations:', err);
                    showToast("Failed to copy combinations. Please try manually.", 'error');
                }
            } else {
                showToast("No combinations to copy.", 'info');
            }
        });


        // --- Custom Toast Popup Function (Copied for consistency) ---
        function showToast(message, category) {
            const existingToast = document.querySelector('.toast-popup');
            if (existingToast) {
                existingToast.remove(); // Remove any existing toast
            }

            const toastDiv = document.createElement('div');
            toastDiv.className = `toast-popup ${category}`;
            toastDiv.textContent = message;
            document.body.appendChild(toastDiv);

            setTimeout(() => {
                toastDiv.classList.add('show');
            }, 10);

            setTimeout(() => {
                toastDiv.classList.remove('show');
                toastDiv.classList.add('animate-fade-out');
                toastDiv.addEventListener('animationend', () => {
                    toastDiv.remove();
                }, { once: true });
            }, 5000);
        }
    });
</script>
{% endblock %}
