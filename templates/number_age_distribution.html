{% extends "base.html" %}

{% block title %}Number Age Distribution{% endblock %}

{% block page_heading %}Draws Since Last Appearance (Number Age Distribution){% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {# Removed White Ball Age Distribution Chart #}
    {# Removed Powerball Age Distribution Chart #}

    {# Detailed Ball Ages Table #}
    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200 mt-0"> {# Adjusted mt-0 as charts are removed #}
        <h3 class="text-2xl font-bold mb-4 text-gray-800">Detailed Ball Ages & Historical Pick Ages</h3>
        
        {% if detailed_number_ages %}
        <div class="mb-4 flex flex-col sm:flex-row sm:justify-between sm:items-center">
            <button id="sortByAgeBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-200 ease-in-out mb-2 sm:mb-0">
                Sort by Current Age (Longest First)
            </button>
            <span class="text-sm text-gray-600 text-right">
                "Age at Pick" shows draws missed *before* each historical appearance (0 = picked in consecutive draw).
            </span>
        </div>
        <div class="overflow-x-auto shadow-md rounded-lg">
            <table class="min-w-full divide-y divide-gray-200" id="detailedAgesTable">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Number</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="age">Current Age (Draws Missed) <span class="ml-1 text-gray-400">↑↓</span></th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Drawn Date</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Historical Ages at Pick (Last 15)</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {# Data will be rendered by JavaScript #}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500">No detailed number age data available.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{# Removed: <script src="https://d3js.org/d3.v7.min.js"></script> #}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Removed D3 chart related code and data parsing for charts

        var detailedNumberAges = [];
        {% if detailed_number_ages %}
            try {
                detailedNumberAges = {{ detailed_number_ages | tojson | safe }};
            } catch (e) {
                console.error("Error parsing detailedNumberAges JSON for table:", e);
                detailedNumberAges = [];
            }
        {% endif %}
        console.log("[Table Debug] number_age_distribution.html - detailedNumberAges (for table):", detailedNumberAges);

        var historicalAgesAtPick = {};
        {% if historical_ages_at_pick %}
            try {
                historicalAgesAtPick = {{ historical_ages_at_pick | tojson | safe }};
            } catch (e) {
                console.error("Error parsing historicalAgesAtPick JSON:", e);
                historicalAgesAtPick = {};
            }
        {% endif %}
        console.log("[Table Debug] number_age_distribution.html - historicalAgesAtPick:", historicalAgesAtPick);


        const tableBody = document.querySelector('#detailedAgesTable tbody');
        const sortByAgeBtn = document.getElementById('sortByAgeBtn');
        let isSortedAscending = false; // Tracks current sort order for the button

        function renderTable(data) {
            tableBody.innerHTML = ''; // Clear existing rows
            data.forEach(ball => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-50';
                
                // Number column - Centered
                const numberCell = row.insertCell();
                numberCell.textContent = ball.number;
                numberCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900', 'text-center');

                // Type column - Left aligned (default)
                row.insertCell().textContent = ball.type;

                // Current Age column - Centered
                const ageCell = row.insertCell();
                ageCell.textContent = ball.age;
                ageCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500', 'text-center');

                // Last Drawn Date column - Left aligned (default)
                row.insertCell().textContent = ball.last_drawn_date !== 'N/A' ? ball.last_drawn_date : 'Never Drawn';

                // Historical Ages at Pick - CORRECTED KEY ACCESS & Wrapping
                const historicalAgesCell = row.insertCell();
                const key = `${ball.type}_${ball.number}`; 
                const ages = historicalAgesAtPick[key];

                if (ages && ages.length > 0) {
                    const agesToDisplay = ages.slice(Math.max(0, ages.length - 15));
                    historicalAgesCell.textContent = agesToDisplay.join(', ');
                    historicalAgesCell.classList.add('whitespace-normal'); // Allow text to wrap
                } else {
                    historicalAgesCell.textContent = 'N/A';
                }
                // Add common styling to all cells for consistency
                historicalAgesCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-500');
            });
        }

        // Initial render (default sort by number, from Python side)
        renderTable(detailedNumberAges);

        sortByAgeBtn.addEventListener('click', function() {
            if (isSortedAscending) {
                detailedNumberAges.sort((a, b) => b.age - a.age); // Sort descending
                sortByAgeBtn.textContent = 'Sort by Current Age (Shortest First)';
                isSortedAscending = false;
            } else {
                detailedNumberAges.sort((a, b) => a.age - b.age); // Sort ascending
                sortByAgeBtn.textContent = 'Sort by Current Age (Longest First)';
                isSortedAscending = true;
            }
            renderTable(detailedNumberAges);
        });
    });
</script>
{% endblock %}
