{% extends "base.html" %}

{% block title %}Number Age Distribution{% endblock %}

{% block page_heading %}Draws Since Last Appearance (Number Age Distribution){% endblock %}

{% block content %}
<div class="chart-container">
    <h2 class="text-xl font-semibold mb-4 text-gray-800">Age Distribution of All Balls (Current Miss Streak)</h2>
    {% if number_age_data %}
        <div id="numberAgeChart"></div>
    {% else %}
        <p class="text-gray-500">No number age distribution data available to display chart.</p>
    {% endif %}
</div>

<div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200 mt-8">
    <h3 class="text-2xl font-bold mb-4 text-gray-800">Detailed Ball Ages & Historical Pick Ages</h3>
    
    {% if detailed_number_ages %}
    <div class="mb-4 flex flex-col sm:flex-row sm:justify-between sm:items-center">
        <button id="sortByAgeBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-200 ease-in-out mb-2 sm:mb-0">
            Sort by Current Age (Longest First)
        </button>
        <span class="text-sm text-gray-600">
            "Age at Pick" shows draws missed *before* each historical appearance (0 = picked in consecutive draw).
        </span>
    </div>
    <div class="overflow-x-auto shadow-md rounded-lg">
        <table class="min-w-full divide-y divide-gray-200" id="detailedAgesTable">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Number</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="age">Current Age (Draws Missed) <span class="ml-1 text-gray-400">↑↓</span></th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Drawn Date</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Historical Ages at Pick (Last 15)</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {# Data will be rendered by JavaScript #}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-500">No detailed number age data available.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://d3js.org/d3.v7.min.js"></script>
{# Removed: <script src="{{ url_for('static', filename='js/d3_charts.js') }}"></script> #}

<script>
    // --- D3 Chart Function (Embedded) ---
    function drawBarChart(data, elementId, xKey, yKey, title, xLabel, yLabel) {
        const margin = { top: 40, right: 30, bottom: 60, left: 70 };
        const container = d3.select("#" + elementId);
        const containerWidth = container.node().getBoundingClientRect().width;
        const width = containerWidth - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        container.html(""); // Clear previous chart

        const svg = container.append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // X axis
        const x = d3.scaleBand()
            .range([0, width])
            .domain(data.map(d => d[xKey]))
            .padding(0.2);

        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end");

        // Y axis
        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d[yKey])])
            .range([height, 0]);

        svg.append("g")
            .call(d3.axisLeft(y));

        // Bars
        svg.selectAll("mybar")
            .data(data)
            .enter()
            .append("rect")
            .attr("x", d => x(d[xKey]))
            .attr("y", d => y(d[yKey]))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d[yKey]))
            .attr("fill", "#6B46C1"); // Tailwind indigo-600 equivalent

        // Labels
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")
            .style("font-size", "1.2em")
            .style("font-weight", "bold")
            .text(title);

        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("transform", `translate(${width / 2},${height + margin.bottom - 10})`)
            .text(xLabel);

        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("transform", `translate(${-margin.left + 20},${height / 2})rotate(-90)`)
            .text(yLabel);
    }
    // --- End D3 Chart Function ---


    document.addEventListener('DOMContentLoaded', function() {
        var numberAgeData = [];
        {% if number_age_data %}
            try {
                numberAgeData = {{ number_age_data | tojson | safe }};
            } catch (e) {
                console.error("Error parsing numberAgeData JSON for chart:", e);
                numberAgeData = [];
            }
        {% endif %}
        console.log("[D3 Debug] number_age_distribution.html - numberAgeData (for chart):", numberAgeData);

        // Sort data by age for consistent chart display
        numberAgeData.sort((a, b) => a.age - b.age);

        drawBarChart(numberAgeData, "numberAgeChart", "age", "count", "Draws Since Last Appearance", "Draws Missed", "Number of Balls");

        var detailedNumberAges = [];
        {% if detailed_number_ages %}
            try {
                detailedNumberAges = {{ detailed_number_ages | tojson | safe }};
            } catch (e) {
                console.error("Error parsing detailedNumberAges JSON for table:", e);
                detailedNumberAges = [];
            }
        {% endif %}
        console.log("[D3 Debug] number_age_distribution.html - detailedNumberAges (for table):", detailedNumberAges);

        var historicalAgesAtPick = {};
        {% if historical_ages_at_pick %}
            try {
                historicalAgesAtPick = {{ historical_ages_at_pick | tojson | safe }};
            } catch (e) {
                console.error("Error parsing historicalAgesAtPick JSON:", e);
                historicalAgesAtPick = {};
            }
        {% endif %}
        console.log("[D3 Debug] number_age_distribution.html - historicalAgesAtPick:", historicalAgesAtPick);


        const tableBody = document.querySelector('#detailedAgesTable tbody');
        const sortByAgeBtn = document.getElementById('sortByAgeBtn');
        let isSortedAscending = false; // Tracks current sort order for the button

        function renderTable(data) {
            tableBody.innerHTML = ''; // Clear existing rows
            data.forEach(ball => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-50';
                row.insertCell().textContent = ball.number;
                row.insertCell().textContent = ball.type;
                row.insertCell().textContent = ball.age; // Current Age

                // Last Drawn Date
                row.insertCell().textContent = ball.last_drawn_date !== 'N/A' ? ball.last_drawn_date : 'Never Drawn';

                // Historical Ages at Pick
                const historicalAgesCell = row.insertCell();
                const ages = historicalAgesAtPick[ball.number];
                if (ages && ages.length > 0) {
                    // Display the last 15 ages, or fewer if not available
                    const agesToDisplay = ages.slice(Math.max(0, ages.length - 15));
                    historicalAgesCell.textContent = agesToDisplay.join(', ');
                } else {
                    historicalAgesCell.textContent = 'N/A';
                }
            });
        }

        // Initial render (default sort by number, from Python side)
        renderTable(detailedNumberAges);

        sortByAgeBtn.addEventListener('click', function() {
            if (isSortedAscending) {
                // Currently sorted ascending by age, click makes it sort descending
                detailedNumberAges.sort((a, b) => b.age - a.age); // Sort descending
                sortByAgeBtn.textContent = 'Sort by Current Age (Shortest First)';
                isSortedAscending = false;
            } else {
                // Currently unsorted or sorted descending, click makes it sort ascending
                detailedNumberAges.sort((a, b) => a.age - b.age); // Sort ascending
                sortByAgeBtn.textContent = 'Sort by Current Age (Longest First)';
                isSortedAscending = true;
            }
            renderTable(detailedNumberAges);
        });
    });
</script>
{% endblock %}
