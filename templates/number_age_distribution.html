{% extends "base.html" %}

{% block title %}Number Age Distribution & Yearly Trends{% endblock %}

{% block page_heading %}Draws Since Last Appearance & Yearly Trends{% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {# White Ball Age Distribution and Yearly Trends Section #}
    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <button class="w-full flex justify-between items-center text-2xl font-bold text-gray-800 focus:outline-none py-2" data-toggle="whiteBallSection">
            <span>White Ball Analysis</span>
            <svg class="w-6 h-6 transform transition-transform duration-200" viewBox="0 0 24 24" fill="currentColor" data-arrow="whiteBallSection">
                <path fill-rule="evenodd" d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z" clip-rule="evenodd" />
            </svg>
        </button>
        <div id="whiteBallSection" class="mt-4 space-y-6">
            <h3 class="text-xl font-semibold text-gray-800">Detailed White Ball Ages</h3>
            {% if detailed_white_ball_ages %}
            <div class="mb-4 flex flex-col sm:flex-row sm:justify-between sm:items-center">
                <button id="sortByWhiteBallAgeBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-200 ease-in-out mb-2 sm:mb-0">
                    Sort by Current Age (Longest First)
                </button>
                <span class="text-sm text-gray-600 text-right">
                    Current Age (Draws Missed) indicates how many draws have occurred since the number last appeared.
                </span>
            </div>
            <div class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full divide-y divide-gray-200" id="whiteBallAgesTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Number</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="age">Current Age (Draws Missed) <span class="ml-1 text-gray-400">↑↓</span></th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Drawn Date</th>
                            {% for year in wb_trend_years %}
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Freq {{ year }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {# White ball data will be rendered by JavaScript #}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-500">No detailed white ball age data available.</p>
            {% endif %}
        </div>
    </div>

    {# Powerball Age Distribution and Yearly Trends Section #}
    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <button class="w-full flex justify-between items-center text-2xl font-bold text-gray-800 focus:outline-none py-2" data-toggle="powerBallSection">
            <span>Powerball Analysis</span>
            <svg class="w-6 h-6 transform transition-transform duration-200" viewBox="0 0 24 24" fill="currentColor" data-arrow="powerBallSection">
                <path fill-rule="evenodd" d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z" clip-rule="evenodd" />
            </svg>
        </button>
        <div id="powerBallSection" class="mt-4 space-y-6">
            <h3 class="text-xl font-semibold text-gray-800">Detailed Powerball Ages</h3>
            {% if detailed_powerball_ages %}
            <div class="mb-4 flex flex-col sm:flex-row sm:justify-between sm:items-center">
                <button id="sortByPowerballAgeBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-200 ease-in-out mb-2 sm:mb-0">
                    Sort by Current Age (Longest First)
                </button>
                <span class="text-sm text-gray-600 text-right">
                    Current Age (Draws Missed) indicates how many draws have occurred since the number last appeared.
                </span>
            </div>
            <div class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full divide-y divide-gray-200" id="powerballAgesTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Number</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="age">Current Age (Draws Missed) <span class="ml-1 text-gray-400">↑↓</span></th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Drawn Date</th>
                            {% for year in pb_trend_years %}
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Freq {{ year }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {# Powerball data will be rendered by JavaScript #}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-500">No detailed powerball age data available.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Data for tables
        var detailedWhiteBallAges = [];
        var detailedPowerballAges = [];
        var yearlyWhiteBallTrends = {}; // Object: {number: [{period_label: "2020", frequency: 5}, ...]}
        var yearlyPowerballTrends = []; // Array of objects: [{Powerball: 1, Year_2020: 5, ...}, ...]
        var wbTrendYears = [];
        var pbTrendYears = [];

        // Parse data from Jinja
        {% if detailed_white_ball_ages %}
            try { detailedWhiteBallAges = {{ detailed_white_ball_ages | tojson | safe }}; } catch (e) { console.error("Error parsing detailedWhiteBallAges JSON:", e); }
        {% endif %}
        {% if detailed_powerball_ages %}
            try { detailedPowerballAges = {{ detailed_powerball_ages | tojson | safe }}; } catch (e) { console.error("Error parsing detailedPowerballAges JSON:", e); }
        {% endif %}
        {% if yearly_white_ball_trends %}
            try { yearlyWhiteBallTrends = {{ yearly_white_ball_trends | tojson | safe }}; } catch (e) { console.error("Error parsing yearlyWhiteBallTrends JSON:", e); }
        {% endif %}
        {% if yearly_powerball_trends %}
            try { yearlyPowerballTrends = {{ yearly_powerball_trends | tojson | safe }}; } catch (e) { console.error("Error parsing yearlyPowerballTrends JSON:", e); }
        {% endif %}
        {% if wb_trend_years %}
            try { wbTrendYears = {{ wb_trend_years | tojson | safe }}; } catch (e) { console.error("Error parsing wb_trend_years JSON:", e); }
        {% endif %}
        {% if pb_trend_years %}
            try { pbTrendYears = {{ pb_trend_years | tojson | safe }}; } catch (e) { console.error("Error parsing pb_trend_years JSON:", e); }
        {% endif %}

        // DOM elements
        const whiteBallAgesTableBody = document.querySelector('#whiteBallAgesTable tbody');
        const powerballAgesTableBody = document.querySelector('#powerballAgesTable tbody');
        const sortByWhiteBallAgeBtn = document.getElementById('sortByWhiteBallAgeBtn');
        const sortByPowerballAgeBtn = document.getElementById('sortByPowerballAgeBtn');

        let isWhiteBallSortedAscending = false; 
        let isPowerballSortedAscending = false; 

        // Render functions
        function renderWhiteBallTable(data) {
            whiteBallAgesTableBody.innerHTML = ''; 
            data.forEach(ball => {
                const row = whiteBallAgesTableBody.insertRow();
                row.className = 'hover:bg-gray-50';
                
                row.insertCell().textContent = ball.number;
                row.cells[0].classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900', 'text-center');

                const ageCell = row.insertCell();
                ageCell.textContent = ball.age;
                ageCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500', 'text-center');

                row.insertCell().textContent = ball.last_drawn_date !== 'N/A' ? ball.last_drawn_date : 'Never Drawn';
                row.cells[2].classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');

                // Add yearly frequency cells
                const wbFreqs = yearlyWhiteBallTrends[ball.number] || [];
                wbTrendYears.forEach(year => {
                    const freqData = wbFreqs.find(f => f.period_label === String(year));
                    const freqCell = row.insertCell();
                    freqCell.textContent = freqData ? freqData.frequency : '0';
                    freqCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500', 'text-center');
                });
            });
        }

        function renderPowerballTable(data) {
            powerballAgesTableBody.innerHTML = ''; 
            data.forEach(ball => {
                const row = powerballAgesTableBody.insertRow();
                row.className = 'hover:bg-gray-50';
                
                row.insertCell().textContent = ball.number;
                row.cells[0].classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900', 'text-center');

                const ageCell = row.insertCell();
                ageCell.textContent = ball.age;
                ageCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500', 'text-center');

                row.insertCell().textContent = ball.last_drawn_date !== 'N/A' ? ball.last_drawn_date : 'Never Drawn';
                row.cells[2].classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');

                // Add yearly frequency cells for Powerball
                const pbFreqData = yearlyPowerballTrends.find(p => p.Powerball === ball.number);
                pbTrendYears.forEach(year => {
                    const freqCell = row.insertCell();
                    freqCell.textContent = pbFreqData ? pbFreqData[`Year_${year}`] || '0' : '0';
                    freqCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500', 'text-center');
                });
            });
        }


        // Initial render for both tables
        renderWhiteBallTable(detailedWhiteBallAges);
        renderPowerballTable(detailedPowerballAges);

        // Sort event listeners
        sortByWhiteBallAgeBtn.addEventListener('click', function() {
            if (isWhiteBallSortedAscending) {
                detailedWhiteBallAges.sort((a, b) => b.age - a.age); // Sort descending
                sortByWhiteBallAgeBtn.textContent = 'Sort by Current Age (Shortest First)';
                isWhiteBallSortedAscending = false;
            } else {
                detailedWhiteBallAges.sort((a, b) => a.age - b.age); // Sort ascending
                sortByWhiteBallAgeBtn.textContent = 'Sort by Current Age (Longest First)';
                isWhiteBallSortedAscending = true;
            }
            renderWhiteBallTable(detailedWhiteBallAges);
        });

        sortByPowerballAgeBtn.addEventListener('click', function() {
            if (isPowerballSortedAscending) {
                detailedPowerballAges.sort((a, b) => b.age - a.age); // Sort descending
                sortByPowerballAgeBtn.textContent = 'Sort by Current Age (Shortest First)';
                isPowerballSortedAscending = false;
            } else {
                detailedPowerballAges.sort((a, b) => a.age - b.age); // Sort ascending
                sortByPowerballAgeBtn.textContent = 'Sort by Current Age (Longest First)';
                isPowerballSortedAscending = true;
            }
            renderPowerballTable(detailedPowerballAges);
        });

        // Expand/Collapse functionality
        document.querySelectorAll('[data-toggle]').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.dataset.toggle;
                const targetElement = document.getElementById(targetId);
                const arrowIcon = this.querySelector('[data-arrow]');

                if (targetElement) {
                    const isHidden = targetElement.classList.contains('hidden');
                    if (isHidden) {
                        targetElement.classList.remove('hidden');
                        targetElement.style.maxHeight = targetElement.scrollHeight + "px"; // Set max height for smooth transition
                        arrowIcon.classList.remove('rotate-0');
                        arrowIcon.classList.add('rotate-180');
                    } else {
                        targetElement.style.maxHeight = "0"; // Collapse by setting max-height to 0
                        targetElement.classList.add('hidden'); // Hide after transition
                        arrowIcon.classList.remove('rotate-180');
                        arrowIcon.classList.add('rotate-0');
                    }
                }
            });
        });

        // Initial collapse state (optional, can be changed to expand by default)
        document.getElementById('whiteBallSection').classList.remove('hidden'); // White Ball section expanded by default
        document.querySelector('[data-toggle="whiteBallSection"] [data-arrow]').classList.add('rotate-180'); // Point up for expanded

        document.getElementById('powerBallSection').classList.add('hidden'); // Powerball section collapsed by default
        document.querySelector('[data-toggle="powerBallSection"] [data-arrow]').classList.remove('rotate-180'); // Point down for collapsed

    });
</script>
{% endblock %}
