{% extends "base.html" %}

{% block title %}Powerball Assistant{% endblock %}

{% block page_heading %}Powerball AI Assistant{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <div class="card p-6 bg-white rounded-lg shadow-lg max-w-4xl w-full flex flex-col h-[90vh]">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Advanced Powerball AI Assistant</h2>
                <p class="text-sm text-gray-600">Your intelligent lottery analysis companion with advanced query capabilities</p>
            </div>
            <button id="clear-chat" class="text-sm text-gray-500 hover:text-gray-700 flex items-center">
                <i class="fas fa-trash-alt mr-1"></i> Clear Chat
            </button>
        </div>

        <div id="chat-history" class="flex-grow overflow-y-auto border border-gray-300 rounded-lg p-4 mb-4 space-y-4 custom-scrollbar bg-gray-50">
            <div class="flex justify-start message-animation">
                <div class="bg-blue-100 text-blue-800 p-3 rounded-lg max-w-[90%] shadow-sm">
                    <div class="font-medium">Powerball AI</div>
                    <div class="mt-1">Hello! I'm your Advanced Powerball AI Assistant. I can help you analyze Powerball data with advanced queries.</div>
                    <div class="text-xs text-gray-500 mt-2">Just now</div>
                </div>
            </div>
            
            <div class="flex justify-start message-animation">
                <div class="bg-blue-100 text-blue-800 p-3 rounded-lg max-w-[90%] shadow-sm">
                    <div class="font-medium">Powerball AI</div>
                    <div class="mt-1">Try asking me advanced questions like:</div>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li>"Find Powerball draws where the same four white balls appeared multiple times in 2024"</li>
                        <li>"Show me white ball numbers with frequency 8 in 2025"</li>
                        <li>"Find draws where three white balls repeated from the previous draw"</li>
                        <li>"What are the most common number pairs in 2024?"</li>
                        <li>"Show me analysis of number 23 in 2024 draws"</li>
                    </ul>
                    <div class="text-xs text-gray-500 mt-2">Just now</div>
                </div>
            </div>
        </div>

        <div class="bg-blue-50 p-3 rounded-lg mb-3">
            <div class="text-sm font-medium text-blue-700 mb-2">Quick Actions:</div>
            <div class="flex flex-wrap gap-2">
                <button class="quick-action-btn bg-blue-100 text-blue-700 hover:bg-blue-200" data-action="four-white">
                    <i class="fas fa-dice-four mr-1"></i> 4 White Ball Matches
                </button>
                <button class="quick-action-btn bg-blue-100 text-blue-700 hover:bg-blue-200" data-action="frequency">
                    <i class="fas fa-wave-square mr-1"></i> Frequency Analysis
                </button>
                <button class="quick-action-btn bg-blue-100 text-blue-700 hover:bg-blue-200" data-action="pairs">
                    <i class="fas fa-handshake mr-1"></i> Common Pairs
                </button>
                <button class="quick-action-btn bg-blue-100 text-blue-700 hover:bg-blue-200" data-action="generate">
                    <i class="fas fa-random mr-1"></i> Generate Numbers
                </button>
            </div>
        </div>

        <div class="flex space-x-3">
            <input type="text" id="user-input" class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Ask me to analyze Powerball data (e.g., find draws where same four white balls appeared...)">
            <button id="send-button" class="btn-primary flex items-center justify-center px-4 py-2 rounded-lg text-white font-semibold">
                <i class="fas fa-paper-plane mr-2"></i> Send
            </button>
        </div>
        
        <div id="typing-indicator" class="text-center text-gray-500 text-sm mt-2 hidden">
            <div class="typing-dots inline-flex items-center">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span class="ml-2">AI is analyzing Powerball data...</span>
        </div>
    </div>
</div>

<style>
    .card {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
    }
    .btn-primary {
        background: linear-gradient(to right, #2563eb, #1d4ed8);
        transition: all 0.3s ease;
    }
    .btn-primary:hover {
        background: linear-gradient(to right, #1d4ed8, #1e40af);
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
    }
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    .powerball-ball {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-weight: bold;
        margin: 0 2px;
    }
    .white-ball {
        background: linear-gradient(to bottom, #ffffff, #f0f0f0);
        color: #1f2937;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .red-ball {
        background: linear-gradient(to bottom, #e11d48, #be123c);
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    .message-animation {
        animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .typing-dots {
        display: inline-flex;
        align-items: center;
    }
    .typing-dots span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #6b7280;
        margin: 0 2px;
        animation: typingAnimation 1.4s infinite both;
    }
    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    @keyframes typingAnimation {
        0%, 80%, 100% { 
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% { 
            transform: scale(1);
            opacity: 1;
        }
    }
    .analysis-table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
        font-size: 0.9em;
    }
    .analysis-table th, .analysis-table td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }
    .analysis-table th {
        background-color: #f3f4f6;
        font-weight: 600;
    }
    .analysis-table tr:hover {
        background-color: #f9fafb;
    }
    .quick-action-btn {
        padding: 0.4rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        transition: all 0.2s;
        white-space: nowrap;
        border: none;
        cursor: pointer;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const chatHistory = document.getElementById('chat-history');
        const typingIndicator = document.getElementById('typing-indicator');
        const clearChatBtn = document.getElementById('clear-chat');
        const quickActionBtns = document.querySelectorAll('.quick-action-btn');
        
        // Load chat history from localStorage if available
        loadChatHistory();
        
        // Function to add a message to chat history
        function addMessage(sender, message, timestamp = new Date()) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start', 'message-animation');
            
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('p-3', 'rounded-lg', 'max-w-[90%]', 'shadow-sm');
            
            if (sender === 'user') {
                messageBubble.classList.add('bg-blue-600', 'text-white');
                messageBubble.innerHTML = `
                    <div class="font-medium">You</div>
                    <div class="mt-1">${message}</div>
                    <div class="text-xs text-blue-200 mt-2">${formatTime(timestamp)}</div>
                `;
            } else {
                messageBubble.classList.add('bg-gray-200', 'text-gray-800');
                messageBubble.innerHTML = `
                    <div class="font-medium">Powerball AI</div>
                    <div class="mt-1">${message}</div>
                    <div class="text-xs text-gray-500 mt-2">${formatTime(timestamp)}</div>
                `;
            }
            
            messageDiv.appendChild(messageBubble);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Scroll to bottom
            
            // Save to localStorage
            saveChatHistory();
        }
        
        // Format time for display
        function formatTime(date) {
            const now = new Date();
            const messageTime = new Date(date);
            const diffInMinutes = Math.floor((now - messageTime) / 60000);
            
            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes} min ago`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours} hr ago`;
            
            return messageTime.toLocaleDateString() + ' ' + messageTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        // Save chat history to localStorage
        function saveChatHistory() {
            const messages = [];
            const messageElements = chatHistory.querySelectorAll('.flex.justify-start, .flex.justify-end');
            
            messageElements.forEach(el => {
                const isUser = el.classList.contains('justify-end');
                const content = el.querySelector('.mt-1').textContent;
                const timestamp = el.querySelector('.text-xs').textContent;
                
                messages.push({
                    sender: isUser ? 'user' : 'ai',
                    content: content,
                    timestamp: timestamp
                });
            });
            
            localStorage.setItem('powerballChatHistory', JSON.stringify(messages));
        }
        
        // Load chat history from localStorage
        function loadChatHistory() {
            const savedHistory = localStorage.getItem('powerballChatHistory');
            if (savedHistory) {
                const messages = JSON.parse(savedHistory);
                
                // Clear the default messages
                chatHistory.innerHTML = '';
                
                messages.forEach(msg => {
                    addMessage(msg.sender, msg.content);
                });
            }
        }
        
        // Clear chat history
        function clearChatHistory() {
            if (confirm('Are you sure you want to clear the chat history?')) {
                chatHistory.innerHTML = '';
                localStorage.removeItem('powerballChatHistory');
                
                // Add the initial AI message
                addMessage('ai', 'Hello! I\'m your Advanced Powerball AI Assistant. I can help you analyze Powerball data with advanced queries.');
            }
        }
        
        // Function to send message to AI backend
async function getAIResponse(message) {
    try {
        // Show typing indicator
        typingIndicator.classList.remove('hidden');
        
        // Call the backend API
        const response = await fetch('/api/ai-assistant/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: message })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Handle object responses by converting them to strings
            if (typeof data.response === 'object') {
                if (data.response.white_balls && data.response.powerball) {
                    // Format Powerball numbers response
                    return `Here are your generated Powerball numbers:<br><br>
                            White Balls: ${data.response.white_balls.join(', ')}<br>
                            Powerball: <span class="powerball-ball red-ball">${data.response.powerball}</span>`;
                }
                // Generic object handling
                return JSON.stringify(data.response);
            }
            return data.response;
        } else {
            return `Sorry, I encountered an error: ${data.error}`;
        }
    } catch (error) {
        console.error('Error communicating with AI:', error);
        return 'Oops! I encountered an error. Please try again later.';
    } finally {
        // Hide typing indicator
        typingIndicator.classList.add('hidden');
    }
}
        // Function to send message to AI
        async function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            addMessage('user', message);
            userInput.value = ''; // Clear input

            try {
                const response = await getAIResponse(message);
                addMessage('ai', response);
            } catch (error) {
                console.error('Error communicating with AI:', error);
                addMessage('ai', 'Oops! I encountered an error. Please try again later.');
            }
        }
        
        // Handle quick action buttons
        quickActionBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const action = this.getAttribute('data-action');
                let message = '';
                
                switch(action) {
                    case 'four-white':
                        message = 'Find Powerball draws where the same four white balls appeared multiple times in 2024';
                        break;
                    case 'frequency':
                        message = 'Show me white ball numbers with frequency 8 in 2024';
                        break;
                    case 'pairs':
                        message = 'What are the most common number pairs in 2024?';
                        break;
                    case 'generate':
                        message = 'Generate some Powerball numbers for me';
                        break;
                }
                
                userInput.value = message;
                sendMessage();
            });
        });
        
        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
        clearChatBtn.addEventListener('click', clearChatHistory);
    });
</script>
{% endblock %}
