<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Powerball Pattern Analysis 2019-2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }
        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }
        .header p {
            font-size: 1.2em;
            margin: 10px 0 0 0;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        .controls {
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid #dee2e6;
        }
        .control-section {
            margin-bottom: 20px;
        }
        .control-label {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #495057;
        }
        .year-tabs, .pattern-tabs {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .tab {
            padding: 12px 24px;
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .tab.active {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,123,255,0.3);
        }
        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .pattern-tab {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .pattern-tab.active {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        .download-btn {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(40,167,69,0.3);
        }
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(40,167,69,0.4);
        }
        .content {
            padding: 25px;
        }
        .month-section {
            margin-bottom: 35px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .month-header {
            background: linear-gradient(135deg, #343a40 0%, #23272b 100%);
            color: white;
            padding: 20px 25px;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .month-count {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: normal;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        th {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }
        td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
        }
        tr:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transform: scale(1.001);
            transition: all 0.2s ease;
        }
        .numbers {
            font-weight: bold;
            color: #007bff;
            padding: 4px 8px;
            background: rgba(0,123,255,0.1);
            border-radius: 15px;
            margin: 2px;
            display: inline-block;
        }
        .powerball {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(220,53,69,0.3);
        }
        .matches {
            font-weight: bold;
            color: #28a745;
            text-align: left;
            padding-left: 15px;
        }
        .pattern-highlight {
            padding: 2px 6px;
            border-radius: 10px;
            margin: 2px;
            display: inline-block;
            font-size: 12px;
            font-weight: bold;
        }
        .same-digit { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; }
        .decade { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; }
        .consecutive { background: linear-gradient(135deg, #fd7e14 0%, #e65100 100%); color: white; }
        .repeated { background: linear-gradient(135deg, #6f42c1 0%, #495057 100%); color: white; }
        
        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            font-style: italic;
            background: white;
            font-size: 18px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #007bff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-label {
            color: #6c757d;
            margin-top: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        .yearly-summary {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #2196f3;
        }
        .summary-title {
            font-size: 18px;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 15px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .summary-month {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 5px;
        }
        .summary-count {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }
        .pattern-legend {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }
        .legend-items {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        @media (max-width: 768px) {
            .year-tabs, .pattern-tabs {
                justify-content: center;
            }
            .tab {
                padding: 10px 15px;
                font-size: 14px;
            }
            .download-btn {
                margin-top: 10px;
                width: 100%;
            }
            .month-header {
                flex-direction: column;
                gap: 10px;
            }
            table {
                font-size: 14px;
            }
            th, td {
                padding: 8px 5px;
            }
            .legend-items {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Advanced Powerball Pattern Analysis</h1>
            <p>Multi-Pattern Analysis: Same Digits ‚Ä¢ Decade Groups ‚Ä¢ Consecutive Numbers ‚Ä¢ Repeated Patterns (2019-2026)</p>
        </div>
        
        <div class="controls">
            <div class="control-section">
                <div class="control-label">üìÖ Select Year:</div>
                <div class="year-tabs">
                    <button class="tab active" onclick="showYear(2026)">2026</button>
                    <button class="tab" onclick="showYear(2025)">2025</button>
                    <button class="tab" onclick="showYear(2024)">2024</button>
                    <button class="tab" onclick="showYear(2023)">2023</button>
                    <button class="tab" onclick="showYear(2022)">2022</button>
                    <button class="tab" onclick="showYear(2021)">2021</button>
                    <button class="tab" onclick="showYear(2020)">2020</button>
                    <button class="tab" onclick="showYear(2019)">2019</button>
                </div>
            </div>
            
            <div class="control-section">
                <div class="control-label">üîç Select Pattern Type:</div>
                <div class="pattern-tabs">
                    <button class="tab pattern-tab active" onclick="showPattern('all')">All Patterns</button>
                    <button class="tab pattern-tab" onclick="showPattern('same-digit')">Same Last Digit</button>
                    <button class="tab pattern-tab" onclick="showPattern('decade')">Decade Groups</button>
                    <button class="tab pattern-tab" onclick="showPattern('consecutive')">Consecutive Numbers</button>
                    <button class="tab pattern-tab" onclick="showPattern('repeated')">Repeated Patterns</button>
                </div>
            </div>
            
            <button class="download-btn" onclick="downloadExcel()">üìä Download Complete Multi-Pattern Analysis</button>
            <button class="download-btn" onclick="showAddDrawForm()" style="margin-left: 10px; background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%);">‚ûï Add New Draw Result</button>
        </div>
        
        <!-- Add Draw Form (initially hidden) -->
        <div id="add-draw-form" style="display: none; padding: 25px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-top: 2px solid #dee2e6;">
            <h3 style="color: #495057; margin-bottom: 20px;">Add New Powerball Draw Result</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Draw Date (YYYY-MM-DD):</label>
                    <input type="date" id="draw-date" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 5px;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Number 1:</label>
                    <input type="number" id="num1" min="1" max="69" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 5px;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Number 2:</label>
                    <input type="number" id="num2" min="1" max="69" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 5px;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Number 3:</label>
                    <input type="number" id="num3" min="1" max="69" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 5px;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Number 4:</label>
                    <input type="number" id="num4" min="1" max="69" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 5px;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Number 5:</label>
                    <input type="number" id="num5" min="1" max="69" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 5px;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Powerball (1-26):</label>
                    <input type="number" id="powerball" min="1" max="26" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 5px;">
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="addNewDraw()" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600;">Add Draw</button>
                <button onclick="hideAddDrawForm()" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600;">Cancel</button>
                <button onclick="showBulkImport()" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600;">Bulk Import</button>
            </div>
            <div id="add-draw-message" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
        </div>
        
        <!-- Bulk Import Form (initially hidden) -->
        <div id="bulk-import-form" style="display: none; padding: 25px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-top: 2px solid #2196f3;">
            <h3 style="color: #1976d2; margin-bottom: 20px;">Bulk Import Draw Results</h3>
            <p style="margin-bottom: 15px; color: #495057;">
                Paste draw results in the format: Date&lt;tab&gt;Num1&lt;tab&gt;Num2&lt;tab&gt;Num3&lt;tab&gt;Num4&lt;tab&gt;Num5&lt;tab&gt;Powerball<br>
                Example: 2025-10-01&lt;tab&gt;5&lt;tab&gt;15&lt;tab&gt;25&lt;tab&gt;35&lt;tab&gt;45&lt;tab&gt;12
            </p>
            <textarea id="bulk-data" rows="8" style="width: 100%; padding: 15px; border: 2px solid #dee2e6; border-radius: 5px; font-family: monospace;" placeholder="2025-10-01	5	15	25	35	45	12
2025-10-04	7	17	27	37	47	8"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="importBulkData()" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600;">Import Data</button>
                <button onclick="hideBulkImport()" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600;">Cancel</button>
                <button onclick="exportCurrentData()" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600;">Export Current Data</button>
            </div>
            <div id="bulk-import-message" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
        </div>
        
        <div class="content">
            <div class="pattern-legend">
                <div class="legend-title">üìã Pattern Definitions:</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="pattern-highlight same-digit">Same Digit</span>
                        <span>Numbers ending in same digit (15, 25, 35)</span>
                    </div>
                    <div class="legend-item">
                        <span class="pattern-highlight decade">Decade</span>
                        <span>Numbers in same decade (20-29, 30-39)</span>
                    </div>
                    <div class="legend-item">
                        <span class="pattern-highlight consecutive">Consecutive</span>
                        <span>Sequential numbers (12, 13, 14)</span>
                    </div>
                    <div class="legend-item">
                        <span class="pattern-highlight repeated">Repeated</span>
                        <span>Double digits (11, 22, 33, 44)</span>
                    </div>
                </div>
            </div>
            
            <div class="stats" id="stats">
                <!-- Stats will be populated by JavaScript -->
            </div>
            
            <div class="yearly-summary" id="yearly-summary">
                <!-- Yearly summary will be populated by JavaScript -->
            </div>
            
            <div id="data-container">
                <!-- Data will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ Supabase config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const SUPABASE_URL  = 'https://yksxzbbcoitehdmsxqex.supabase.co';
        const SUPABASE_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlrc3h6YmJjb2l0ZWhkbXN4cWV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NzMwNjUsImV4cCI6MjA2NTM0OTA2NX0.AzUD7wjR7VbvtUH27NDqJ3AlvFW0nCWpiN9ADG8T_t4';
        const TABLE_NAME    = 'powerball_draws';

        
        let allData = [];
        let currentYear = 2026;
        let currentPattern = 'all';

        async function loadFromSupabase() {
            allData = [];
            let offset = 0;
            const limit = 1000;

            try {
                while (true) {
                    const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=Draw+Date,Number+1,Number+2,Number+3,Number+4,Number+5,Powerball&order=Draw+Date.asc&offset=${offset}&limit=${limit}`;
                    const res = await fetch(url, {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': 'Bearer ' + SUPABASE_KEY
                        }
                    });

                    if (!res.ok) throw new Error(`Supabase error: ${res.status}`);
                    const chunk = await res.json();
                    if (!chunk.length) break;

                    chunk.forEach(row => {
                        allData.push({
                            date:      row['Draw Date'],
                            numbers:   [
                                parseInt(row['Number 1']),
                                parseInt(row['Number 2']),
                                parseInt(row['Number 3']),
                                parseInt(row['Number 4']),
                                parseInt(row['Number 5'])
                            ],
                            powerball: parseInt(row['Powerball'])
                        });
                    });

                    offset += limit;
                }

                console.log(`‚úÖ Loaded ${allData.length} draws from Supabase`);
            } catch (err) {
                console.error('‚ùå Failed to load from Supabase:', err);
                document.getElementById('data-container').innerHTML =
                    '<p style="color:red;padding:20px;">Failed to load draw data. Please check your connection.</p>';
            }
        }

        function findSameLastDigitMatches(numbers) {
            const digitGroups = {};
            const matches = [];
            
            // Group numbers by their last digit
            numbers.forEach(num => {
                const lastDigit = num % 10;
                if (!digitGroups[lastDigit]) {
                    digitGroups[lastDigit] = [];
                }
                digitGroups[lastDigit].push(num);
            });
            
            // Find groups with 2 or more numbers
            Object.keys(digitGroups).forEach(digit => {
                if (digitGroups[digit].length >= 2) {
                    matches.push({
                        type: 'same-digit',
                        digit: parseInt(digit),
                        numbers: digitGroups[digit],
                        count: digitGroups[digit].length
                    });
                }
            });
            
            return matches;
        }

        function findDecadeMatches(numbers) {
            const decadeGroups = {};
            const matches = [];
            
            // Group numbers by decade (10s, 20s, 30s, etc.)
            numbers.forEach(num => {
                const decade = Math.floor(num / 10) * 10;
                if (!decadeGroups[decade]) {
                    decadeGroups[decade] = [];
                }
                decadeGroups[decade].push(num);
            });
            
            // Find groups with 2 or more numbers
            Object.keys(decadeGroups).forEach(decade => {
                if (decadeGroups[decade].length >= 2) {
                    matches.push({
                        type: 'decade',
                        decade: parseInt(decade),
                        numbers: decadeGroups[decade],
                        count: decadeGroups[decade].length
                    });
                }
            });
            
            return matches;
        }

        function findConsecutiveMatches(numbers) {
            const sortedNumbers = [...numbers].sort((a, b) => a - b);
            const matches = [];
            
            // Find consecutive sequences
            let currentSequence = [sortedNumbers[0]];
            
            for (let i = 1; i < sortedNumbers.length; i++) {
                if (sortedNumbers[i] === sortedNumbers[i-1] + 1) {
                    currentSequence.push(sortedNumbers[i]);
                } else {
                    if (currentSequence.length >= 2) {
                        matches.push({
                            type: 'consecutive',
                            numbers: [...currentSequence],
                            count: currentSequence.length
                        });
                    }
                    currentSequence = [sortedNumbers[i]];
                }
            }
            
            // Check the last sequence
            if (currentSequence.length >= 2) {
                matches.push({
                    type: 'consecutive',
                    numbers: [...currentSequence],
                    count: currentSequence.length
                });
            }
            
            return matches;
        }

        function findRepeatedPatterns(numbers) {
            const matches = [];
            
            // Find double digits (11, 22, 33, etc.)
            numbers.forEach(num => {
                const tens = Math.floor(num / 10);
                const ones = num % 10;
                
                if (tens === ones && num >= 11) {
                    matches.push({
                        type: 'repeated',
                        pattern: 'double-digit',
                        number: num,
                        count: 1
                    });
                }
            });
            
            // Group by pattern type
            const groupedMatches = {};
            matches.forEach(match => {
                if (!groupedMatches[match.pattern]) {
                    groupedMatches[match.pattern] = [];
                }
                groupedMatches[match.pattern].push(match.number);
            });
            
            // Format the results
            const result = [];
            Object.keys(groupedMatches).forEach(pattern => {
                if (groupedMatches[pattern].length >= 1) {
                    result.push({
                        type: 'repeated',
                        pattern: pattern,
                        numbers: groupedMatches[pattern],
                        count: groupedMatches[pattern].length
                    });
                }
            });
            
            return result;
        }

        function analyzePatterns(draw) {
            const patterns = [];
            
            // Check for all pattern types
            patterns.push(...findSameLastDigitMatches(draw.numbers));
            patterns.push(...findDecadeMatches(draw.numbers));
            patterns.push(...findConsecutiveMatches(draw.numbers));
            patterns.push(...findRepeatedPatterns(draw.numbers));
            
            return patterns;
        }

        function analyzeYear(year, patternType = 'all') {
            const yearData = allData.filter(draw => draw.date.startsWith(year.toString()));
            const monthlyData = {};
            
            // Initialize months
            for (let month = 1; month <= 12; month++) {
                monthlyData[month] = [];
            }
            
            yearData.forEach(draw => {
                const month = parseInt(draw.date.split('-')[1]);
                const patterns = analyzePatterns(draw);
                
                // Filter patterns based on selected type
                const filteredPatterns = patternType === 'all' 
                    ? patterns 
                    : patterns.filter(p => p.type === patternType);
                
                if (filteredPatterns.length > 0) {
                    monthlyData[month].push({
                        ...draw,
                        patterns: filteredPatterns
                    });
                }
            });
            
            return monthlyData;
        }

        function showYear(year) {
            currentYear = year;
            
            // Update tab styles
            document.querySelectorAll('.year-tabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayData(year, currentPattern);
        }

        function showPattern(patternType) {
            currentPattern = patternType;
            
            // Update tab styles
            document.querySelectorAll('.pattern-tabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayData(currentYear, patternType);
        }

        function displayData(year, patternType) {
            const yearData = analyzeYear(year, patternType);
            const container = document.getElementById('data-container');
            const statsContainer = document.getElementById('stats');
            const summaryContainer = document.getElementById('yearly-summary');
            
            // Calculate stats
            let totalMatches = 0;
            let patternCounts = {
                'same-digit': 0,
                'decade': 0,
                'consecutive': 0,
                'repeated': 0
            };
            
            Object.values(yearData).forEach(monthData => {
                totalMatches += monthData.length;
                
                // Count patterns by type - only count draws that have the pattern, not individual pattern instances
                monthData.forEach(draw => {
                    const patternTypes = new Set();
                    draw.patterns.forEach(pattern => {
                        patternTypes.add(pattern.type);
                    });
                    // Only count each pattern type once per draw
                    patternTypes.forEach(type => {
                        patternCounts[type]++;
                    });
                });
            });
            
            const allYearDraws = allData.filter(draw => draw.date.startsWith(year.toString())).length;
            const percentage = allYearDraws > 0 ? ((totalMatches / allYearDraws) * 100).toFixed(1) : '0.0';
            
            // Calculate best and worst months
            let bestMonth = 1, bestCount = 0;
            Object.entries(yearData).forEach(([month, data]) => {
                if (data.length > bestCount) {
                    bestCount = data.length;
                    bestMonth = month;
                }
            });
            
            const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Update stats based on pattern type
            let statsHtml = '';
            
            if (patternType === 'all') {
                statsHtml = `
                    <div class="stat-card">
                        <div class="stat-number">${totalMatches}</div>
                        <div class="stat-label">Total Pattern Matches in ${year}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${allYearDraws}</div>
                        <div class="stat-label">Total Draws in ${year}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${percentage}%</div>
                        <div class="stat-label">Pattern Frequency Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${monthNames[bestMonth]} (${bestCount})</div>
                        <div class="stat-label">Best Month for Patterns</div>
                    </div>
                `;
            } else {
                const patternName = patternType === 'same-digit' ? 'Same Last Digit' :
                                  patternType === 'decade' ? 'Decade Groups' :
                                  patternType === 'consecutive' ? 'Consecutive Numbers' : 'Repeated Patterns';
                
                const patternPercentage = allYearDraws > 0 ? ((patternCounts[patternType] / allYearDraws) * 100).toFixed(1) : '0.0';
                
                statsHtml = `
                    <div class="stat-card">
                        <div class="stat-number">${patternCounts[patternType]}</div>
                        <div class="stat-label">${patternName} Matches in ${year}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${allYearDraws}</div>
                        <div class="stat-label">Total Draws in ${year}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${patternPercentage}%</div>
                        <div class="stat-label">${patternName} Frequency</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${monthNames[bestMonth]} (${bestCount})</div>
                        <div class="stat-label">Best Month for ${patternName}</div>
                    </div>
                `;
            }
            
            statsContainer.innerHTML = statsHtml;
            
            // Create yearly summary
            summaryContainer.innerHTML = `
                <div class="summary-title">üìÖ ${year} Monthly Breakdown - Pattern Match Counts</div>
                <div class="summary-grid">
                    ${Object.entries(yearData).map(([month, data]) => `
                        <div class="summary-item">
                            <div class="summary-month">${monthNames[month]}</div>
                            <div class="summary-count">${data.length}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            let html = '';
            
            const fullMonthNames = [
                '', 'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            for (let month = 1; month <= 12; month++) {
                const monthData = yearData[month];
                
                html += `<div class="month-section">
                    <div class="month-header">
                        ${fullMonthNames[month]} ${year}
                        <span class="month-count">${monthData.length} pattern matches found</span>
                    </div>`;
                
                if (monthData.length > 0) {
                    html += `<table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Numbers</th>
                                <th>Powerball</th>
                                <th>Pattern Matches</th>
                                <th>Total Pattern Count</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    
                    monthData.forEach(draw => {
                        const numbersHtml = draw.numbers.map(num => `<span class="numbers">${num}</span>`).join(' ');
                        
                        const patternsHtml = draw.patterns.map(pattern => {
                            let patternText = '';
                            let patternClass = '';
                            
                            switch (pattern.type) {
                                case 'same-digit':
                                    patternText = `Same Last Digit ${pattern.digit}: ${pattern.numbers.join(', ')}`;
                                    patternClass = 'same-digit';
                                    break;
                                case 'decade':
                                    patternText = `Decade ${pattern.decade}s: ${pattern.numbers.join(', ')}`;
                                    patternClass = 'decade';
                                    break;
                                case 'consecutive':
                                    patternText = `Consecutive: ${pattern.numbers.join(', ')}`;
                                    patternClass = 'consecutive';
                                    break;
                                case 'repeated':
                                    patternText = `Repeated ${pattern.pattern}: ${pattern.numbers.join(', ')}`;
                                    patternClass = 'repeated';
                                    break;
                            }
                            
                            return `<span class="pattern-highlight ${patternClass}">${patternText}</span>`;
                        }).join('<br>');
                        
                        const totalPatternCount = draw.patterns.reduce((sum, pattern) => sum + pattern.count, 0);
                        
                        html += `<tr>
                            <td><strong>${draw.date}</strong></td>
                            <td>${numbersHtml}</td>
                            <td><span class="powerball">${draw.powerball}</span></td>
                            <td class="matches">${patternsHtml}</td>
                            <td><strong style="color: #28a745; font-size: 18px;">${totalPatternCount}</strong></td>
                        </tr>`;
                    });
                    
                    html += `</tbody></table>`;
                } else {
                    html += `<div class="no-data">No ${patternType === 'all' ? 'pattern' : patternType} matches found in ${fullMonthNames[month]} ${year}</div>`;
                }
                
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        function downloadExcel() {
            const wb = XLSX.utils.book_new();
            
            // Create data for all years (2019-2026)
            const years = [2019, 2020, 2021, 2022, 2023, 2024, 2025, 2026];
            
            years.forEach(year => {
                const yearData = analyzeYear(year, 'all');
                const worksheetData = [];
                
                // Add headers
                worksheetData.push(['Date', 'Number 1', 'Number 2', 'Number 3', 'Number 4', 'Number 5', 'Powerball', 'Pattern Count', 'Pattern Details']);
                
                const monthNames = [
                    '', 'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                
                for (let month = 1; month <= 12; month++) {
                    const monthData = yearData[month];
                    
                    if (monthData.length > 0) {
                        // Add month separator with count
                        worksheetData.push([`${monthNames[month]} ${year} - ${monthData.length} pattern matches`, '', '', '', '', '', '', '', '']);
                        
                        monthData.forEach(draw => {
                            const patternDetails = draw.patterns.map(pattern => {
                                switch (pattern.type) {
                                    case 'same-digit':
                                        return `Same Last Digit ${pattern.digit}: ${pattern.numbers.join(', ')}`;
                                    case 'decade':
                                        return `Decade ${pattern.decade}s: ${pattern.numbers.join(', ')}`;
                                    case 'consecutive':
                                        return `Consecutive: ${pattern.numbers.join(', ')}`;
                                    case 'repeated':
                                        return `Repeated ${pattern.pattern}: ${pattern.numbers.join(', ')}`;
                                    default:
                                        return '';
                                }
                            }).join(' | ');
                            
                            const totalPatterns = draw.patterns.reduce((sum, pattern) => sum + pattern.count, 0);
                            
                            worksheetData.push([
                                draw.date,
                                draw.numbers[0],
                                draw.numbers[1],
                                draw.numbers[2],
                                draw.numbers[3],
                                draw.numbers[4],
                                draw.powerball,
                                totalPatterns,
                                patternDetails
                            ]);
                        });
                        
                        // Add empty row after each month
                        worksheetData.push(['', '', '', '', '', '', '', '', '']);
                    }
                }
                
                const ws = XLSX.utils.aoa_to_sheet(worksheetData);
                
                // Set column widths
                ws['!cols'] = [
                    {width: 12}, // Date
                    {width: 10}, // Number 1
                    {width: 10}, // Number 2
                    {width: 10}, // Number 3
                    {width: 10}, // Number 4
                    {width: 10}, // Number 5
                    {width: 10}, // Powerball
                    {width: 12}, // Pattern Count
                    {width: 60}  // Pattern Details
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, `${year} Analysis`);
            });
            
            // Add comprehensive summary sheet
            const summaryData = [];
            summaryData.push(['Advanced Powerball Pattern Analysis Summary (2019-2026)', '', '', '', '', '', '']);
            summaryData.push(['Generated on:', new Date().toLocaleDateString(), '', '', '', '', '']);
            summaryData.push(['', '', '', '', '', '', '']);
            
            // Overall statistics
            let grandTotalMatches = 0;
            let grandTotalDraws = 0;
            
            years.forEach(year => {
                const yearData = analyzeYear(year, 'all');
                let yearMatches = 0;
                Object.values(yearData).forEach(monthData => {
                    yearMatches += monthData.length;
                });
                const yearDraws = allData.filter(draw => draw.date.startsWith(year.toString())).length;
                
                grandTotalMatches += yearMatches;
                grandTotalDraws += yearDraws;
                
                const yearPercentage = yearDraws > 0 ? ((yearMatches / yearDraws) * 100).toFixed(1) : '0.0';
                
                summaryData.push([`${year} Statistics:`, '', '', '', '', '', '']);
                summaryData.push(['Total Draws:', yearDraws, '', 'Pattern Matches Found:', yearMatches, 'Percentage:', `${yearPercentage}%`]);
                summaryData.push(['', '', '', '', '', '', '']);
                
                // Monthly breakdown for each year
                summaryData.push([`${year} Monthly Breakdown:`, '', '', '', '', '', '']);
                summaryData.push(['Month', 'Matches', 'Month', 'Matches', 'Month', 'Matches', '']);
                
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                for (let i = 0; i < 4; i++) {
                    const month1 = i * 3;
                    const month2 = i * 3 + 1;
                    const month3 = i * 3 + 2;
                    
                    summaryData.push([
                        monthNames[month1] || '', yearData[month1 + 1] ? yearData[month1 + 1].length : 0,
                        monthNames[month2] || '', yearData[month2 + 1] ? yearData[month2 + 1].length : 0,
                        monthNames[month3] || '', yearData[month3 + 1] ? yearData[month3 + 1].length : 0,
                        ''
                    ]);
                }
                
                summaryData.push(['', '', '', '', '', '', '']);
            });
            
            // Grand totals
            const grandPercentage = grandTotalDraws > 0 ? ((grandTotalMatches / grandTotalDraws) * 100).toFixed(1) : '0.0';
            summaryData.push(['GRAND TOTALS (2019-2026):', '', '', '', '', '', '']);
            summaryData.push(['Total Draws Analyzed:', grandTotalDraws, '', '', '', '', '']);
            summaryData.push(['Total Pattern Matches Found:', grandTotalMatches, '', '', '', '', '']);
            summaryData.push(['Overall Pattern Match Rate:', `${grandPercentage}%`, '', '', '', '', '']);
            summaryData.push(['', '', '', '', '', '', '']);
            
            summaryData.push(['Pattern Analysis Notes:', '', '', '', '', '', '']);
            summaryData.push(['- Same Last Digit: Numbers ending in same digit (15, 25, 35)', '', '', '', '', '', '']);
            summaryData.push(['- Decade Groups: Numbers in same decade (20-29, 30-39)', '', '', '', '', '', '']);
            summaryData.push(['- Consecutive Numbers: Sequential numbers (12, 13, 14)', '', '', '', '', '', '']);
            summaryData.push(['- Repeated Patterns: Double digits (11, 22, 33, 44)', '', '', '', '', '', '']);
            summaryData.push(['- Data covers Powerball draws from 2019-2026', '', '', '', '', '', '']);
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            
            // Download the Excel file
            XLSX.writeFile(wb, 'Advanced_Powerball_Pattern_Analysis_2019-2026.xlsx');
        }

        // Initialize the application ‚Äî load from Supabase then render
        (async () => {
            document.getElementById('data-container').innerHTML =
                '<p style="padding:20px;color:#555;">‚è≥ Loading draw data from database...</p>';
            await loadFromSupabase();
            displayData(currentYear, currentPattern);
        })();

        // Functions for adding new draw data
        function showAddDrawForm() {
            document.getElementById('add-draw-form').style.display = 'block';
            document.getElementById('bulk-import-form').style.display = 'none';
        }

        function hideAddDrawForm() {
            document.getElementById('add-draw-form').style.display = 'none';
            clearAddDrawForm();
        }

        function showBulkImport() {
            document.getElementById('bulk-import-form').style.display = 'block';
            document.getElementById('add-draw-form').style.display = 'none';
        }

        function hideBulkImport() {
            document.getElementById('bulk-import-form').style.display = 'none';
        }

        function clearAddDrawForm() {
            document.getElementById('draw-date').value = '';
            document.getElementById('num1').value = '';
            document.getElementById('num2').value = '';
            document.getElementById('num3').value = '';
            document.getElementById('num4').value = '';
            document.getElementById('num5').value = '';
            document.getElementById('powerball').value = '';
            document.getElementById('add-draw-message').style.display = 'none';
        }

        function showMessage(elementId, message, isError = false) {
            const messageEl = document.getElementById(elementId);
            messageEl.textContent = message;
            messageEl.style.display = 'block';
            messageEl.style.backgroundColor = isError ? '#f8d7da' : '#d4edda';
            messageEl.style.color = isError ? '#721c24' : '#155724';
            messageEl.style.border = isError ? '1px solid #f5c6cb' : '1px solid #c3e6cb';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        function validateDrawData(date, numbers, powerball) {
            if (!date) {
                return 'Please enter a draw date';
            }

            // Check if numbers are valid
            if (numbers.length !== 5) {
                return 'Please enter all 5 main numbers';
            }

            for (let i = 0; i < numbers.length; i++) {
                const num = numbers[i];
                if (isNaN(num) || num < 1 || num > 69) {
                    return `Number ${i + 1} must be between 1 and 69`;
                }
            }

            // Check for duplicate numbers
            const uniqueNumbers = new Set(numbers);
            if (uniqueNumbers.size !== numbers.length) {
                return 'Numbers cannot be duplicated';
            }

            // Check powerball
            if (isNaN(powerball) || powerball < 1 || powerball > 26) {
                return 'Powerball must be between 1 and 26';
            }

            // Check if draw already exists
            const existingDraw = allData.find(draw => draw.date === date);
            if (existingDraw) {
                return `Draw for ${date} already exists`;
            }

            return null; // No errors
        }

        function addNewDraw() {
            const date = document.getElementById('draw-date').value;
            const numbers = [
                parseInt(document.getElementById('num1').value),
                parseInt(document.getElementById('num2').value),
                parseInt(document.getElementById('num3').value),
                parseInt(document.getElementById('num4').value),
                parseInt(document.getElementById('num5').value)
            ];
            const powerball = parseInt(document.getElementById('powerball').value);

            // Validate input
            const validationError = validateDrawData(date, numbers, powerball);
            if (validationError) {
                showMessage('add-draw-message', validationError, true);
                return;
            }

            // Sort numbers for consistency (though not required for Powerball)
            const sortedNumbers = [...numbers].sort((a, b) => a - b);

            // Add to data array
            const newDraw = {
                date: date,
                numbers: sortedNumbers,
                powerball: powerball
            };

            allData.push(newDraw);
            
            // Sort allData by date to maintain chronological order
            allData.sort((a, b) => new Date(a.date) - new Date(b.date));

            showMessage('add-draw-message', `Successfully added draw for ${date}`, false);
            clearAddDrawForm();
            
            // Refresh display if viewing the year of the added draw
            const drawYear = parseInt(date.split('-')[0]);
            if (drawYear === currentYear) {
                displayData(currentYear, currentPattern);
            }
        }

        function importBulkData() {
            const bulkData = document.getElementById('bulk-data').value.trim();
            if (!bulkData) {
                showMessage('bulk-import-message', 'Please enter draw data to import', true);
                return;
            }

            const lines = bulkData.split('\n');
            let successCount = 0;
            let errorCount = 0;
            const errors = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const parts = line.split('\t');
                if (parts.length !== 7) {
                    errors.push(`Line ${i + 1}: Invalid format (expected 7 tab-separated values)`);
                    errorCount++;
                    continue;
                }

                const date = parts[0];
                const numbers = [
                    parseInt(parts[1]),
                    parseInt(parts[2]),
                    parseInt(parts[3]),
                    parseInt(parts[4]),
                    parseInt(parts[5])
                ];
                const powerball = parseInt(parts[6]);

                const validationError = validateDrawData(date, numbers, powerball);
                if (validationError) {
                    errors.push(`Line ${i + 1}: ${validationError}`);
                    errorCount++;
                    continue;
                }

                // Add successful draw
                const sortedNumbers = [...numbers].sort((a, b) => a - b);
                const newDraw = {
                    date: date,
                    numbers: sortedNumbers,
                    powerball: powerball
                };

                allData.push(newDraw);
                successCount++;
            }

            // Sort data after bulk import
            allData.sort((a, b) => new Date(a.date) - new Date(b.date));

            let message = `Import complete: ${successCount} draws added successfully`;
            if (errorCount > 0) {
                message += `, ${errorCount} errors encountered`;
                if (errors.length > 0) {
                    message += `\n\nErrors:\n${errors.slice(0, 5).join('\n')}`;
                    if (errors.length > 5) {
                        message += `\n... and ${errors.length - 5} more errors`;
                    }
                }
            }

            showMessage('bulk-import-message', message, errorCount > 0);
            
            if (successCount > 0) {
                document.getElementById('bulk-data').value = '';
                displayData(currentYear, currentPattern);
            }
        }

        function exportCurrentData() {
            const dataToExport = allData.map(draw => 
                `${draw.date}\t${draw.numbers[0]}\t${draw.numbers[1]}\t${draw.numbers[2]}\t${draw.numbers[3]}\t${draw.numbers[4]}\t${draw.powerball}`
            ).join('\n');

            const header = 'Draw Date\tNumber 1\tNumber 2\tNumber 3\tNumber 4\tNumber 5\tPowerball';
            const fullData = header + '\n' + dataToExport;

            // Create and download file
            const blob = new Blob([fullData], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `powerball_data_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showMessage('bulk-import-message', 'Data exported successfully', false);
        }
    </script>
</body>
</html>
