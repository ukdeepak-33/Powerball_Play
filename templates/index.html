{% extends "base.html" %}

{% block title %}Powerball Analysis{% endblock %}

{% block page_heading %}Powerball Number Generator & Analysis{% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8"> {# Added max-width and padding for better layout #}
    {# Flash messages display #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages space-y-3">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-md text-sm {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif category == 'info' %}bg-blue-100 text-blue-700 border border-blue-200{% else %}bg-green-100 text-green-700 border border-green-200{% endif %} animate-fade-in"> {# Enhanced styling and animation #}\
                        <p class="font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {# Latest Powerball Draw Card #}
    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200"> {# Updated rounded and shadow #}
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Latest Powerball Draw</h2>
        <div class="flex flex-wrap items-center space-x-2 mb-4">
            <span class="text-gray-600 text-lg font-medium mr-2">Draw Date:</span>
            <span class="text-blue-700 font-bold text-lg" id="latestDrawDate">{{ last_draw.get('Draw Date', 'N/A') }}</span>
        </div>
        <div class="flex flex-wrap items-center space-x-2 space-y-2 sm:space-y-0">
            <span class="text-gray-600 text-lg font-medium">Numbers:</span>
            {% for num in last_draw.get('Numbers', []) %}
                {% if num != 'N/A' %}
                    <span class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-500 text-white text-xl font-bold shadow-md">{{ num }}</span>
                {% endif %}
            {% endfor %}
            <span class="text-gray-600 text-lg font-medium ml-4">Powerball:</span>
            <span class="flex items-center justify-center w-10 h-10 rounded-full bg-red-500 text-white text-xl font-bold shadow-md powerball-ball">{{ last_draw.get('Powerball', 'N/A') }}</span>
        </div>
    </div>

    {# NEW: Record Official Draw Card #}
    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Record Official Draw</h2>
        <p class="text-gray-700 mb-6">Manually enter the latest official Powerball draw results to keep the historical data up-to-date. This will update the main historical database.</p>
        <form method="POST" action="{{ url_for('save_official_draw_route') }}" class="space-y-4">
            <div class="form-group">
                <label for="draw_date" class="block text-gray-700 text-sm font-bold mb-2">Draw Date:</label>
                <input type="date" id="draw_date" name="draw_date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>
            <div class="grid grid-cols-5 gap-4">
                <div class="form-group">
                    <label for="n1" class="block text-gray-700 text-sm font-bold mb-2">N1:</label>
                    <input type="number" id="n1" name="n1" min="1" max="69" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="form-group">
                    <label for="n2" class="block text-gray-700 text-sm font-bold mb-2">N2:</label>
                    <input type="number" id="n2" name="n2" min="1" max="69" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="form-group">
                    <label for="n3" class="block text-gray-700 text-sm font-bold mb-2">N3:</label>
                    <input type="number" id="n3" name="n3" min="1" max="69" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="form-group">
                    <label for="n4" class="block text-gray-700 text-sm font-bold mb-2">N4:</label>
                    <input type="number" id="n4" name="n4" min="1" max="69" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="form-group">
                    <label for="n5" class="block text-gray-700 text-sm font-bold mb-2">N5:</label>
                    <input type="number" id="n5" name="n5" min="1" max="69" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
            </div>
            <div class="form-group">
                <label for="pb" class="block text-gray-700 text-sm font-bold mb-2">Powerball:</label>
                <input type="number" id="pb" name="pb" min="1" max="26" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out w-full sm:w-auto">
                Record Official Draw
            </button>
        </form>
    </div>

    {# General Number Generator Card #}
    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">General Number Generator</h2>
        <p class="text-gray-700 mb-6">Generate random Powerball numbers based on basic criteria.</p>
        <form method="POST" action="{{ url_for('generate') }}" class="space-y-4"> 
            <div class="form-group">
                <label for="num_sets_to_generate" class="block text-gray-700 text-sm font-bold mb-2">Number of Sets to Generate (1-10):</label>
                <input type="number" id="num_sets_to_generate" name="num_sets_to_generate" min="1" max="10" value="{{ num_sets_to_generate if num_sets_to_generate else 1 }}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>

            <div class="form-group">
                <label for="white_ball_min" class="block text-gray-700 text-sm font-bold mb-2">White Ball Range (Min 1 - Max 69):</label>
                <div class="flex space-x-4">
                    <input type="number" id="white_ball_min" name="white_ball_min" min="1" max="69" value="1" placeholder="Min" class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <input type="number" id="white_ball_max" name="white_ball_max" min="1" max="69" value="69" placeholder="Max" class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <p class="text-xs text-gray-500 mt-1">Set the minimum and maximum for white balls (default: 1-69).</p>
            </div>

            <div class="form-group">
                <label for="powerball_min" class="block text-gray-700 text-sm font-bold mb-2">Powerball Range (Min 1 - Max 26):</label>
                <div class="flex space-x-4">
                    <input type="number" id="powerball_min" name="powerball_min" min="1" max="26" value="1" placeholder="Min" class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <input type="number" id="powerball_max" name="powerball_max" min="1" max="26" value="26" placeholder="Max" class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <p class="text-xs text-gray-500 mt-1">Set the minimum and maximum for the Powerball (default: 1-26).</p>
            </div>

            <div class="form-group">
                <label for="excluded_numbers" class="block text-gray-700 text-sm font-bold mb-2">Excluded Numbers (comma-separated):</label>
                <input type="text" id="excluded_numbers" name="excluded_numbers" placeholder="e.g., 7, 14, 21" value="{{ excluded_numbers if excluded_numbers else '' }}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <p class="text-xs text-gray-500 mt-1">Numbers to explicitly exclude from generation.</p>
            </div>

            <div class="form-group">
                <label for="odd_even_choice" class="block text-gray-700 text-sm font-bold mb-2">Odd/Even Split Preference:</label>
                <select id="odd_even_choice" name="odd_even_choice" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="Any" {% if selected_odd_even_choice == "Any" %}selected{% endif %}>Any Split (Random)</option>
                    <option value="All Even" {% if selected_odd_even_choice == "All Even" %}selected{% endif %}>All Even (5 Even / 0 Odd)</option>
                    <option value="All Odd" {% if selected_odd_even_choice == "All Odd" %}selected{% endif %}>All Odd (5 Odd / 0 Even)</option>
                    <option value="3 Even / 2 Odd" {% if selected_odd_even_choice == "3 Even / 2 Odd" %}selected{% endif %}>3 Even / 2 Odd</option>
                    <option value="2 Even / 3 Odd" {% if selected_odd_even_choice == "2 Even / 3 Odd" %}selected{% endif %}>2 Even / 3 Odd</option>
                    <option value="1 Even / 4 Odd" {% if selected_odd_even_choice == "1 Even / 4 Odd" %}selected{% endif %}>1 Even / 4 Odd</option>
                    <option value="4 Even / 1 Odd" {% if selected_odd_even_choice == "4 Even / 1 Odd" %}selected{% endif %}>4 Even / 1 Odd</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="sum_range_filter" class="block text-gray-700 text-sm font-bold mb-2">Sum Range Filter:</label>
                <select id="sum_range_filter" name="sum_range_filter" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="Any" {% if selected_sum_range == "Any" %}selected{% endif %}>Any Sum</option>
                    {% for label, _ in sum_ranges.items() %}
                        {% if label != "Any" %}
                            <option value="{{ label }}" {% if selected_sum_range == label %}selected{% endif %}>{{ label }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out w-full sm:w-auto">
                Generate Numbers
            </button>
        </form>

        {% if generated_sets and generation_type == 'generated' %}
            <h3 class="text-2xl font-bold mt-8 mb-4 text-gray-800">Generated Picks</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="generalGeneratedPicksList"> {# Added ID here #}
                {% for pick in generated_sets %}
                <div class="bg-white p-4 rounded-lg shadow flex items-center justify-between flex-wrap generated-pick-item"
                     data-white-balls="{{ pick.white_balls | join(',') }}"
                     data-powerball="{{ pick.powerball }}">
                    <div class="flex items-center space-x-2 mb-2 md:mb-0">
                        {% for num in pick.white_balls %}
                            <span class="ball-sm bg-blue-500 text-white">{{ num }}</span>
                        {% endfor %}
                        <span class="ball-sm powerball-ball bg-red-500 text-white ml-2">{{ pick.powerball }}</span>
                    </div>
                    <button type="button" class="save-general-pick-btn bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded-lg">Save Pick</button> {# Changed to type="button" #}
                </div>
                {% endfor %}
            </div>
            <div class="mt-4 p-4 bg-gray-100 rounded-lg text-gray-700 text-sm">
                <h4 class="font-semibold mb-2">Last Drawn Dates for Your Numbers:</h4>
                <ul class="list-disc list-inside">
                    {% for number, date in last_draw_dates.items() %}
                        <li>{{ number }}: {{ date }}</li>
                    {% endfor %}
                </ul>
            </div>
            {# NEW: Save All Button for General Generator #}
            <div class="mt-6 text-center">
                <button type="button" id="saveAllGeneralPicksBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Save All Generated Picks
                </button>
            </div>
        {% endif %}
    </div>

    {# User Provided Pair Generator Card #}
    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Generate with User Provided Pair</h2>
        <p class="text-gray-700 mb-6">Start your pick with two specific white balls, and the generator will complete the set with three ascending numbers.</p>
        <form method="POST" action="{{ url_for('generate_with_user_pair_route') }}" class="space-y-4">
            <div class="form-group">
                <label for="user_pair" class="block text-gray-700 text-sm font-bold mb-2">Starting Pair (e.g., 10, 11):</label>
                <input type="text" id="user_pair" name="user_pair" placeholder="e.g., 18, 19" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                <p class="text-xs text-gray-500 mt-1">Enter two white balls, comma-separated. The remaining three will be higher and ascending.</p>
            </div>
            <div class="form-group">
                <label for="excluded_numbers_pair" class="block text-gray-700 text-sm font-bold mb-2">Excluded Numbers (comma-separated):</label>
                <input type="text" id="excluded_numbers_pair" name="excluded_numbers_pair" placeholder="e.g., 4, 18, 55" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <p class="text-xs text-gray-500 mt-1">Numbers to explicitly exclude from generation for this strategy.</p>
            </div>
            <div class="form-group">
                <label for="sum_range_filter_pair" class="block text-gray-700 text-sm font-bold mb-2">Sum Range Filter:</label>
                <select id="sum_range_filter_pair" name="sum_range_filter_pair" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="Any" {% if selected_sum_range_pair == "Any" %}selected{% endif %}>Any Sum</option>
                    {% for label, _ in sum_ranges.items() %}
                        {% if label != "Any" %}
                            <option value="{{ label }}" {% if selected_sum_range_pair == label %}selected{% endif %}>{{ label }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out w-full sm:w-auto">
                Generate with Pair
            </button>
        </form>

        {% if generated_sets and generation_type == 'user_pair' %}
            <h3 class="text-2xl font-bold mt-8 mb-4 text-gray-800">Generated Pick with Pair</h3>
            <div class="bg-white p-4 rounded-lg shadow flex items-center justify-between flex-wrap">
                <div class="flex items-center space-x-2 mb-2 md:mb-0">
                    {% for num in generated_sets[0].white_balls %}
                        <span class="ball-sm bg-blue-500 text-white">{{ num }}</span>
                    {% endfor %}
                    <span class="ball-sm powerball-ball bg-red-500 text-white ml-2">{{ generated_sets[0].powerball }}</span>
                </div>
                <form action="{{ url_for('save_generated_pick_route') }}" method="post" class="ml-auto">
                    <input type="hidden" name="generated_white_balls" value="{{ generated_sets[0].white_balls | join(',') }}">
                    <input type="hidden" name="generated_powerball" value="{{ generated_sets[0].powerball }}">
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded-lg">Save Pick</button>
                </form>
            </div>
            <div class="mt-4 p-4 bg-gray-100 rounded-lg text-gray-700 text-sm">
                <h4 class="font-semibold mb-2">Last Drawn Dates for Your Numbers:</h4>
                <ul class="list-disc list-inside">
                    {% for number, date in last_draw_dates.items() %}
                        <li>{{ number }}: {{ date }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
    </div>

    {# Group A Strategy Generator Card #}
    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Generate with Group A Strategy</h2>
        <p class="text-gray-700 mb-6">Generate numbers ensuring a specific count of balls from a predefined 'Group A' (e.g., frequently drawn numbers).</p>
        <form method="POST" action="{{ url_for('generate_group_a_strategy_route') }}" class="space-y-4">
            <div class="form-group">
                <label for="num_from_group_a" class="block text-gray-700 text-sm font-bold mb-2">Number of Balls from Group A (0-5):</label>
                <select id="num_from_group_a" name="num_from_group_a" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    {% for i in range(6) %}
                        <option value="{{ i }}" {% if num_from_group_a is defined and num_from_group_a == i %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-1">Select how many white balls you want from the predefined Group A: {{ group_a | join(', ') }}.</p>
            </div>
            <div class="form-group">
                <label for="excluded_numbers_group_a" class="block text-gray-700 text-sm font-bold mb-2">Excluded Numbers (comma-separated):</label>
                <input type="text" id="excluded_numbers_group_a" name="excluded_numbers_group_a" placeholder="e.g., 4, 18, 55" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <p class="text-xs text-gray-500 mt-1">Numbers to explicitly exclude from generation for this strategy.</p>
            </div>
            <div class="form-group">
                <label for="sum_range_filter_group_a" class="block text-gray-700 text-sm font-bold mb-2">Sum Range Filter:</label>
                <select id="sum_range_filter_group_a" name="sum_range_filter_group_a" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="Any" {% if selected_sum_range_group_a == "Any" %}selected{% endif %}>Any Sum</option>
                    {% for label, _ in sum_ranges.items() %}
                        {% if label != "Any" %}
                            <option value="{{ label }}" {% if selected_sum_range_group_a == label %}selected{% endif %}>{{ label }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
    <label class="block text-gray-700 text-sm font-bold mb-2">Current Month Number Preferences:</label>
    <div class="flex flex-col space-y-2">
        <label class="inline-flex items-center">
            <input type="checkbox" name="current_month_preference" value="five_unpicked_same_freq" class="form-checkbox h-5 w-5 text-blue-600 rounded">
            <span class="ml-2 text-gray-700">Five unpicked numbers (with two from same frequency, age â‰¤ 25 draws)</span>
        </label>
        <label class="inline-flex items-center">
            <input type="checkbox" name="current_month_preference" value="one_unpicked_four_picked" class="form-checkbox h-5 w-5 text-blue-600 rounded">
            <span class="ml-2 text-gray-700">One unpicked number + 4 picked numbers from current month</span>
        </label>
        <label class="inline-flex items-center">
            <input type="checkbox" name="current_month_preference" value="two_unpicked_three_picked" class="form-checkbox h-5 w-5 text-blue-600 rounded">
            <span class="ml-2 text-gray-700">Two unpicked numbers + 3 picked numbers from current month</span>
        </label>
        <label class="inline-flex items-center">
            <input type="checkbox" name="current_month_preference" value="two_same_frequency" class="form-checkbox h-5 w-5 text-blue-600 rounded">
            <span class="ml-2 text-gray-700">Two numbers from the same white ball frequency from current year</span>
        </label>
    </div>
    <p class="text-xs text-gray-500 mt-1">Select preferences for including numbers based on current month/year patterns.</p>
</div>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out w-full sm:w-auto">
                Generate with Group A
            </button>
        </form>
        {% if generated_sets and generation_type == 'group_a_strategy' %}
            <h3 class="text-2xl font-bold mt-8 mb-4 text-gray-800">Generated Pick with Group A Strategy</h3>
            <div class="bg-white p-4 rounded-lg shadow flex items-center justify-between flex-wrap">
                <div class="flex items-center space-x-2 mb-2 md:mb-0">
                    {% for num in generated_sets[0].white_balls %}
                        <span class="ball-sm bg-blue-500 text-white">{{ num }}</span>
                    {% endfor %}
                    <span class="ball-sm powerball-ball bg-red-500 text-white ml-2">{{ generated_sets[0].powerball }}</span>
                </div>
                <form action="{{ url_for('save_multiple_generated_picks_route') }}" method="post" class="ml-auto">
                    <input type="hidden" name="generated_white_balls" value="{{ generated_sets[0].white_balls | join(',') }}">
                    <input type="hidden" name="generated_powerball" value="{{ generated_sets[0].powerball }}">
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded-lg">Save Pick</button>
                </form>
            </div>
            <div class="mt-4 p-4 bg-gray-100 rounded-lg text-gray-700 text-sm">
                <h4 class="font-semibold mb-2">Last Drawn Dates for Your Numbers:</h4>
                <ul class="list-disc list-inside">
                    {% for number, date in last_draw_dates.items() %}
                        <li>{{ number }}: {{ date }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
    </div>

    {# Smart Pick Generator Card #}
<div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">Smart Pick Generator</h2>
    <p class="text-gray-700 mb-6">
        Generate Powerball picks with advanced pattern preferences and constraints.
    </p>

    <form method="POST" action="{{ url_for('generate_smart_picks_api') }}" class="space-y-4">
        <div class="form-group">
            <label for="num_smart_sets" class="block text-gray-700 text-sm font-bold mb-2">Number of Picks to Generate (1-5):</label>
            <input type="number" id="num_smart_sets" name="num_smart_sets" min="1" max="5" value="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>

        <div class="form-group">
            <label class="block text-gray-700 text-sm font-bold mb-2">Number Pattern Preferences:</label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="pattern_preference" value="one_unpicked_four_picked" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="ml-2 text-gray-700">1 unpicked + 4 picked (same month)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="pattern_preference" value="two_unpicked_three_picked" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="ml-2 text-gray-700">2 unpicked + 3 picked (same month)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="pattern_preference" value="five_unpicked_same_month" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="ml-2 text-gray-700">5 unpicked numbers (same month)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="pattern_preference" value="four_unpicked_one_picked" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="ml-2 text-gray-700">4 unpicked + 1 picked (same month)</span>
                    </label>
                </div>
                <div class="space-y-2">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="pattern_preference" value="two_same_frequency" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="ml-2 text-gray-700">2 numbers with same frequency</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="pattern_preference" value="three_same_frequency" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="ml-2 text-gray-700">3 numbers with same frequency</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="pattern_preference" value="two_pairs_same_frequency" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <span class="ml-2 text-gray-700">2 pairs from different frequencies</span>
                    </label>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-1">Select pattern preferences for number generation.</p>
        </div>

        <div class="form-group">
            <label for="group_a_numbers_count" class="block text-gray-700 text-sm font-bold mb-2">Numbers from Group A (0-5):</label>
            <select id="group_a_numbers_count" name="group_a_numbers_count" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                {% for i in range(6) %}
                    <option value="{{ i }}">{{ i }} from Group A</option>
                {% endfor %}
            </select>
            <p class="text-xs text-gray-500 mt-1">Select how many balls from Group A: {{ group_a | join(', ') }}</p>
        </div>

        <div class="form-group">
            <label for="odd_even_choice_smart" class="block text-gray-700 text-sm font-bold mb-2">Odd/Even Split Preference:</label>
            <select id="odd_even_choice_smart" name="odd_even_choice_smart" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="Any">Any Split (Random)</option>
                <option value="All Even">All Even (5 Even / 0 Odd)</option>
                <option value="All Odd">All Odd (5 Odd / 0 Even)</option>
                <option value="3 Even / 2 Odd">3 Even / 2 Odd</option>
                <option value="2 Even / 3 Odd">2 Even / 3 Odd</option>
                <option value="1 Even / 4 Odd">1 Even / 4 Odd</option>
                <option value="4 Even / 1 Odd">4 Even / 1 Odd</option>
            </select>
        </div>

        <div class="form-group">
            <label for="sum_range_filter_smart" class="block text-gray-700 text-sm font-bold mb-2">Sum Range Filter:</label>
            <select id="sum_range_filter_smart" name="sum_range_filter_smart" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="Any">Any Sum</option>
                {% for label, _ in sum_ranges.items() %}
                    {% if label != "Any" %}
                        <option value="{{ label }}">{{ label }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="excluded_numbers_smart" class="block text-gray-700 text-sm font-bold mb-2">Excluded Numbers (comma-separated):</label>
            <input type="text" id="excluded_numbers_smart" name="excluded_numbers_smart" placeholder="e.g., 4, 18, 55" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            <p class="text-xs text-gray-500 mt-1">Numbers to explicitly exclude from generation.</p>
        </div>

        <button id="generatePicksBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-300 ease-in-out">
           Generate Smart Picks
        </button>
    </form>

    {% if generated_sets and generation_type == 'smart_pick' %}
        <h3 class="text-2xl font-bold mt-8 mb-4 text-gray-800">Your Smart Picks</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% for pick in generated_sets %}
            <div class="bg-white p-4 rounded-lg shadow flex items-center justify-between flex-wrap">
                <div class="flex items-center space-x-2 mb-2 md:mb-0">
                    {% for num in pick.white_balls %}
                        <span class="ball-sm bg-blue-500 text-white">{{ num }}</span>
                    {% endfor %}
                    <span class="ball-sm powerball-ball bg-red-500 text-white ml-2">{{ pick.powerball }}</span>
                </div>
                <form action="{{ url_for('save_multiple_generated_picks_route') }}" method="post" class="ml-auto">
                    <input type="hidden" name="generated_white_balls" value="{{ pick.white_balls | join(',') }}">
                    <input type="hidden" name="generated_powerball" value="{{ pick.powerball }}">
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded-lg">Save Pick</button>
                </form>
            </div>
            {% endfor %}
        </div>
        
        {% if last_draw_dates %}
        <div class="mt-4 p-4 bg-gray-100 rounded-lg text-gray-700 text-sm">
            <h4 class="font-semibold mb-2">Last Drawn Dates for Your Numbers:</h4>
            <ul class="list-disc list-inside">
                {% for number, date in last_draw_dates.items() %}
                    <li>{{ number }}: {{ date }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        <div class="mt-6 text-center">
            <form action="{{ url_for('save_multiple_generated_picks_route') }}" method="post">
                {% for pick in generated_sets %}
                    <input type="hidden" name="picks" value="{{ {'white_balls': pick.white_balls, 'powerball': pick.powerball} | tojson }}">
                {% endfor %}
                <button id="saveAllPicksBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-300 ease-in-out">
                  Save All Generated Picks
                </button>    
            </form>
        </div>
    {% endif %}
</div>

<style>
    /* Add some basic styles for the number balls */
    .ball-sm {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px; /* Slightly smaller */
        height: 36px;
        border-radius: 50%;
        font-size: 0.9rem; /* Adjusted font size */
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .powerball-ball {
        background-color: #ef4444; /* Red-500 */
    }

    /* Basic fade-in animation for flash messages */
    @keyframes fade-in {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
        animation: fade-in 0.5s ease-out forwards;
    }
</style>

{# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ENHANCED PICK GENERATOR â€” Add this card to index.html
    Place it after the Smart Pick Generator card section
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}

<div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200 mt-8" id="enhanced-generator-card">

    {# â”€â”€ Header â”€â”€ #}
    <div class="flex items-center justify-between mb-2">
        <h2 class="text-2xl font-bold text-gray-800">âš¡ Enhanced Pick Generator</h2>
        <span class="text-xs bg-indigo-100 text-indigo-700 font-semibold px-3 py-1 rounded-full">AI Powered</span>
    </div>
    <p class="text-gray-600 mb-6 text-sm">
        Generates picks scored by <strong>frequency analysis</strong>, <strong>hot/cold trends</strong>, and <strong>pattern matching</strong>.
        Each set includes a confidence score and reason for every number picked.
    </p>

    {# â”€â”€ Controls â”€â”€ #}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">

        {# Number of sets #}
        <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">Number of Sets (1â€“10)</label>
            <input type="number" id="enh-num-sets" min="1" max="10" value="3"
                   class="shadow border rounded w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-400">
        </div>

        {# Strategy #}
        <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">Generation Strategy</label>
            <select id="enh-strategy"
                    class="shadow border rounded w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                <option value="balanced">âš–ï¸ Balanced (hot + cold + frequency)</option>
                <option value="hot_heavy">ğŸ”¥ Hot Heavy (favour trending numbers)</option>
                <option value="cold_heavy">â„ï¸ Cold Heavy (favour due numbers)</option>
                <option value="pattern_focus">ğŸ”¢ Pattern Focus (consecutive + spread)</option>
            </select>
        </div>

        {# Excluded numbers #}
        <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">Exclude Numbers <span class="font-normal text-gray-400">(comma separated)</span></label>
            <input type="text" id="enh-excluded" placeholder="e.g. 4, 18, 55"
                   class="shadow border rounded w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-400">
        </div>
    </div>

    {# â”€â”€ Generate button â”€â”€ #}
    <button id="enh-generate-btn" onclick="enhGeneratePicks()"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200 flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
        Generate Enhanced Picks
    </button>

    {# â”€â”€ Loading â”€â”€ #}
    <div id="enh-loading" class="hidden mt-4 flex items-center gap-3 text-indigo-600 text-sm font-medium">
        <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        Analyzing historical data and scoring picks...
    </div>

    {# â”€â”€ Error â”€â”€ #}
    <div id="enh-error" class="hidden mt-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm"></div>

    {# â”€â”€ AI Explanation â”€â”€ #}
    <div id="enh-ai-box" class="hidden mt-6 p-4 bg-indigo-50 border border-indigo-200 rounded-xl">
        <div class="flex items-center gap-2 mb-2">
            <span class="text-indigo-600 font-bold text-sm">ğŸ¤– AI Analysis</span>
        </div>
        <p id="enh-ai-text" class="text-gray-700 text-sm leading-relaxed"></p>
    </div>

    {# â”€â”€ Results â”€â”€ #}
    <div id="enh-results" class="hidden mt-6 space-y-4">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold text-gray-800">Generated Picks</h3>
            <button onclick="enhSaveAll()"
                    class="text-sm bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-4 rounded-lg transition">
                ğŸ’¾ Save All
            </button>
        </div>
        <div id="enh-picks-list" class="space-y-4"></div>
    </div>

</div>

{# â”€â”€ Styles for Enhanced Generator â”€â”€ #}
<style>
    .enh-ball {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 38px;
        height: 38px;
        border-radius: 50%;
        font-weight: 700;
        font-size: 14px;
        color: white;
        flex-shrink: 0;
    }
    .enh-ball-white { background: #3b82f6; }
    .enh-ball-hot   { background: #ef4444; }
    .enh-ball-cold  { background: #06b6d4; }
    .enh-ball-pb    { background: #ef4444; border: 2px solid #b91c1c; }

    .enh-tag {
        display: inline-block;
        font-size: 10px;
        font-weight: 600;
        padding: 1px 7px;
        border-radius: 20px;
        border: 1px solid;
        white-space: nowrap;
    }
    .enh-tag-hot  { background: rgba(239,68,68,0.1);  color: #dc2626; border-color: #fca5a5; }
    .enh-tag-cold { background: rgba(6,182,212,0.1);  color: #0891b2; border-color: #a5f3fc; }
    .enh-tag-freq { background: rgba(99,102,241,0.1); color: #4f46e5; border-color: #c7d2fe; }
    .enh-tag-pat  { background: rgba(16,185,129,0.1); color: #059669; border-color: #a7f3d0; }
    .enh-tag-neu  { background: rgba(107,114,128,0.1);color: #4b5563; border-color: #d1d5db; }

    .enh-confidence-bar {
        height: 6px;
        border-radius: 3px;
        background: #e5e7eb;
        overflow: hidden;
    }
    .enh-confidence-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.6s ease;
    }

    .enh-pick-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        transition: box-shadow 0.2s;
    }
    .enh-pick-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
</style>

{# â”€â”€ JavaScript â”€â”€ #}
<script>
    let enhCurrentSets = [];

    function enhTagClass(tag) {
        if (tag.includes('ğŸ”¥') || tag.includes('Hot'))    return 'enh-tag-hot';
        if (tag.includes('â„ï¸') || tag.includes('Cold'))   return 'enh-tag-cold';
        if (tag.includes('frequency'))                     return 'enh-tag-freq';
        if (tag.includes('Consecutive') || tag.includes('Decade') || tag.includes('pair')) return 'enh-tag-pat';
        return 'enh-tag-neu';
    }

    function enhBallClass(num, hotNums, coldNums) {
        if (hotNums.includes(num))  return 'enh-ball enh-ball-hot';
        if (coldNums.includes(num)) return 'enh-ball enh-ball-cold';
        return 'enh-ball enh-ball-white';
    }

    function enhConfidenceColor(score) {
        if (score >= 75) return '#10b981'; // green
        if (score >= 55) return '#f59e0b'; // amber
        return '#ef4444';                  // red
    }

    function enhConfidenceLabel(score) {
        if (score >= 75) return 'â­ Strong';
        if (score >= 55) return 'âœ… Good';
        if (score >= 40) return 'ğŸ”µ Fair';
        return 'âšª Weak';
    }

    async function enhGeneratePicks() {
        const numSets  = parseInt(document.getElementById('enh-num-sets').value) || 3;
        const strategy = document.getElementById('enh-strategy').value;
        const excluded = document.getElementById('enh-excluded').value
            .split(',').map(s => s.trim()).filter(s => /^\d+$/.test(s)).map(Number);

        // Reset UI
        document.getElementById('enh-loading').classList.remove('hidden');
        document.getElementById('enh-error').classList.add('hidden');
        document.getElementById('enh-results').classList.add('hidden');
        document.getElementById('enh-ai-box').classList.add('hidden');
        document.getElementById('enh-generate-btn').disabled = true;

        try {
            const res = await fetch('/api/generate_enhanced_picks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ num_sets: numSets, strategy, excluded_numbers: excluded })
            });
            const data = await res.json();

            if (!data.success) {
                throw new Error(data.error || 'Unknown error');
            }

            enhCurrentSets = data.sets;
            enhRenderPicks(data.sets, data.total_draws);

            // Show AI explanation if available
            if (data.ai_explanation) {
                document.getElementById('enh-ai-text').textContent = data.ai_explanation;
                document.getElementById('enh-ai-box').classList.remove('hidden');
            }

            document.getElementById('enh-results').classList.remove('hidden');

        } catch (err) {
            document.getElementById('enh-error').textContent = 'Error: ' + err.message;
            document.getElementById('enh-error').classList.remove('hidden');
        } finally {
            document.getElementById('enh-loading').classList.add('hidden');
            document.getElementById('enh-generate-btn').disabled = false;
        }
    }

    function enhRenderPicks(sets, totalDraws) {
        const container = document.getElementById('enh-picks-list');
        container.innerHTML = '';

        sets.forEach((pick, idx) => {
            const color = enhConfidenceColor(pick.confidence_score);
            const label = enhConfidenceLabel(pick.confidence_score);

            // Build balls HTML
            let ballsHtml = pick.white_balls.map(n => {
                const cls  = enhBallClass(n, pick.hot_numbers, pick.cold_numbers);
                const tags = (pick.reason_tags[String(n)] || []).slice(0, 2)
                    .map(t => `<span class="enh-tag ${enhTagClass(t)}">${t}</span>`).join('');
                return `
                    <div class="flex flex-col items-center gap-1">
                        <div class="${cls}">${n}</div>
                        <div class="flex flex-wrap gap-1 justify-center" style="max-width:60px">${tags}</div>
                    </div>`;
            }).join('');

            // Powerball
            ballsHtml += `
                <div class="flex flex-col items-center gap-1 ml-2">
                    <div class="enh-ball enh-ball-pb">${pick.powerball}</div>
                    <div class="flex flex-wrap gap-1 justify-center" style="max-width:60px">
                        <span class="enh-tag enh-tag-neu">${pick.pb_reason.replace(' PB','')}</span>
                    </div>
                </div>`;

            const card = document.createElement('div');
            card.className = 'enh-pick-card';
            card.innerHTML = `
                <div class="p-4">
                    <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                        <span class="text-sm font-bold text-gray-500">SET ${idx + 1}</span>
                        <div class="flex items-center gap-3">
                            <div style="min-width:140px">
                                <div class="flex justify-between text-xs text-gray-500 mb-1">
                                    <span>Confidence</span>
                                    <span style="color:${color};font-weight:700">${pick.confidence_score}% ${label}</span>
                                </div>
                                <div class="enh-confidence-bar">
                                    <div class="enh-confidence-fill" style="width:${pick.confidence_score}%;background:${color}"></div>
                                </div>
                            </div>
                            <button onclick="enhSaveOne(${idx})"
                                    class="text-xs bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg transition">
                                Save
                            </button>
                        </div>
                    </div>
                    <div class="flex items-start flex-wrap gap-3">${ballsHtml}</div>
                </div>
                <div class="px-4 py-2 bg-gray-50 border-t border-gray-100 text-xs text-gray-400">
                    ğŸ”´ Hot number &nbsp;|&nbsp; ğŸ”µ Cold number &nbsp;|&nbsp; ğŸ”µ Regular
                    &nbsp;&nbsp;Â·&nbsp;&nbsp; Analyzed against ${totalDraws.toLocaleString()} historical draws
                </div>`;

            container.appendChild(card);
        });
    }

    async function enhSaveOne(idx) {
        const pick = enhCurrentSets[idx];
        if (!pick) return;
        await enhSavePick(pick.white_balls, pick.powerball);
    }

    async function enhSaveAll() {
        if (!enhCurrentSets.length) return;
        for (const pick of enhCurrentSets) {
            await enhSavePick(pick.white_balls, pick.powerball);
        }
        alert(`âœ… ${enhCurrentSets.length} picks saved successfully!`);
    }

    async function enhSavePick(whiteBalls, powerball) {
        const form = new FormData();
        form.append('generated_white_balls', whiteBalls.join(','));
        form.append('generated_powerball', powerball);
        try {
            await fetch("{{ url_for('save_multiple_generated_picks_route') }}", {
                method: 'POST', body: form
            });
        } catch (e) {
            console.error('Save error:', e);
        }
    }
</script>

    
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const generateSmartPicksBtn = document.getElementById('generateSmartPicksBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const smartPicksResults = document.getElementById('smartPicksResults');
        const saveAllSmartPicksActions = document.getElementById('saveAllSmartPicksActions');
        const flashMessagesDiv = document.querySelector('.flash-messages');

        // NEW: Elements for General Generator "Save All"
        const generalGeneratedPicksList = document.getElementById('generalGeneratedPicksList');
        const saveAllGeneralPicksBtn = document.getElementById('saveAllGeneralPicksBtn');
        const saveAllPicksBtn = document.getElementById('saveAllPicksBtn');
    if (saveAllPicksBtn) {
        saveAllPicksBtn.addEventListener('click', async function() {
            const generatedSetsContainer = document.getElementById('generated-picks-container');
            const pickElements = generatedSetsContainer.querySelectorAll('.generated-pick-item');
            
            if (pickElements.length === 0) {
                showFlashMessage('No numbers generated to save.', 'error');
                return;
            }

            const picksToSave = [];
            pickElements.forEach(item => {
                const whiteBallsStr = item.dataset.whiteBalls;
                const powerballStr = item.dataset.powerball;
                const whiteBalls = whiteBallsStr.split(',').map(Number);
                const powerball = Number(powerballStr);
                picksToSave.push({ white_balls: whiteBalls, powerball: powerball });
            });

            await saveMultiplePicks(picksToSave);
        });
    }


        // showFlashMessage is defined globally below

        // --- Smart Pick Generator Logic (unchanged) ---
        generateSmartPicksBtn.addEventListener('click', async function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Generating...';
            loadingIndicator.classList.remove('hidden');
            smartPicksResults.classList.add('hidden'); // Hide previous results
            saveAllSmartPicksActions.classList.add('hidden'); // Hide save all button

            const numSets = document.getElementById('num_smart_sets').value;
            // Removed prioritizeMonthlyHot
            const prioritizeGroupedPatterns = document.getElementById('prioritize_grouped_patterns').checked;
            const prioritizeSpecialPatterns = document.getElementById('prioritize_special_patterns').checked;
            const prioritizeConsecutivePatterns = document.getElementById('prioritize_consecutive_patterns').checked;
            const preferenceOneUnpicked = document.getElementById('preference_one_unpicked').checked;
            const preferenceTwoUnpicked = document.getElementById('preference_two_unpicked').checked;
            const preferenceTwoSameFrequency = document.getElementById('preference_two_same_frequency').checked;
            const groupANumbersCount = document.getElementById('group_a_numbers_count').value;
            const oddEvenChoiceSmart = document.getElementById('odd_even_choice_smart').value;
            const sumRangeFilterSmart = document.getElementById('sum_range_filter_smart').value;
            const excludedNumbersSmart = document.getElementById('excluded_numbers_smart').value;
            // Removed forceSpecificPatternInput

            const payload = {
                num_sets_to_generate: parseInt(numSets),
                prioritize_monthly_hot: false, // Set to false as the field is removed
                prioritize_grouped_patterns: prioritizeGroupedPatterns,
                prioritize_special_patterns: prioritizeSpecialPatterns,
                prioritize_consecutive_patterns: prioritizeConsecutivePatterns,
                num_from_group_a: parseInt(groupANumbersCount),
                odd_even_choice: oddEvenChoiceSmart,
                sum_range_filter: sumRangeFilterSmart,
                excluded_numbers: excludedNumbersSmart,
                preference_one_unpicked: preferenceOneUnpicked,
                preference_two_unpicked: preferenceTwoUnpicked,
                preference_two_same_frequency: preferenceTwoSameFrequency,
                force_specific_pattern: '' // Set to empty as the field is removed   
            };

            try {
                const response = await fetch('/api/generate_smart_picks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' // Crucial: tell the server we're sending JSON
                    },
                    body: JSON.stringify(payload) // Convert JavaScript object to JSON string
                });

                const data = await response.json();

                if (response.ok) {
                    smartPicksResults.innerHTML = '<h3 class="text-3xl font-bold text-white text-center mb-6">Your Smart Picks!</h3>';
                    if (data.generated_sets && data.generated_sets.length > 0) {
                        data.generated_sets.forEach(pick => {
                            const pickHtml = `
                                <div class="bg-blue-700 p-4 rounded-lg shadow-md flex items-center justify-between flex-wrap generated-pick-item"
                                     data-white-balls="${pick.white_balls.join(',')}"
                                     data-powerball="${pick.powerball}">
                                    <div class="flex items-center space-x-2 mb-2 md:mb-0">
                                        ${pick.white_balls.map(num => `<span class="ball-sm bg-blue-400 text-white">${num}</span>`).join('')}
                                        <span class="ball-sm powerball-ball bg-red-400 text-white ml-2">${pick.powerball}</span>
                                    </div>
                                    <button type="button" class="save-single-pick-btn bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded-lg">Save Pick</button>
                                </div>
                            `;
                            smartPicksResults.insertAdjacentHTML('beforeend', pickHtml);
                        });

                        // Add Last Drawn Dates
                        if (data.last_draw_dates && Object.keys(data.last_draw_dates).length > 0) {
                            let lastDrawDatesHtml = '<div class="mt-4 p-4 bg-blue-800 rounded-lg text-white text-sm"><h4 class="font-semibold mb-2">Last Drawn Dates:</h4><ul class="list-disc list-inside">';
                            for (const [number, date] of Object.entries(data.last_draw_dates)) {
                                lastDrawDatesHtml += `<li>${number}: ${date}</li>`;
                            }
                            lastDrawDatesHtml += '</ul></div>';
                            smartPicksResults.insertAdjacentHTML('beforeend', lastDrawDatesHtml);
                        }

                        smartPicksResults.classList.remove('hidden');
                        saveAllSmartPicksActions.classList.remove('hidden');

                        // Attach event listeners to newly created save buttons
                        document.querySelectorAll('.save-single-pick-btn').forEach(button => {
                            button.addEventListener('click', function() {
                                const item = this.closest('.generated-pick-item');
                                const whiteBalls = item.dataset.whiteBalls.split(',').map(Number);
                                const powerball = parseInt(item.dataset.powerball);
                                saveMultiplePicks([{ white_balls: whiteBalls, powerball: powerball }]);
                            });
                        });

                    } else {
                        smartPicksResults.innerHTML = '<p class="text-white text-center">No picks could be generated with the selected criteria. Try adjusting your filters.</p>';
                        smartPicksResults.classList.remove('hidden');
                    }
                } else {
                    // Handle server-side errors (e.g., ValueError from Flask)
                    showFlashMessage(data.error || 'An unknown error occurred during generation.', 'error');
                }
            } catch (error) {
                console.error('Error generating smart picks:', error);
                showFlashMessage(`An unexpected error occurred: ${error.message}`, 'error');
                smartPicksResults.classList.remove('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'p-8', 'rounded-2xl', 'shadow-xl'); // Remove gradient on error
                saveAllSmartPicksActions.classList.add('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Smart Picks';
                loadingIndicator.classList.add('hidden');
            }
        });

        // --- Smart Generated Numbers - Save All Button Logic ---
        const saveAllSmartPicksBtn = document.getElementById('saveAllSmartPicksBtn');
        if (saveAllSmartPicksBtn) {
            saveAllSmartPicksBtn.addEventListener('click', function() {
                const allSmartPickItems = document.querySelectorAll('#smartPicksResults .generated-pick-item');
                const picksToSave = [];
                allSmartPickItems.forEach(item => {
                    const whiteBallsStr = item.dataset.whiteBalls;
                    const powerballStr = item.dataset.powerball;
                    if (whiteBallsStr && powerballStr) {
                        picksToSave.push({
                            white_balls: whiteBallsStr.split(',').map(Number),
                            powerball: Number(powerballStr)
                        });
                    }
                });
                saveMultiplePicks(picksToSave);
            });
        }

        // --- NEW: General Generator Save All Button Logic ---
        if (saveAllGeneralPicksBtn) {
            saveAllGeneralPicksBtn.addEventListener('click', function() {
                const allGeneralPickItems = document.querySelectorAll('#generalGeneratedPicksList .generated-pick-item'); // Use new ID
                const picksToSave = [];
                allGeneralPickItems.forEach(item => {
                    const whiteBallsStr = item.dataset.whiteBalls;
                    const powerballStr = item.dataset.powerball;
                    if (whiteBallsStr && powerballStr) {
                        picksToSave.push({
                            white_balls: whiteBallsStr.split(',').map(Number),
                            powerball: Number(powerballStr)
                        });
                    }
                });
                saveMultiplePicks(picksToSave);
            });
        }

       // --- Function to Save Multiple Picks (global scope) ---
async function saveMultiplePicks(picks) {
    try {
        const response = await fetch('/save_multiple_generated_picks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({picks: picks})
        });

        const data = await response.json();

        if (response.ok) {
            showFlashMessage(data.message || 'Picks saved successfully!', 'info');
        } else {
            showFlashMessage(data.message || 'Error saving picks.', 'error');
        }
    } catch (error) {
        console.error('Error saving picks:', error);
        showFlashMessage(`An unexpected error occurred while saving: ${error.message}`, 'error');
    }
}

// --- Global showFlashMessage (accessible everywhere) ---
function showFlashMessage(message, category) {
    const flashMessagesDiv = document.querySelector('.flash-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `p-4 rounded-lg shadow-md text-sm ${
        category === 'error' ? 'bg-red-100 text-red-700 border border-red-200' :
        category === 'info'  ? 'bg-blue-100 text-blue-700 border border-blue-200' :
                               'bg-green-100 text-green-700 border border-green-200'
    }`;
    messageDiv.innerHTML = `<p class="font-medium">${message}</p>`;

    if (flashMessagesDiv) {
        flashMessagesDiv.innerHTML = '';
        flashMessagesDiv.appendChild(messageDiv);
        // Scroll to top so user sees the message
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        // Create container if it doesn't exist
        const container = document.createElement('div');
        container.className = 'flash-messages space-y-3 mb-4';
        const mainArea = document.querySelector('main') || document.body;
        mainArea.prepend(container);
        container.appendChild(messageDiv);
    }

    // Auto-dismiss after 4 seconds
    setTimeout(() => { messageDiv.remove(); }, 4000);
}

// --- Save individual general picks ---
document.body.addEventListener('click', async function(event) {
    if (event.target.classList.contains('save-general-pick-btn')) {
        const pickItem = event.target.closest('.generated-pick-item');
        if (pickItem) {
            const whiteBalls = pickItem.dataset.whiteBalls.split(',').map(Number);
            const powerball  = Number(pickItem.dataset.powerball);
            event.target.textContent = 'Saving...';
            event.target.disabled = true;
            await saveMultiplePicks([{ white_balls: whiteBalls, powerball: powerball }]);
            event.target.textContent = 'âœ“ Saved';
            event.target.classList.replace('bg-green-500', 'bg-gray-400');
        }
    }
});
</script>
{% endblock %}
