{% extends "base.html" %}

{% block title %}Grouped Patterns Analysis{% endblock %}

{% block page_heading %}Grouped Patterns Analysis{% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {# Flash messages display #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages space-y-3">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-md text-sm {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif category == 'info' %}bg-blue-100 text-blue-700 border border-blue-200{% else %}bg-green-100 text-green-700 border border-green-200{% endif %} animate-fade-in">
                        <p class="font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Overall Grouped Patterns (Pairs & Triplets)</h2>
        <p class="text-gray-600 mb-6">This section displays the frequency of number pairs and triplets that appear within specific 'tens' ranges (e.g., 1-9, 10-19, etc.) across all historical draws. Patterns are grouped by their range and type (Pair/Triplet).</p>

        <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-4 sm:space-y-0">
            <div class="flex-1">
                <label for="patternTypeFilter" class="block text-gray-700 text-sm font-bold mb-2">Filter by Type:</label>
                <select id="patternTypeFilter" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white border-gray-300">
                    <option value="all">All Patterns</option>
                    <option value="Pair">Pairs Only</option>
                    <option value="Triplet">Triplets Only</option>
                </select>
            </div>
            <div class="flex-1">
                <label for="sortOrderSelect" class="block text-gray-700 text-sm font-bold mb-2">Sort By:</label>
                <select id="sortOrderSelect" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white border-gray-300">
                    <option value="count_desc">Most Frequent First</option>
                    <option value="count_asc">Least Frequent First</option>
                    <option value="pattern_asc">Pattern Numbers Ascending</option>
                    <option value="range_asc">Range Ascending</option>
                </select>
            </div>
        </div>


        <div id="patternsDisplay" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {# Patterns will be rendered here by JavaScript #}
            <p class="text-gray-600 col-span-full text-center">Loading patterns...</p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const patternsData = {{ patterns_data | tojson }};
        const patternsDisplay = document.getElementById('patternsDisplay');
        const patternTypeFilter = document.getElementById('patternTypeFilter');
        const sortOrderSelect = document.getElementById('sortOrderSelect');

        function renderPatterns() {
            const selectedType = patternTypeFilter.value;
            const selectedSortOrder = sortOrderSelect.value;

            let filteredPatterns = patternsData;

            if (selectedType !== 'all') {
                filteredPatterns = patternsData.filter(p => p.type === selectedType);
            }

            // Apply sorting
            filteredPatterns.sort((a, b) => {
                if (selectedSortOrder === 'count_desc') {
                    // Primary sort: count descending
                    if (b.count !== a.count) return b.count - a.count;
                    // Secondary sort: pattern numbers ascending
                    return a.pattern[0] - b.pattern[0] || (a.pattern[1] !== undefined ? a.pattern[1] - b.pattern[1] : 0) || (a.pattern[2] !== undefined ? a.pattern[2] - b.pattern[2] : 0);
                } else if (selectedSortOrder === 'count_asc') {
                    // Primary sort: count ascending
                    if (a.count !== b.count) return a.count - b.count;
                    // Secondary sort: pattern numbers ascending
                    return a.pattern[0] - b.pattern[0] || (a.pattern[1] !== undefined ? a.pattern[1] - b.pattern[1] : 0) || (a.pattern[2] !== undefined ? a.pattern[2] - b.pattern[2] : 0);
                } else if (selectedSortOrder === 'pattern_asc') {
                    // Primary sort: pattern numbers ascending
                    if (a.pattern[0] !== b.pattern[0]) return a.pattern[0] - b.pattern[0];
                    if (a.pattern[1] !== undefined && b.pattern[1] !== undefined && a.pattern[1] !== b.pattern[1]) return a.pattern[1] - b.pattern[1];
                    if (a.pattern[2] !== undefined && b.pattern[2] !== undefined && a.pattern[2] !== b.pattern[2]) return a.pattern[2] - b.pattern[2];
                    // Secondary sort: count descending
                    return b.count - a.count;
                } else if (selectedSortOrder === 'range_asc') {
                    // Primary sort: range name ascending (alphabetical)
                    if (a.range < b.range) return -1;
                    if (a.range > b.range) return 1;
                    // Secondary sort: count descending
                    return b.count - a.count;
                }
                return 0; // No change if sort order is not recognized
            });

            patternsDisplay.innerHTML = ''; // Clear previous content

            if (filteredPatterns.length > 0) {
                filteredPatterns.forEach(pattern => {
                    const patternElement = document.createElement('div');
                    patternElement.className = 'bg-blue-50 p-4 rounded-lg shadow-sm flex flex-col space-y-2';
                    
                    let ballsHtml = pattern.pattern.map(num => `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-600 text-white text-sm font-bold">${num}</span>`).join('');

                    patternElement.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-semibold text-blue-800 bg-blue-200 px-2 py-1 rounded-full">${pattern.range} - ${pattern.type}</span>
                            <span class="text-gray-800 font-semibold">Appeared: ${pattern.count} times</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            ${ballsHtml}
                        </div>
                    `;
                    patternsDisplay.appendChild(patternElement);
                });
            } else {
                patternsDisplay.innerHTML = '<p class="text-gray-600 col-span-full text-center">No patterns found matching your criteria.</p>';
            }
        }

        // Add event listeners for filters and sorting
        patternTypeFilter.addEventListener('change', renderPatterns);
        sortOrderSelect.addEventListener('change', renderPatterns);

        // Initial render
        renderPatterns();
    });
</script>
{% endblock %}
