{% extends "base.html" %}

{% block title %}White Ball Gap Analysis{% endblock %}

{% block page_heading %}White Ball Gap Analysis & Trends{% endblock %}

{% block head %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            position: relative;
            height: 450px; /* Adjust height as needed for better visibility */
            width: 100%;
            overflow-x: auto; /* Allow horizontal scrolling if many bars */
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #6366f1; /* Tailwind indigo-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styling for the balls */
        .ball-display {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 2.2rem;
            height: 2.2rem;
            border-radius: 50%;
            background-color: #6366f1; /* Indigo */
            color: white;
            font-weight: bold;
            font-size: 1rem;
            margin: 0.15rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
    </style>
{% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {# Flash messages display #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages space-y-3 mb-4">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-md text-sm {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif category == 'info' %}bg-blue-100 text-blue-700 border border-blue-200{% else %}bg-green-100 text-green-700 border border-green-200{% endif %} animate-fade-in">
                        <p class="font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Analyze White Ball Appearance Gaps</h2>
        
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 items-end">
            <div>
                <label for="whiteBallNumber" class="block text-sm font-medium text-gray-700 mb-1">White Ball Number</label>
                <select id="whiteBallNumber" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    {% for i in range(1, 70) %}
                    <option value="{{ i }}" {% if i == 1 %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="year" class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                <select id="year" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    {% for y in years %}
                    <option value="{{ y }}" {% if y == current_datetime.year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="sm:col-span-1">
                <button id="fetchGapDataBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition ease-in-out duration-150">
                    Analyze Gaps
                </button>
            </div>
        </div>

        <div id="loadingIndicator" class="hidden flex justify-center items-center py-4">
            <div class="loading-spinner"></div>
            <span class="ml-3 text-gray-600">Loading gap analysis...</span>
        </div>

        <div id="errorMessage" class="hidden p-4 rounded-lg shadow-md text-sm bg-red-100 text-red-700 border border-red-200 animate-fade-in"></div>

        <div id="averageGap" class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-blue-800 text-sm font-medium hidden mb-4"></div>

        <div class="chart-container border border-gray-200 rounded-lg bg-gray-50 p-4">
            <canvas id="gapBarChart"></canvas>
            <div id="noDataMessage" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 text-gray-500 text-lg font-medium hidden">
                Select a number and year to view its gap analysis.
            </div>
        </div>
    </div>

    <script>
        const whiteBallNumberSelect = document.getElementById('whiteBallNumber');
        const yearSelect = document.getElementById('year');
        const fetchGapDataBtn = document.getElementById('fetchGapDataBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessageDiv = document.getElementById('errorMessage');
        const gapBarChartCanvas = document.getElementById('gapBarChart');
        const noDataMessageDiv = document.getElementById('noDataMessage');
        const averageGapDiv = document.getElementById('averageGap');

        let gapChart; // To hold the Chart.js instance

        async function fetchAndRenderGapData() {
            errorMessageDiv.classList.add('hidden');
            noDataMessageDiv.classList.add('hidden');
            averageGapDiv.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            
            if (gapChart) {
                gapChart.destroy();
                gapChart = null;
            }

            const selectedNumber = whiteBallNumberSelect.value;
            const selectedYear = yearSelect.value;

            try {
                const response = await fetch(`/api/white_ball_gaps?number=${selectedNumber}&year=${selectedYear}`);
                const data = await response.json();

                if (!response.ok || !data.success) {
                    errorMessageDiv.textContent = data.error || `Failed to fetch gap data for White Ball ${selectedNumber} in ${selectedYear}.`;
                    errorMessageDiv.classList.remove('hidden');
                    noDataMessageDiv.classList.remove('hidden');
                    return;
                }

                const gapsData = data.gaps_data;

                if (gapsData.length === 0) {
                    errorMessageDiv.textContent = `No appearance data for White Ball ${selectedNumber} in ${selectedYear}.`;
                    errorMessageDiv.classList.remove('hidden');
                    noDataMessageDiv.classList.remove('hidden');
                    return;
                }

                const labels = gapsData.map(item => item.draw_date === 'Ongoing' ? `Current Gap` : `${item.draw_date} (Draw #${item.draw_index})`);
                const gaps = gapsData.map(item => item.gap);

                // Calculate average gap, excluding the initial '0' gap and ongoing gap if it's the only one
                const relevantGaps = gaps.filter(g => g > 0);
                const average = relevantGaps.length > 0 ? (relevantGaps.reduce((a, b) => a + b, 0) / relevantGaps.length).toFixed(2) : 'N/A';
                averageGapDiv.innerHTML = `<strong>Average Gap for White Ball ${selectedNumber} in ${selectedYear}:</strong> ${average} draws.`;
                averageGapDiv.classList.remove('hidden');

                const ctx = gapBarChartCanvas.getContext('2d');
                gapChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Gap Length (Draws Missed)`,
                            data: gaps,
                            backgroundColor: (context) => {
                                const value = context.raw;
                                if (value === 0) return 'rgba(75, 192, 192, 0.8)'; // Green for 0 gap
                                if (value <= 3) return 'rgba(54, 162, 235, 0.8)'; // Blue for small gaps
                                if (value <= 7) return 'rgba(255, 206, 86, 0.8)'; // Yellow for medium gaps
                                return 'rgba(255, 99, 132, 0.8)'; // Red for large gaps
                            },
                            borderColor: (context) => {
                                const value = context.raw;
                                if (value === 0) return 'rgba(75, 192, 192, 1)';
                                if (value <= 3) return 'rgba(54, 162, 235, 1)';
                                if (value <= 7) return 'rgba(255, 206, 86, 1)';
                                return 'rgba(255, 99, 132, 1)';
                            },
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 14,
                                        family: 'Inter, sans-serif'
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return `Appearance on ${gapsData[context[0].dataIndex].draw_date}`;
                                    },
                                    label: function(context) {
                                        let label = 'Gap: ';
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y + ' draws missed';
                                        }
                                        return label;
                                    },
                                    afterLabel: function(context) {
                                        const drawIndex = gapsData[context.dataIndex].draw_index;
                                        if (gapsData[context.dataIndex].draw_date === 'Ongoing') {
                                            return 'Number last seen before this current gap.';
                                        }
                                        return `Draw Index: ${drawIndex}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Draw Appearance (Chronological Order)',
                                    font: {
                                        size: 14,
                                        weight: 'bold',
                                        family: 'Inter, sans-serif'
                                    }
                                },
                                ticks: {
                                    autoSkip: true,
                                    maxRotation: 45,
                                    minRotation: 45,
                                    font: {
                                        family: 'Inter, sans-serif'
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Draws Missed (Gap Length)',
                                    font: {
                                        size: 14,
                                        weight: 'bold',
                                        family: 'Inter, sans-serif'
                                    }
                                },
                                ticks: {
                                    precision: 0, // Show whole numbers for gaps
                                    font: {
                                        family: 'Inter, sans-serif'
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error fetching/rendering data:', error);
                errorMessageDiv.textContent = `An error occurred: ${error.message}.`;
                errorMessageDiv.classList.remove('hidden');
                noDataMessageDiv.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        fetchGapDataBtn.addEventListener('click', fetchAndRenderGapData);

        // Initial render when the page loads, using default selected values
        window.onload = function() {
            fetchAndRenderGapData();
        };

    </script>
{% endblock %}
