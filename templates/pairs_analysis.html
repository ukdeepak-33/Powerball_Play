{% extends "base.html" %}

{% block title %}Last-Digit Pairs Analysis by Year{% endblock %}

{% block page_heading %}White Ball Pairs by Last Digit (Yearly Breakdown){% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white rounded-xl shadow-lg p-6">
        <p class="text-gray-700 text-lg mb-6">
            This page breaks down all possible white ball pairs by year, grouped by their common last digit. Expand a year to see which pairs were drawn and how many times.
        </p>

        <div id="years-container" class="space-y-8">
            <div id="loading-message" class="text-center text-gray-500">
                Loading data, please wait...
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const yearsContainer = document.getElementById('years-container');

        async function fetchAndRenderYearlyPairs() {
            try {
                const response = await fetch('/api/yearly-pairs-with-draw-counts');
                const yearlyData = await response.json();

                if (!yearlyData || Object.keys(yearlyData).length === 0) {
                    yearsContainer.innerHTML = '<p class="text-red-500 text-center">No pair data available.</p>';
                    return;
                }

                // Remove loading message
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.remove();
                }
                
                // Corrected code: Get the years from the object keys and sort them.
                const sortedYears = Object.keys(yearlyData).sort((a, b) => b - a);

                sortedYears.forEach(year => {
                    const yearData = yearlyData[year];
                    
                    const yearDetails = document.createElement('details');
                    yearDetails.className = 'bg-gray-100 p-4 rounded-lg shadow-sm';
                    
                    const yearSummary = document.createElement('summary');
                    yearSummary.className = 'cursor-pointer font-bold text-xl text-gray-800';
                    yearSummary.textContent = `${year} Pairs Analysis`;
                    yearDetails.appendChild(yearSummary);

                    const yearContentDiv = document.createElement('div');
                    yearContentDiv.className = 'mt-4 space-y-6';

                    // Now, use forEach on the array of data for the specific year.
                    yearData.forEach(group => {
                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'mb-4';
                        
                        const groupTitle = document.createElement('h3');
                        groupTitle.className = 'text-lg font-bold text-gray-700 mb-2';
                        groupTitle.textContent = group.group_name;
                        groupDiv.appendChild(groupTitle);
                        
                        const pairsGrid = document.createElement('div');
                        pairsGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2';

                        group.pairs.forEach(pairData => {
                            const pairSpan = document.createElement('span');
                            pairSpan.className = 'pair-item text-sm text-gray-700';
                            pairSpan.textContent = `(${pairData.pair[0]}, ${pairData.pair[1]})`;
                            
                            if (pairData.hit_count > 0) {
                                let strikeThroughClass = 'strike-one';
                                if (pairData.hit_count === 2) {
                                    strikeThroughClass = 'strike-two';
                                } else if (pairData.hit_count >= 3) {
                                    strikeThroughClass = 'strike-three';
                                }
                                pairSpan.classList.add(strikeThroughClass);
                            }
                            
                            pairsGrid.appendChild(pairSpan);
                        });

                        groupDiv.appendChild(pairsGrid);
                        yearContentDiv.appendChild(groupDiv);
                    });
                    
                    yearDetails.appendChild(yearContentDiv);
                    yearsContainer.appendChild(yearDetails);
                });

            } catch (error) {
                console.error('Error fetching yearly pair data:', error);
                yearsContainer.innerHTML = '<p class="text-red-500 text-center">Failed to load yearly pair analysis data. Please try again later.</p>';
            }
        }

        fetchAndRenderYearlyPairs();
    });
</script>

<style>
    .pair-item {
        white-space: nowrap;
    }

    .strike-one {
        text-decoration: line-through;
        text-decoration-thickness: 1px;
    }
    
    .strike-two {
        text-decoration: line-through;
        text-decoration-thickness: 2px;
    }
    
    .strike-three {
        text-decoration: line-through;
        text-decoration-thickness: 3px;
        color: #ef4444;
    }
</style>
{% endblock %}
