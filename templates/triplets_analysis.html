{% extends "base.html" %}

{% block title %}Triplet Analysis{% endblock %}

{% block page_heading %}White Ball Triplet Analysis{% endblock %}

{% block head %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            position: relative;
            height: 450px; /* Adjust height as needed for better visibility */
            width: 100%;
            overflow-x: auto; /* Allow horizontal scrolling if many bars */
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #6366f1; /* Tailwind indigo-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .ball-sm {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 30px; /* Smaller size */
            height: 30px; /* Smaller size */
            background-color: #f0f0f0;
            border-radius: 50%;
            border: 1px solid #ccc;
            font-weight: bold;
            color: #333;
            margin: 2px;
            font-size: 0.8em; /* Smaller font */
            flex-shrink: 0; /* Prevent shrinking in flex container */
        }
    </style>
{% endblock %}

{% block content %}
<div class="space-y-8 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {# Flash messages display #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages space-y-3 mb-4">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg shadow-md text-sm {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif category == 'info' %}bg-blue-100 text-blue-700 border border-blue-200{% else %}bg-green-100 text-green-700 border border-blue-200{% endif %} animate-fade-in">
                        <p class="font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="card p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Top Triplet Frequencies</h2>
        <p class="text-gray-700 mb-4">This chart displays the frequency of the most common white ball triplets from historical draws.</p>
        <div class="relative h-96 w-full">
            <canvas id="tripletFrequencyChart"></canvas>
            <div id="chartLoadingIndicator" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 hidden">
                <div class="loading-spinner"></div>
                <span class="ml-3 text-gray-600">Loading chart data...</span>
            </div>
            <div id="chartNoDataMessage" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 text-gray-500 text-lg font-medium hidden">
                No chart data available for selected filters.
            </div>
        </div>
    </div>

    {# Detailed Table for ALL Triplets with Filtering, Sorting, and Pagination #}
    <div class="card p-6 bg-white rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">All Historical Triplets</h2>
        <p class="text-gray-700 mb-4">A complete list of all unique white ball triplets found in historical draws, with filtering and sorting options.</p>
        
        {# Filter & Sort Controls #}
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 items-end">
            <div>
                <label for="filterWhiteBall" class="block text-sm font-medium text-gray-700 mb-1">Filter by White Ball (1-69)</label>
                <input type="number" id="filterWhiteBall" min="1" max="69" placeholder="e.g., 21" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
                <label for="sortBy" class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                <select id="sortBy" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="most_frequent">Most Frequent</option>
                    <option value="least_frequent">Least Frequent</option>
                    <option value="newest">Newest (Last Drawn)</option>
                    <option value="oldest">Oldest (First Drawn)</option>
                </select>
            </div>
            <div class="sm:col-span-1">
                <button id="applyFiltersBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition ease-in-out duration-150">
                    Apply Filters & Sort
                </button>
            </div>
        </div>

        <div id="tableLoadingIndicator" class="flex justify-center items-center py-4 hidden">
            <div class="loading-spinner"></div>
            <span class="ml-3 text-gray-600">Loading triplets data...</span>
        </div>
        <div id="errorMessage" class="hidden p-4 rounded-lg shadow-md text-sm bg-red-100 text-red-700 border border-red-200 animate-fade-in mb-4"></div>

        <div class="mb-4 text-gray-700">
            Total Unique Triplets: <span class="font-bold" id="total-triplets-count">0</span>
        </div>

        <div class="overflow-x-auto shadow-md rounded-lg">
            <table class="min-w-full divide-y divide-gray-200" id="tripletsTable">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Triplet</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frequency</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">First Drawn</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Drawn</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="triplets-table-body">
                    {# Data will be rendered here by JavaScript #}
                </tbody>
            </table>
        </div>

        {# Pagination Controls #}
        <div class="flex justify-between items-center mt-6">
            <button id="prev-page-btn" class="w-24 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow-sm transition ease-in-out duration-150" disabled>Previous</button>
            <span class="text-gray-700">Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
            <button id="next-page-btn" class="w-24 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition ease-in-out duration-150">Next</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterWhiteBallInput = document.getElementById('filterWhiteBall');
        const sortBySelect = document.getElementById('sortBy');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const tableLoadingIndicator = document.getElementById('tableLoadingIndicator');
        const chartLoadingIndicator = document.getElementById('chartLoadingIndicator');
        const errorMessageDiv = document.getElementById('errorMessage');
        const totalTripletsCountSpan = document.getElementById('total-triplets-count');
        const tripletsTableBody = document.getElementById('triplets-table-body');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const currentPageSpan = document.getElementById('current-page');
        const totalPagesSpan = document.getElementById('total-pages');
        const chartNoDataMessage = document.getElementById('chartNoDataMessage');

        let allTripletsData = []; // This will hold the fetched data
        let tripletChart; // To hold the Chart.js instance
        const itemsPerPage = 50; 
        let currentPage = 1;

        async function fetchAndRenderTriplets() {
            tableLoadingIndicator.classList.remove('hidden');
            chartLoadingIndicator.classList.remove('hidden');
            errorMessageDiv.classList.add('hidden');
            chartNoDataMessage.classList.add('hidden');

            // Clear existing chart and table
            if (tripletChart) {
                tripletChart.destroy();
                tripletChart = null;
            }
            tripletsTableBody.innerHTML = '';
            totalTripletsCountSpan.textContent = '0';
            currentPageSpan.textContent = '1';
            totalPagesSpan.textContent = '1';
            prevPageBtn.disabled = true;
            nextPageBtn.disabled = true;


            const filterNumber = filterWhiteBallInput.value;
            const sortBy = sortBySelect.value;

            let apiUrl = `/api/triplets_detailed_analysis?sort_by=${sortBy}`;
            if (filterNumber && filterNumber.trim() !== '') {
                const num = parseInt(filterNumber);
                if (isNaN(num) || num < 1 || num > 69) {
                    errorMessageDiv.textContent = "Please enter a valid white ball number between 1 and 69 for filtering.";
                    errorMessageDiv.classList.remove('hidden');
                    tableLoadingIndicator.classList.add('hidden');
                    chartLoadingIndicator.classList.add('hidden');
                    chartNoDataMessage.classList.remove('hidden');
                    return;
                }
                apiUrl += `&filter_number=${num}`;
            }

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (!response.ok || !data.success) {
                    errorMessageDiv.textContent = data.error || "Failed to fetch triplet data.";
                    errorMessageDiv.classList.remove('hidden');
                    chartNoDataMessage.classList.remove('hidden');
                    return;
                }

                allTripletsData = data.triplets_data;
                currentPage = 1; // Reset to first page on new fetch

                renderTripletsTable();
                renderTripletsChart();

            } catch (error) {
                console.error('Error fetching/rendering triplets data:', error);
                errorMessageDiv.textContent = `An error occurred: ${error.message}.`;
                errorMessageDiv.classList.remove('hidden');
                chartNoDataMessage.classList.remove('hidden');
            } finally {
                tableLoadingIndicator.classList.add('hidden');
                chartLoadingIndicator.classList.add('hidden');
            }
        }

        function renderTripletsTable() {
            tripletsTableBody.innerHTML = ''; // Clear existing rows

            if (!allTripletsData || allTripletsData.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `<td colspan="4" class="px-6 py-4 text-center text-gray-600">No triplet data available for the selected filters.</td>`;
                tripletsTableBody.appendChild(noDataRow);
                totalTripletsCountSpan.textContent = '0';
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;
                currentPageSpan.textContent = '1';
                totalPagesSpan.textContent = '1';
                return;
            }

            totalTripletsCountSpan.textContent = allTripletsData.length;
            const totalPages = Math.ceil(allTripletsData.length / itemsPerPage);
            currentPageSpan.textContent = currentPage;
            totalPagesSpan.textContent = totalPages;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const tripletsForPage = allTripletsData.slice(startIndex, endIndex);

            tripletsForPage.forEach(triplet_info => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                const tripletBallsHtml = `
                    <span class="inline-flex items-center justify-center bg-blue-200 text-blue-800 text-sm font-semibold px-2.5 py-0.5 rounded-full mr-1">
                        ${triplet_info['triplet'][0]}
                    </span>
                    <span class="inline-flex items-center justify-center bg-blue-200 text-blue-800 text-sm font-semibold px-2.5 py-0.5 rounded-full mr-1">
                        ${triplet_info['triplet'][1]}
                    </span>
                    <span class="inline-flex items-center justify-center bg-blue-200 text-blue-800 text-sm font-semibold px-2.5 py-0.5 rounded-full">
                        ${triplet_info['triplet'][2]}
                    </span>
                `;
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <div class="flex space-x-1">
                            ${tripletBallsHtml}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${triplet_info['count']}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${triplet_info['first_drawn_date']}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${triplet_info['last_drawn_date']}</td>
                `;
                tripletsTableBody.appendChild(row);
            });

            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        }

        function renderTripletsChart() {
            if (tripletChart) {
                tripletChart.destroy();
            }

            if (!allTripletsData || allTripletsData.length === 0) {
                chartNoDataMessage.classList.remove('hidden');
                return;
            }

            // Determine how many top triplets to show in the chart
            const topN = Math.min(allTripletsData.length, 30); // Show top 30, or fewer if less than 30 unique triplets
            const chartData = allTripletsData.slice(0, topN);

            const labels = chartData.map(d => d.triplet.join(', '));
            const data = chartData.map(d => d.count);

            const ctx = document.getElementById('tripletFrequencyChart');
            if (ctx) {
                tripletChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Frequency',
                            data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)', // Tailwind blue-500
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: function(context) {
                                        return 'Triplet: ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return 'Frequency: ' + context.parsed.y;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Occurrences'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Triplet Combination'
                                },
                                ticks: {
                                    autoSkip: false,
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Event Listeners for Pagination Buttons
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTripletsTable();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(allTripletsData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTripletsTable();
            }
        });

        // Event listener for apply filters button
        applyFiltersBtn.addEventListener('click', fetchAndRenderTriplets);

        // Initial fetch and render when the page loads
        fetchAndRenderTriplets();
    });
</script>
{% endblock %}
